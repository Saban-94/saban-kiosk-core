<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sika Admin - Stable Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f8fafc; height: 100vh; display: flex; overflow: hidden; }
        .sidebar { width: 260px; background: white; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; z-index: 20; }
        .main { flex: 1; padding: 32px; overflow: hidden; display: flex; flex-direction: column; }
        .nav-item { padding: 12px 20px; cursor: pointer; color: #64748b; font-weight: 500; border-right: 3px solid transparent; display: flex; gap: 10px; }
        .nav-item.active { background: #eff6ff; color: #2563eb; border-right-color: #2563eb; }
        .view { display: none; height: 100%; flex-direction: column; }
        .view.active { display: flex; }
        .btn { padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 14px; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-ai { background: linear-gradient(135deg, #6366f1, #a855f7); color: white; }
        .input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; }
        /* Gallery */
        .grid-gal { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .gal-item { position: relative; aspect-ratio: 16/9; background: #eee; border-radius: 6px; overflow: hidden; }
        .gal-item img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="p-6 border-b"><h1 class="text-xl font-black">SIKA ADMIN</h1></div>
        <nav class="flex-1 py-4">
            <div class="nav-item active" onclick="app.view('products')"><i data-lucide="package"></i> מוצרים</div>
            <div class="nav-item" onclick="app.view('tutorials')"><i data-lucide="film"></i> אקדמיה</div>
        </nav>
        <div class="p-4"><button onclick="app.seed()" class="btn w-full justify-center bg-gray-100 text-gray-600">איפוס נתונים</button></div>
    </div>

    <div class="main">
        <div id="v-products" class="view active">
            <div class="flex justify-between mb-4">
                <h2 class="text-2xl font-bold">ניהול מוצרים</h2>
                <button onclick="app.newProd()" class="btn btn-primary"><i data-lucide="plus"></i> חדש</button>
            </div>
            <div class="flex gap-6 h-full overflow-hidden">
                <div class="w-1/3 bg-white rounded-xl border flex flex-col">
                    <div class="p-3 border-b"><input id="search" oninput="app.filter()" class="input" placeholder="חיפוש..."></div>
                    <div id="list" class="flex-1 overflow-y-auto"></div>
                </div>
                <div class="flex-1 bg-white rounded-xl border flex flex-col relative overflow-hidden">
                    <div class="p-4 border-b flex justify-between bg-gray-50">
                        <span class="font-bold text-gray-400" id="pid">New</span>
                        <div class="flex gap-2">
                            <button onclick="app.del()" class="btn bg-red-100 text-red-600"><i data-lucide="trash-2"></i></button>
                            <button onclick="app.save()" class="btn btn-primary"><i data-lucide="save"></i> שמור</button>
                        </div>
                    </div>
                    <div class="p-6 overflow-y-auto flex-1 space-y-4">
                        <input type="hidden" id="eid">
                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex gap-2 items-end">
                            <div class="flex-1">
                                <label class="text-xs font-bold text-indigo-900">AI Auto-Fill</label>
                                <input id="aiQuery" class="input border-indigo-200" placeholder="הקלד שם מוצר...">
                            </div>
                            <button onclick="app.ai()" class="btn btn-ai h-[42px]"><i data-lucide="sparkles"></i> מלא</button>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold">שם מוצר</label><input id="pName" class="input"></div>
                            <div><label class="text-xs font-bold">מותג</label><select id="pBrand" class="input"><option>SIKA</option><option>THERMOKIR</option><option>MISTER FIX</option><option>BG BOND</option><option>NIRLAT</option><option>TAMBOUR</option></select></div>
                        </div>
                        <div><label class="text-xs font-bold">קטגוריה</label><select id="pCat" class="input"><option value="sealing">איטום</option><option value="glues">דבקים</option><option value="concrete">בטון</option><option value="flooring">ריצוף</option></select></div>
                        <div><label class="text-xs font-bold">תיאור</label><textarea id="pDesc" class="input h-24"></textarea></div>
                        
                        <div class="grid grid-cols-3 gap-4 bg-gray-50 p-3 rounded-lg border">
                            <div><label class="text-xs">כיסוי</label><input id="tCov" class="input bg-white"></div>
                            <div><label class="text-xs">ייבוש</label><input id="tDry" class="input bg-white"></div>
                            <div><label class="text-xs">עובי</label><input id="tThick" class="input bg-white"></div>
                        </div>

                        <div>
                            <label class="text-xs font-bold">תמונות (URL)</label>
                            <div class="flex gap-2 mb-2"><input id="imgUrl" class="input" placeholder="http..."><button onclick="app.addImg()" class="btn bg-gray-200">הוסף</button></div>
                            <div id="gal" class="grid-gal"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="v-tutorials" class="view">
            <h2 class="text-2xl font-bold mb-4">ניהול אקדמיה</h2>
            <div id="vidList" class="grid grid-cols-4 gap-4"></div>
        </div>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { askGeminiAdmin, extractTechnicalSpecs } from '../js/gemini-service.js';
        
        lucide.createIcons();

        const app = {
            imgs: [], prods: [],
            
            init: () => {
                app.load();
                app.loadVids();
            },

            view: (v) => {
                document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                document.getElementById('v-'+v).classList.add('active');
                event.currentTarget.classList.add('active');
            },

            load: () => {
                onSnapshot(collection(db, "products"), snap => {
                    const l = document.getElementById('list'); l.innerHTML = ""; app.prods = [];
                    snap.forEach(d => {
                        const p = {id:d.id, ...d.data()}; app.prods.push(p);
                        l.innerHTML += `<div onclick="app.edit('${p.id}')" class="p-3 border-b hover:bg-gray-50 cursor-pointer font-medium text-sm flex gap-3 items-center"><div class="w-8 h-8 bg-gray-200 rounded"></div>${p.name}</div>`;
                    });
                });
            },

            edit: (id) => {
                const p = app.prods.find(x => x.id === id);
                document.getElementById('eid').value = id;
                document.getElementById('pid').innerText = id.slice(0,5);
                document.getElementById('pName').value = p.name;
                document.getElementById('pBrand').value = p.brand;
                document.getElementById('pCat').value = p.category;
                document.getElementById('pDesc').value = p.marketingDesc;
                document.getElementById('tCov').value = p.tech?.coverage||'';
                document.getElementById('tDry').value = p.tech?.drying||'';
                document.getElementById('tThick').value = p.tech?.thickness||'';
                app.imgs = p.images || [];
                app.renderGal();
            },

            newProd: () => {
                document.getElementById('eid').value = "";
                document.querySelectorAll('input,textarea').forEach(e => e.value="");
                app.imgs = []; app.renderGal();
            },

            save: async () => {
                const id = document.getElementById('eid').value;
                const d = {
                    name: document.getElementById('pName').value,
                    brand: document.getElementById('pBrand').value,
                    category: document.getElementById('pCat').value,
                    marketingDesc: document.getElementById('pDesc').value,
                    images: app.imgs, image: app.imgs[0]||'',
                    tech: { coverage: document.getElementById('tCov').value, drying: document.getElementById('tDry').value, thickness: document.getElementById('tThick').value }
                };
                if(id) await updateDoc(doc(db, "products", id), d);
                else await addDoc(collection(db, "products"), d);
                alert("נשמר!");
            },

            del: async () => {
                const id = document.getElementById('eid').value;
                if(id && confirm("למחוק?")) { await deleteDoc(doc(db, "products", id)); app.newProd(); }
            },

            // Gallery
            addImg: () => {
                const u = document.getElementById('imgUrl').value;
                if(u) { app.imgs.push(u); app.renderGal(); document.getElementById('imgUrl').value=""; }
            },
            renderGal: () => {
                document.getElementById('gal').innerHTML = app.imgs.map(u => `<div class="gal-item"><img src="${u}"></div>`).join('');
            },

            // AI Logic (Offline Fallback Included via service)
            ai: async () => {
                const q = document.getElementById('aiQuery').value;
                if(!q) return;
                const btn = document.querySelector('.btn-ai'); btn.innerHTML = "⏳...";
                
                const data = await askGeminiAdmin(q); // Uses service
                if(data) {
                    document.getElementById('pName').value = data.name;
                    document.getElementById('pBrand').value = data.brand;
                    document.getElementById('pDesc').value = data.marketingDesc;
                    document.getElementById('pCat').value = data.category;
                    if(data.tech) {
                        document.getElementById('tCov').value = data.tech.coverage;
                        document.getElementById('tDry').value = data.tech.drying;
                        document.getElementById('tThick').value = data.tech.thickness;
                    }
                }
                btn.innerHTML = `<i data-lucide="sparkles"></i> מלא`;
                lucide.createIcons();
            },

            // Seed / Tutorials stub
            loadVids: () => {
                // Mock Videos
                const vids = document.getElementById('vidList');
                vids.innerHTML = [1,2,3].map(i => `<div class="bg-gray-100 h-32 rounded-lg flex items-center justify-center">וידאו ${i}</div>`).join('');
            },
            seed: async () => {
                if(!confirm("לאפס הכל?")) return;
                const b = writeBatch(db);
                // Simple stable seed
                const prods = [
                    {name: "Sika 107", brand: "SIKA", category: "sealing", marketingDesc: "איטום מעולה.", image: "https://placehold.co/400?text=Sika", tech:{coverage:"3kg",drying:"6h",thickness:"2mm"}},
                    {name: "Mister Fix 109", brand: "MISTER FIX", category: "glues", marketingDesc: "דבק חזק.", image: "https://placehold.co/400?text=Fix", tech:{coverage:"5kg",drying:"24h",thickness:"5mm"}}
                ];
                const snap = await getDocs(collection(db, "products"));
                snap.forEach(d => b.delete(d.ref));
                prods.forEach(p => b.set(doc(collection(db, "products")), p));
                await b.commit();
                alert("בוצע!");
            }
        };

        window.app = app;
        app.init();
    </script>
</body>
</html>
