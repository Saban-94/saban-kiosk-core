<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sika Admin Suite</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f1f5f9; color: #0f172a; height: 100vh; display: flex; overflow: hidden; }
        
        /* Layout */
        .sidebar { width: 280px; background: white; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; z-index: 20; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 24px; gap: 24px; }
        
        /* Navigation */
        .nav-item { display: flex; items-center; gap: 12px; padding: 14px 24px; color: #64748b; font-weight: 500; cursor: pointer; transition: all 0.2s; border-right: 3px solid transparent; }
        .nav-item:hover { background: #f8fafc; color: #0f172a; }
        .nav-item.active { background: #eff6ff; color: #2563eb; border-right-color: #2563eb; }
        
        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; border-radius: 10px; font-weight: 600; transition: all 0.2s; cursor: pointer; font-size: 14px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: #2563eb; color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2); }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-danger { background: white; border: 1px solid #fee2e2; color: #dc2626; }
        .btn-danger:hover { background: #fee2e2; }
        .btn-ai { background: linear-gradient(135deg, #6366f1, #a855f7); color: white; border: none; }
        .btn-ai:hover { opacity: 0.9; shadow: 0 4px 12px rgba(168, 85, 247, 0.3); }

        /* Forms */
        .input-group label { display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 6px; }
        .input-std { width: 100%; border: 1px solid #cbd5e1; padding: 12px; border-radius: 10px; outline: none; transition: 0.2s; background: #fff; font-size: 14px; }
        .input-std:focus { border-color: #2563eb; ring: 2px solid #bfdbfe; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
        
        /* Panels */
        .view-panel { display: none; height: 100%; flex-direction: column; }
        .view-panel.active { display: flex; }
        
        /* Product Card in List */
        .prod-item { display: flex; items-center; gap: 12px; padding: 12px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s; }
        .prod-item:hover { background: #f8fafc; }
        .prod-item.selected { background: #eff6ff; border-right: 3px solid #2563eb; }
        .prod-img { width: 48px; height: 48px; border-radius: 8px; object-fit: contain; background: white; border: 1px solid #e2e8f0; padding: 2px; }

        /* Tabs inside Editor */
        .tab-header { display: flex; border-bottom: 1px solid #e2e8f0; margin-bottom: 20px; }
        .tab-link { padding: 12px 24px; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 2px solid transparent; transition: 0.2s; }
        .tab-link:hover { color: #2563eb; }
        .tab-link.active { color: #2563eb; border-bottom-color: #2563eb; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Toast Notification */
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px; shadow: 0 10px 30px rgba(0,0,0,0.2); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0; z-index: 100; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="w-10 h-10 bg-[#E3000F] rounded-lg flex items-center justify-center text-white font-black italic shadow-lg shadow-red-200">S</div>
            <div>
                <h1 class="text-xl font-black text-gray-900 leading-none">Sika Admin</h1>
                <p class="text-xs text-gray-400 font-medium">מערכת ניהול 2.0</p>
            </div>
        </div>
        
        <nav class="flex-1 py-6 space-y-1">
            <div class="nav-item active" onclick="app.switchView('products')">
                <i data-lucide="package"></i> ניהול קטלוג
            </div>
            <div class="nav-item" onclick="app.switchView('brands')">
                <i data-lucide="tag"></i> מותגים
            </div>
            <div class="nav-item" onclick="app.switchView('tutorials')">
                <i data-lucide="play-circle"></i> הדרכות וידאו
            </div>
        </nav>

        <div class="p-4 border-t border-gray-100 bg-gray-50">
            <button onclick="app.runSeed()" class="btn w-full bg-white border border-gray-300 hover:bg-gray-100 text-gray-600 text-xs">
                <i data-lucide="database" size="14"></i> טען נתוני אמת (Reset)
            </button>
            <div class="text-center mt-2 text-[10px] text-gray-400">גירסה 2.4.0 • מחובר</div>
        </div>
    </div>

    <div class="main-content">

        <div id="view-products" class="view-panel active h-full">
            <header class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">קטלוג מוצרים</h2>
                    <p class="text-sm text-gray-500">ניהול מלאי, עריכת תכנים ו-AI</p>
                </div>
                <button onclick="app.createNewProduct()" class="btn btn-primary shadow-blue-200 shadow-lg">
                    <i data-lucide="plus"></i> מוצר חדש
                </button>
            </header>

            <div class="flex gap-6 h-full overflow-hidden">
                
                <div class="w-1/3 bg-white rounded-2xl border border-gray-200 shadow-sm flex flex-col overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50/50">
                        <div class="relative">
                            <i data-lucide="search" class="absolute right-3 top-3 text-gray-400 w-4 h-4"></i>
                            <input id="prodSearch" oninput="app.filterProducts()" class="input-std pl-4 pr-10" placeholder="חיפוש מהיר...">
                        </div>
                    </div>
                    <div id="productsList" class="flex-1 overflow-y-auto">
                        <div class="p-10 text-center text-gray-400 flex flex-col items-center">
                            <i data-lucide="loader-2" class="animate-spin mb-2"></i> טוען...
                        </div>
                    </div>
                </div>

                <div class="flex-1 bg-white rounded-2xl border border-gray-200 shadow-sm flex flex-col overflow-hidden relative">
                    
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
                        <div class="flex items-center gap-2">
                            <span class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold" id="productIdBadge">ID: New</span>
                            <h3 class="font-bold text-lg" id="editorTitle">מוצר חדש</h3>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="app.deleteCurrentProduct()" class="btn btn-danger py-2 px-3 text-xs"><i data-lucide="trash-2" size="14"></i></button>
                            <button onclick="app.saveCurrentProduct()" class="btn btn-primary py-2 px-6"><i data-lucide="save" size="16"></i> שמור</button>
                        </div>
                    </div>

                    <div class="p-8 overflow-y-auto flex-1">
                        <input type="hidden" id="editProdId">

                        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-100 rounded-xl p-5 mb-8 flex items-end gap-4 relative overflow-hidden group">
                            <div class="absolute -right-10 -top-10 w-32 h-32 bg-purple-200 rounded-full mix-blend-multiply filter blur-2xl opacity-30 group-hover:opacity-50 transition"></div>
                            <div class="flex-1 relative z-10">
                                <label class="text-xs font-bold text-indigo-900 mb-1 flex items-center gap-1"><i data-lucide="sparkles" size="12"></i> מחולל תוכן אוטומטי</label>
                                <input id="aiPrompt" class="input-std border-indigo-200 focus:border-indigo-500" placeholder="הקלד שם מוצר (למשל Sika 107) וה-AI ימלא את הכל...">
                            </div>
                            <button onclick="app.runFullAI()" class="btn btn-ai shadow-lg relative z-10 whitespace-nowrap h-[46px]">
                                <i data-lucide="wand-2" size="16"></i> הפעל קסם
                            </button>
                        </div>

                        <div class="tab-header">
                            <div class="tab-link active" onclick="app.switchTab('general', this)">פרטים כלליים</div>
                            <div class="tab-link" onclick="app.switchTab('media', this)">מדיה ותמונות</div>
                            <div class="tab-link" onclick="app.switchTab('tech', this)">מפרט טכני</div>
                        </div>

                        <div id="tab-general" class="tab-content active space-y-5">
                            <div class="grid grid-cols-2 gap-5">
                                <div class="input-group">
                                    <label>שם המוצר</label>
                                    <input id="pName" class="input-std font-bold text-lg">
                                </div>
                                <div class="input-group">
                                    <label>מותג</label>
                                    <select id="pBrandSelect" class="input-std">
                                        <option value="">בחר מותג...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="input-group">
                                <label>קטגוריה</label>
                                <select id="pCat" class="input-std">
                                    <option value="sealing">איטום (Sealing)</option>
                                    <option value="glues">דבקים (Glues)</option>
                                    <option value="concrete">בטון (Concrete)</option>
                                    <option value="flooring">ריצוף (Flooring)</option>
                                    <option value="paint">צבע (Paint)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>תיאור שיווקי</label>
                                <textarea id="pDesc" class="input-std h-32 leading-relaxed"></textarea>
                            </div>
                        </div>

                        <div id="tab-media" class="tab-content space-y-5">
                            <div class="grid grid-cols-2 gap-6">
                                <div class="input-group">
                                    <label>כתובת תמונה (URL)</label>
                                    <input id="pImg" class="input-std" placeholder="https://...">
                                    <div class="mt-2 h-40 bg-gray-50 rounded-lg border border-dashed border-gray-300 flex items-center justify-center overflow-hidden">
                                        <img id="previewImg" src="" class="h-full object-contain" onerror="this.style.display='none'">
                                        <span class="text-gray-400 text-xs" id="imgPlaceholder">תצוגה מקדימה</span>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label>קישור לסרטון (YouTube)</label>
                                    <input id="pVideo" class="input-std" placeholder="https://youtube.com/...">
                                    <div class="mt-2 h-40 bg-gray-50 rounded-lg border border-dashed border-gray-300 flex items-center justify-center">
                                        <i data-lucide="video" class="text-gray-300" size="32"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="tab-tech" class="tab-content">
                            <div class="grid grid-cols-3 gap-5">
                                <div class="input-group">
                                    <label>כיסוי / צריכה</label>
                                    <input id="tCov" class="input-std" placeholder="למשל: 1.5 ק''ג למ''ר">
                                </div>
                                <div class="input-group">
                                    <label>זמן ייבוש</label>
                                    <input id="tDry" class="input-std" placeholder="למשל: 24 שעות">
                                </div>
                                <div class="input-group">
                                    <label>עובי יישום</label>
                                    <input id="tThick" class="input-std" placeholder="למשל: 2-5 מ''מ">
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div id="view-brands" class="view-panel h-full">
            <h2 class="text-2xl font-bold mb-6">ניהול מותגים</h2>
            <div class="flex gap-6 items-start h-full">
                <div class="w-1/3 bg-white p-6 rounded-2xl border border-gray-200 shadow-sm">
                    <h3 class="font-bold mb-4">הוספת מותג חדש</h3>
                    <div class="input-group mb-4">
                        <label>שם המותג</label>
                        <input id="newBrandName" class="input-std" placeholder="למשל: Sika Floor">
                    </div>
                    <button onclick="app.addBrand()" class="btn btn-primary w-full">הוסף למערכת</button>
                </div>
                
                <div class="flex-1 overflow-y-auto">
                    <div class="grid grid-cols-3 gap-4" id="brandsGrid">
                        </div>
                </div>
            </div>
        </div>

        <div id="view-tutorials" class="view-panel h-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">הדרכות וידאו</h2>
                <button onclick="document.getElementById('addTutorialModal').classList.remove('hidden')" class="btn btn-primary shadow-lg">
                    <i data-lucide="film"></i> הוסף סרטון
                </button>
            </div>
            <div id="tutorialsGrid" class="grid grid-cols-3 gap-6 overflow-y-auto pb-10">
                </div>
        </div>

    </div>

    <div id="addTutorialModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl p-8 w-[450px] shadow-2xl animate-[fadeIn_0.2s]">
            <h3 class="font-bold text-xl mb-6">הוספת סרטון הדרכה</h3>
            <div class="space-y-4 mb-6">
                <div class="input-group">
                    <label>כותרת הסרטון</label>
                    <input id="tutTitle" class="input-std" placeholder="תיאור קצר...">
                </div>
                <div class="input-group">
                    <label>קישור (YouTube)</label>
                    <input id="tutUrl" class="input-std" placeholder="https://...">
                </div>
            </div>
            <div class="flex gap-3 justify-end">
                <button onclick="document.getElementById('addTutorialModal').classList.add('hidden')" class="btn btn-danger border-gray-200 text-gray-600">ביטול</button>
                <button onclick="app.saveTutorial()" class="btn btn-primary">שמור ופרסם</button>
            </div>
        </div>
    </div>

    <div id="toast"><i data-lucide="check-circle" class="text-green-400"></i> <span id="toastMsg">נשמר בהצלחה</span></div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { askGeminiAdmin, extractTechnicalSpecs } from '../js/gemini-service.js';

        lucide.createIcons();

        // Application State
        const app = {
            currentView: 'products',
            currentProduct: null,
            allProducts: [],

            // Navigation
            switchView: (viewName) => {
                document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                
                document.getElementById(`view-${viewName}`).classList.add('active');
                // Highlight Nav
                const navIndex = viewName === 'products' ? 0 : viewName === 'brands' ? 1 : 2;
                document.querySelectorAll('.nav-item')[navIndex].classList.add('active');
            },

            switchTab: (tabName, btn) => {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-${tabName}`).classList.add('active');
                btn.classList.add('active');
            },

            // --- PRODUCTS LOGIC ---
            loadProducts: () => {
                const list = document.getElementById('productsList');
                onSnapshot(collection(db, "products"), (snap) => {
                    app.allProducts = [];
                    list.innerHTML = "";
                    snap.forEach(docSnap => {
                        const p = {id: docSnap.id, ...docSnap.data()};
                        app.allProducts.push(p);
                        
                        const div = document.createElement('div');
                        div.className = "prod-item";
                        div.onclick = () => app.editProduct(p.id);
                        div.innerHTML = `
                            <img src="${p.image || 'https://placehold.co/50'}" class="prod-img">
                            <div class="overflow-hidden">
                                <div class="font-bold text-sm text-gray-800 truncate">${p.name}</div>
                                <div class="text-xs text-gray-500 truncate">${p.brand || '-'}</div>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                });
            },

            editProduct: (id) => {
                const p = app.allProducts.find(x => x.id === id);
                if(!p) return;
                
                document.getElementById('editProdId').value = id;
                document.getElementById('productIdBadge').innerText = `ID: ${id.slice(0,6)}...`;
                document.getElementById('editorTitle').innerText = p.name;
                
                document.getElementById('pName').value = p.name;
                document.getElementById('pBrandSelect').value = p.brand || '';
                document.getElementById('pCat').value = p.category || 'sealing';
                document.getElementById('pDesc').value = p.marketingDesc || '';
                
                // Media
                document.getElementById('pImg').value = p.image || '';
                document.getElementById('pVideo').value = p.videoUrl || '';
                const prevImg = document.getElementById('previewImg');
                if(p.image) {
                    prevImg.src = p.image;
                    prevImg.style.display = 'block';
                    document.getElementById('imgPlaceholder').style.display = 'none';
                } else {
                    prevImg.style.display = 'none';
                    document.getElementById('imgPlaceholder').style.display = 'block';
                }

                // Tech
                document.getElementById('tCov').value = p.tech?.coverage || '';
                document.getElementById('tDry').value = p.tech?.drying || '';
                document.getElementById('tThick').value = p.tech?.thickness || '';

                // Highlights
                document.querySelectorAll('.prod-item').forEach(el => el.classList.remove('selected'));
                // (Optional: add visual selection logic)
            },

            createNewProduct: () => {
                document.getElementById('editProdId').value = "";
                document.getElementById('productIdBadge').innerText = "ID: New";
                document.getElementById('editorTitle').innerText = "מוצר חדש";
                document.querySelectorAll('input, textarea, select').forEach(el => el.value = "");
                document.getElementById('previewImg').style.display = 'none';
                document.getElementById('imgPlaceholder').style.display = 'block';
            },

            saveCurrentProduct: async () => {
                const id = document.getElementById('editProdId').value;
                const data = {
                    name: document.getElementById('pName').value,
                    brand: document.getElementById('pBrandSelect').value,
                    category: document.getElementById('pCat').value,
                    marketingDesc: document.getElementById('pDesc').value,
                    image: document.getElementById('pImg').value,
                    videoUrl: document.getElementById('pVideo').value,
                    tech: {
                        coverage: document.getElementById('tCov').value,
                        drying: document.getElementById('tDry').value,
                        thickness: document.getElementById('tThick').value
                    },
                    updatedAt: Date.now()
                };

                if(!data.name) return alert("חובה להזין שם מוצר");

                try {
                    if(id) await updateDoc(doc(db, "products", id), data);
                    else {
                        data.createdAt = Date.now();
                        await addDoc(collection(db, "products"), data);
                        app.createNewProduct();
                    }
                    app.showToast("המוצר נשמר בהצלחה");
                } catch(e) { console.error(e); alert("שגיאה בשמירה"); }
            },

            deleteCurrentProduct: async () => {
                const id = document.getElementById('editProdId').value;
                if(!id) return;
                if(confirm("למחוק את המוצר לצמיתות?")) {
                    await deleteDoc(doc(db, "products", id));
                    app.createNewProduct();
                    app.showToast("המוצר נמחק");
                }
            },

            filterProducts: () => {
                const term = document.getElementById('prodSearch').value.toLowerCase();
                const items = document.getElementById('productsList').children;
                Array.from(items).forEach(item => {
                    const text = item.innerText.toLowerCase();
                    item.style.display = text.includes(term) ? 'flex' : 'none';
                });
            },

            // --- AI MAGIC ---
            runFullAI: async () => {
                const query = document.getElementById('aiPrompt').value || document.getElementById('pName').value;
                if(!query) return alert("הזן שם מוצר לחיפוש");

                const btn = document.querySelector('.btn-ai');
                const orig = btn.innerHTML;
                btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin"></i> עובד...`;
                lucide.createIcons();

                try {
                    // 1. Marketing
                    const mData = await askGeminiAdmin(query);
                    if(mData) {
                        document.getElementById('pName').value = mData.name;
                        document.getElementById('pDesc').value = mData.marketingDesc;
                        // Try to match brand
                        const brandSelect = document.getElementById('pBrandSelect');
                        for(let i=0; i<brandSelect.options.length; i++) {
                            if(brandSelect.options[i].text.toUpperCase().includes(mData.brand.toUpperCase())) {
                                brandSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }

                    // 2. Technical
                    const tData = await extractTechnicalSpecs(query);
                    document.getElementById('tCov').value = tData.coverage;
                    document.getElementById('tDry').value = tData.drying;
                    document.getElementById('tThick').value = tData.thickness;

                    app.showToast("הנתונים מולאו בהצלחה ע\"י ה-AI");

                } catch(e) { console.error(e); alert("שגיאה ב-AI"); }
                finally { 
                    btn.innerHTML = orig;
                    lucide.createIcons();
                }
            },

            // --- BRANDS LOGIC ---
            loadBrands: () => {
                onSnapshot(collection(db, "brands"), (snap) => {
                    const grid = document.getElementById('brandsGrid');
                    const select = document.getElementById('pBrandSelect');
                    grid.innerHTML = "";
                    
                    // Keep first option
                    select.innerHTML = '<option value="">בחר מותג...</option>';
                    
                    snap.forEach(docSnap => {
                        const b = {id: docSnap.id, ...docSnap.data()};
                        // Add to Grid
                        grid.innerHTML += `
                            <div class="bg-white p-4 rounded-xl border border-gray-200 flex justify-between items-center shadow-sm">
                                <span class="font-bold text-gray-700">${b.name}</span>
                                <button onclick="app.deleteBrand('${b.id}')" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" size="16"></i></button>
                            </div>
                        `;
                        // Add to Select
                        const opt = document.createElement('option');
                        opt.value = b.name;
                        opt.innerText = b.name;
                        select.appendChild(opt);
                    });
                    lucide.createIcons();
                });
            },

            addBrand: async () => {
                const name = document.getElementById('newBrandName').value;
                if(!name) return;
                await addDoc(collection(db, "brands"), { name, createdAt: Date.now() });
                document.getElementById('newBrandName').value = "";
                app.showToast("מותג נוסף");
            },

            deleteBrand: async (id) => {
                if(confirm("למחוק מותג?")) await deleteDoc(doc(db, "brands", id));
            },

            // --- TUTORIALS LOGIC ---
            loadTutorials: () => {
                onSnapshot(collection(db, "tutorials"), (snap) => {
                    const grid = document.getElementById('tutorialsGrid');
                    grid.innerHTML = "";
                    snap.forEach(docSnap => {
                        const t = {id: docSnap.id, ...docSnap.data()};
                        let vidId = "";
                        try { vidId = t.url.split('v=')[1].split('&')[0]; } catch(e){}
                        const thumb = `https://img.youtube.com/vi/${vidId}/mqdefault.jpg`;

                        grid.innerHTML += `
                            <div class="bg-white rounded-xl overflow-hidden border border-gray-200 shadow-sm hover:shadow-md transition">
                                <div class="aspect-video bg-black relative group">
                                    <img src="${thumb}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition">
                                    <div class="absolute inset-0 flex items-center justify-center"><i data-lucide="play-circle" class="text-white w-12 h-12"></i></div>
                                </div>
                                <div class="p-4 flex justify-between items-center">
                                    <h4 class="font-bold text-sm text-gray-800 truncate pr-2">${t.title}</h4>
                                    <button onclick="app.deleteTutorial('${t.id}')" class="text-red-400 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" size="16"></i></button>
                                </div>
                            </div>
                        `;
                    });
                    lucide.createIcons();
                });
            },

            saveTutorial: async () => {
                const title = document.getElementById('tutTitle').value;
                const url = document.getElementById('tutUrl').value;
                if(!title || !url) return;
                await addDoc(collection(db, "tutorials"), { title, url, createdAt: Date.now() });
                document.getElementById('addTutorialModal').classList.add('hidden');
                app.showToast("הדרכה נוספה");
            },

            deleteTutorial: async (id) => {
                if(confirm("למחוק סרטון?")) await deleteDoc(doc(db, "tutorials", id));
            },

            // --- SEED DATA (Reset) ---
            runSeed: async () => {
                if(!confirm("פעולה זו תמחק את כל המוצרים ותטען נתוני אמת. להמשיך?")) return;
                
                const realProducts = [
                    {name: "SikaTop Seal 107", brand: "SIKA", category: "sealing", marketingDesc: "איטום צמנטי גמיש דו-רכיבי.", image: "https://gilar.co.il/wp-content/uploads/2023/12/SikaTop-Seal-107-25-Kg.png", tech: {coverage: "3-4 ק\"ג/מ\"ר", drying: "6 שעות", thickness: "2-3 מ\"מ"}},
                    {name: "Sikaflex 11FC+", brand: "SIKA", category: "glues", marketingDesc: "דבק איטום פוליאוריטני רב תכליתי.", image: "https://gilar.co.il/wp-content/uploads/2020/12/Sikaflex-11-FC.jpg", tech: {coverage: "משתנה", drying: "24 שעות", thickness: "-"}},
                    {name: "תרמוקיר 603", brand: "THERMOKIR", category: "concrete", marketingDesc: "טיח תרמי לבידוד.", image: "https://www.thermokir.co.il/wp-content/uploads/2019/06/603.png", tech: {coverage: "35 ק\"ג/מ\"ר", drying: "48 שעות", thickness: "30 מ\"מ"}},
                    {name: "סופר גמיש 100", brand: "MISTER FIX", category: "glues", marketingDesc: "דבק אקרילי C2TE.", image: "https://karmit-mrfix.com/wp-content/uploads/2020/07/100.png", tech: {coverage: "5 ק\"ג/מ\"ר", drying: "24 שעות", thickness: "5 מ\"מ"}}
                ];

                const batch = writeBatch(db);
                const snap = await getDocs(collection(db, "products"));
                snap.forEach(d => batch.delete(d.ref));
                
                realProducts.forEach(p => {
                    const newRef = doc(collection(db, "products"));
                    batch.set(newRef, {...p, createdAt: Date.now()});
                });
                
                await batch.commit();
                app.showToast("הקטלוג אותחל בהצלחה!");
                location.reload();
            },

            // --- UTILS ---
            showToast: (msg) => {
                const t = document.getElementById('toast');
                document.getElementById('toastMsg').innerText = msg;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            }
        };

        // Make app global
        window.app = app;

        // Init
        app.loadProducts();
        app.loadBrands();
        app.loadTutorials();

    </script>
</body>
</html>
