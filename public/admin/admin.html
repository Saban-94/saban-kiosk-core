<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sika Admin Suite - Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f8fafc; color: #0f172a; height: 100vh; display: flex; overflow: hidden; }
        .sidebar { width: 280px; background: white; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; z-index: 20; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 32px; gap: 32px; }
        .view-panel { display: none; height: 100%; flex-direction: column; }
        .view-panel.active { display: flex; }
        .nav-item { display: flex; items-center; gap: 12px; padding: 16px 24px; color: #64748b; font-weight: 500; cursor: pointer; transition: 0.2s; border-right: 4px solid transparent; }
        .nav-item.active { background: #eff6ff; color: #2563eb; border-right-color: #2563eb; font-weight: 700; }
        .btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #2563eb; color: white; }
        .input-std { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px; outline: none; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="p-8 border-b"><h1 class="text-2xl font-black">SIKA ADMIN</h1></div>
        <nav class="flex-1 py-4">
            <div class="nav-item active" onclick="app.view('products')"><i data-lucide="package"></i> קטלוג</div>
            <div class="nav-item" onclick="app.view('brands')"><i data-lucide="tag"></i> יצרנים</div>
        </nav>
        <div class="p-4"><button onclick="app.runSeed()" class="btn w-full bg-gray-200">איפוס נתונים</button></div>
    </div>

    <div class="main-content">
        <div id="v-products" class="view-panel active">
            <h2 class="text-2xl font-bold mb-4">ניהול מוצרים</h2>
            <div class="flex gap-4 h-full">
                <div class="w-1/3 bg-white p-4 rounded-xl border flex flex-col">
                    <input id="pSearch" oninput="app.filter()" class="input-std mb-2" placeholder="חיפוש...">
                    <div id="pList" class="flex-1 overflow-y-auto space-y-2"></div>
                </div>
                <div class="flex-1 bg-white p-6 rounded-xl border overflow-y-auto">
                    <input type="hidden" id="pid">
                    <div class="flex justify-between mb-4">
                        <span id="pidLabel" class="text-gray-400 font-bold">New</span>
                        <div class="flex gap-2">
                            <button onclick="app.newProd()" class="btn bg-green-100 text-green-700">חדש</button>
                            <button onclick="app.delProd()" class="btn bg-red-100 text-red-700">מחק</button>
                            <button onclick="app.saveProd()" class="btn btn-primary">שמור</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <input id="pName" class="input-std" placeholder="שם מוצר">
                        <input id="pBrand" class="input-std" placeholder="מותג">
                    </div>
                    <textarea id="pDesc" class="input-std h-32 mb-4" placeholder="תיאור..."></textarea>
                    <input id="pImg" class="input-std mb-4" placeholder="תמונה URL">
                    <div class="grid grid-cols-3 gap-4">
                        <input id="tCov" class="input-std" placeholder="כיסוי">
                        <input id="tDry" class="input-std" placeholder="ייבוש">
                        <input id="tThick" class="input-std" placeholder="עובי">
                    </div>
                </div>
            </div>
        </div>

        <div id="v-brands" class="view-panel">
            <h2 class="text-2xl font-bold mb-4">יצרנים במערכת (נשלף בזמן אמת)</h2>
            <div id="bList" class="grid grid-cols-4 gap-4"></div>
        </div>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { seedRealData } from '../js/seed-data.js'; // ייבוא נכון

        lucide.createIcons();

        const app = {
            prods: [],
            
            init: () => {
                app.loadProds();
                app.loadBrands();
            },

            view: (v) => {
                document.querySelectorAll('.view-panel').forEach(e => e.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                document.getElementById('v-'+v).classList.add('active');
                event.currentTarget.classList.add('active');
            },

            // --- Products ---
            loadProds: () => {
                onSnapshot(collection(db, "products"), snap => {
                    const l = document.getElementById('pList'); l.innerHTML = ""; app.prods = [];
                    snap.forEach(d => {
                        const p = {id:d.id, ...d.data()}; app.prods.push(p);
                        l.innerHTML += `<div onclick="app.edit('${p.id}')" class="p-3 border rounded hover:bg-gray-50 cursor-pointer text-sm font-bold flex items-center gap-2"><img src="${p.image}" class="w-6 h-6 object-contain">${p.name}</div>`;
                    });
                });
            },
            edit: (id) => {
                const p = app.prods.find(x => x.id === id);
                document.getElementById('pid').value = id;
                document.getElementById('pidLabel').innerText = id;
                document.getElementById('pName').value = p.name;
                document.getElementById('pBrand').value = p.brand;
                document.getElementById('pDesc').value = p.marketingDesc;
                document.getElementById('pImg').value = p.image;
                document.getElementById('tCov').value = p.tech?.coverage||'';
                document.getElementById('tDry').value = p.tech?.drying||'';
                document.getElementById('tThick').value = p.tech?.thickness||'';
            },
            newProd: () => {
                document.getElementById('pid').value = "";
                document.querySelectorAll('input, textarea').forEach(i => i.value="");
            },
            saveProd: async () => {
                const id = document.getElementById('pid').value;
                const d = {
                    name: document.getElementById('pName').value,
                    brand: document.getElementById('pBrand').value,
                    marketingDesc: document.getElementById('pDesc').value,
                    image: document.getElementById('pImg').value || "https://placehold.co/400",
                    tech: { coverage: document.getElementById('tCov').value, drying: document.getElementById('tDry').value, thickness: document.getElementById('tThick').value }
                };
                if(id) await updateDoc(doc(db, "products", id), d);
                else await addDoc(collection(db, "products"), d);
                alert("נשמר בהצלחה!");
            },
            delProd: async () => {
                const id = document.getElementById('pid').value;
                if(id && confirm("למחוק?")) { await deleteDoc(doc(db, "products", id)); app.newProd(); }
            },
            filter: () => {
                const t = document.getElementById('pSearch').value.toLowerCase();
                Array.from(document.getElementById('pList').children).forEach(e => {
                    e.style.display = e.innerText.toLowerCase().includes(t) ? 'flex' : 'none';
                });
            },

            // --- Brands ---
            loadBrands: () => {
                onSnapshot(collection(db, "brands"), snap => {
                    const l = document.getElementById('bList'); l.innerHTML = "";
                    snap.forEach(d => {
                        const b = d.data();
                        l.innerHTML += `
                            <div class="bg-white p-4 rounded-xl border flex flex-col items-center gap-2">
                                <img src="${b.logo}" class="h-8 object-contain">
                                <span class="font-bold text-sm">${b.name}</span>
                                <div class="flex gap-1">
                                    <div class="w-3 h-3 rounded-full" style="background:${b.colors?.primary}"></div>
                                    <div class="w-3 h-3 rounded-full" style="background:${b.colors?.accent}"></div>
                                </div>
                            </div>`;
                    });
                });
            },

            // --- Seed ---
            runSeed: async () => {
                if(confirm("פעולה זו תמחק את כל הנתונים ותטען נתוני בסיס תקינים. להמשיך?")) {
                    try {
                        await seedRealData();
                        alert("הנתונים אותחלו בהצלחה!");
                    } catch(e) { alert("שגיאה: " + e.message); }
                }
            }
        };

        window.app = app;
        app.init();
    </script>
</body>
</html>
