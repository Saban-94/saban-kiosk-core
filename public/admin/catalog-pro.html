<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Saban Admin | ניהול קטלוג חכם</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-100 p-10 font-sans">

    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        
        <div class="bg-black text-white p-6 flex justify-between items-center">
            <h1 class="text-2xl font-bold flex gap-2"><i data-lucide="bot"></i> מנהל הקטלוג (AI)</h1>
            <div class="text-sm text-gray-400 flex items-center gap-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                מחובר ל-Firebase
            </div>
        </div>

        <div class="p-8">
            <div class="bg-yellow-50 p-6 rounded-xl border border-yellow-200 mb-8">
                <label class="font-bold mb-2 block text-yellow-800">הוספת מוצר חדש (מילוי מהיר עם AI)</label>
                <div class="flex gap-4">
                    <input type="text" id="searchInput" placeholder="הקלד שם מוצר (למשל: סיקה טופ 107)" 
                           class="flex-1 p-4 border-2 border-white shadow-sm rounded-xl text-xl focus:border-yellow-500 outline-none">
                    <button onclick="magicFill()" class="bg-black text-white hover:bg-gray-800 font-bold px-8 rounded-xl flex items-center gap-2 transition shadow-lg">
                        <i data-lucide="sparkles" class="text-yellow-400"></i> שאל את ג'מיני
                    </button>
                </div>
                <div id="aiStatus" class="text-sm mt-2 text-gray-500 h-5"></div>
            </div>

            <hr class="mb-8 border-gray-100">

            <div class="grid grid-cols-2 gap-6">
                <div>
                    <label class="block font-bold mb-1 text-gray-700">שם מוצר מלא</label>
                    <input type="text" id="pName" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:border-black transition outline-none">
                </div>
                <div>
                    <label class="block font-bold mb-1 text-gray-700">מותג</label>
                    <input type="text" id="pBrand" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:border-black transition outline-none">
                </div>

                <div class="col-span-2">
                    <label class="block font-bold mb-1 text-gray-700">תיאור שיווקי קצר</label>
                    <input type="text" id="pShort" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:border-black transition outline-none">
                </div>
                <div class="col-span-2">
                    <label class="block font-bold mb-1 text-gray-700">תיאור טכני מלא</label>
                    <textarea id="pFull" rows="3" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:border-black transition outline-none"></textarea>
                </div>
                
                <div class="col-span-2">
                    <label class="block font-bold mb-1 text-gray-700">קישור לתמונה (URL)</label>
                    <div class="flex gap-4">
                        <input type="text" id="pImage" onchange="updatePreview()" class="flex-1 p-3 bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:border-black transition outline-none" placeholder="https://...">
                        <img id="previewImg" src="" class="h-12 w-12 object-contain border rounded bg-white hidden">
                    </div>
                </div>

                <div class="col-span-2 bg-gray-900 text-gray-300 p-4 rounded-xl font-mono text-sm">
                    <div class="flex justify-between mb-2">
                        <label class="font-bold text-white">מפרט טכני (JSON)</label>
                        <span class="text-xs text-gray-500">ערוך בזהירות</span>
                    </div>
                    <textarea id="pSpecs" rows="6" class="w-full p-2 bg-black border border-gray-700 rounded text-green-400 outline-none"></textarea>
                </div>
            </div>

            <button onclick="saveToFirebase()" class="w-full mt-8 bg-[#E3000F] text-white py-4 rounded-xl font-bold text-xl hover:bg-red-700 transition flex justify-center gap-2 shadow-xl hover:shadow-2xl transform hover:-translate-y-1">
                <i data-lucide="save"></i> שמור מוצר למסד הנתונים
            </button>
            
            <div id="statusMsg" class="text-center mt-4 font-bold h-6"></div>
        </div>
    </div>
<script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        // שינוי: מייבאים גם את פונקציית התמונות
        import { askGeminiAdmin, findProductImage } from '../js/gemini-service.js';

        lucide.createIcons();
        
        window.updatePreview = () => {
            const url = document.getElementById('pImage').value;
            const img = document.getElementById('previewImg');
            if(url) { img.src = url; img.classList.remove('hidden'); }
        }

        // --- הפונקציה המעודכנת ---
        window.magicFill = async () => {
            const query = document.getElementById('searchInput').value;
            if(!query) return alert("אנא כתוב שם מוצר");
            
            const status = document.getElementById('aiStatus');
            status.innerHTML = `<span class="flex items-center gap-2 text-yellow-600"><i data-lucide="loader-2" class="animate-spin"></i> מעבד נתונים ומחפש תמונה...</span>`;
            lucide.createIcons();
            
            // 1. הפעלת חיפוש טקסט וחיפוש תמונה במקביל (Promise.all למהירות מקסימלית)
            const [textData, imageUrl] = await Promise.all([
                askGeminiAdmin(query),     // שואל את המוח
                findProductImage(query)    // שואל את העיניים
            ]);
            
            if(textData) {
                // מילוי טקסטים
                document.getElementById('pName').value = textData.name || query;
                document.getElementById('pShort').value = textData.shortDesc || "";
                document.getElementById('pFull').value = textData.fullDesc || "";
                document.getElementById('pBrand').value = textData.brand || "כללי";
                document.getElementById('pSpecs').value = JSON.stringify(textData.specs || [], null, 2);
                
                // מילוי תמונה (אם נמצאה)
                if (imageUrl) {
                    document.getElementById('pImage').value = imageUrl;
                    window.updatePreview(); // הצגת התמונה מיד
                    status.innerHTML = `<span class="text-green-600 font-bold">✅ נמצאו נתונים + תמונה!</span>`;
                } else {
                    document.getElementById('pImage').placeholder = "לא נמצאה תמונה, הדבק ידנית...";
                    status.innerHTML = `<span class="text-blue-600 font-bold">✅ נתונים מולאו (ללא תמונה).</span>`;
                }
            } else {
                status.innerText = "❌ שגיאה בקבלת נתונים.";
            }
        };

        window.saveToFirebase = async () => {
             // ... (השאר אותו הדבר כמו בקוד הקודם) ...
             // רק וודא שאתה מעתיק את פונקציית השמירה מהגרסה הקודמת אם מחקת הכל
             const btn = document.querySelector('button[onclick="saveToFirebase()"]');
             // ... המשך לוגיקת שמירה ...
             // (אם אתה צריך את הקוד המלא של saveToFirebase תגיד לי, הנחתי שהוא כבר קיים אצלך)
             const name = document.getElementById('pName').value;
             if(!name) return alert("חובה שם מוצר");
             
             try {
                 await addDoc(collection(db, "products"), {
                    name: name,
                    brand: document.getElementById('pBrand').value,
                    shortDesc: document.getElementById('pShort').value,
                    fullDesc: document.getElementById('pFull').value,
                    image: document.getElementById('pImage').value,
                    specs: JSON.parse(document.getElementById('pSpecs').value),
                    price: 0,
                    createdAt: new Date()
                 });
                 alert("נשמר!");
                 location.reload();
             } catch(e) {
                 console.error(e);
                 alert("שגיאה בשמירה");
             }
        };
    </script>
</body>
</html>
