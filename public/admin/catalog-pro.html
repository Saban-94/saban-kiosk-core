<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Sika Admin - Smart Fill</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background: #f3f4f6; }
        
        /* ×›×¨×˜×™×¡ ×”×§×™×•×¡×§ */
        .kiosk-card {
            background: white; border-radius: 20px; overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15); display: flex; flex-direction: column;
            height: 680px; width: 380px; margin: 0 auto; position: sticky; top: 20px;
            border: 1px solid #e2e8f0;
        }
        .media-area { height: 38%; background: #f8fafc; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .media-area img { max-height: 90%; max-width: 90%; object-fit: contain; mix-blend-mode: multiply; }
        .ribbon { position: absolute; top: 20px; left: -30px; transform: rotate(-45deg); color: white; padding: 5px 40px; font-weight: 900; font-size: 0.8rem; box-shadow: 0 5px 10px rgba(0,0,0,0.2); z-index: 10; text-transform: uppercase; }
        .ribbon.sale { background: #E3000F; } 
        .ribbon.recommended { background: #FFC500; color: black; }
        .ribbon.new { background: #2563eb; }
        .brand-logo { position: absolute; top: 15px; right: 15px; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 5; background: white; }
        .brand-logo img { width: 80%; }
        .content-area { padding: 25px; flex: 1; display: flex; flex-direction: column; gap: 10px; }
        
        /* ×’×œ×¨×™×•×ª */
        .selection-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .selectable-item { border: 3px solid transparent; border-radius: 8px; overflow: hidden; cursor: pointer; opacity: 0.8; transition: all 0.2s; position: relative; height: 60px; background: #f1f5f9; }
        .selectable-item:hover { opacity: 1; transform: scale(1.02); }
        .selectable-item.selected { border-color: #22c55e; opacity: 1; box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.3); }
        .check-mark { position: absolute; top: 2px; right: 2px; background: #22c55e; color: white; border-radius: 50%; padding: 2px; display: none; }
        .selected .check-mark { display: block; }

        /* × ×ª×•× ×™× ×˜×›× ×™×™× */
        .tech-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; background: #f8fafc; padding: 10px; border-radius: 12px; margin-top: 5px; }
        .tech-item { text-align: center; }
        .tech-val { font-weight: 900; font-size: 0.85rem; color: #0f172a; }
        .tech-lbl { font-size: 0.65rem; color: #64748b; font-weight: bold; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-8">
        
        <div class="col-span-12 lg:col-span-7 space-y-6">
            
            <div class="bg-gray-800 text-white p-4 rounded-xl flex justify-between items-center shadow-lg">
                <div>
                    <h3 class="font-bold text-lg"><i data-lucide="upload-cloud"></i> ×™×‘×•× ×§×•×‘×¥ Scraper</h3>
                    <p class="text-xs text-gray-400">×˜×¢×Ÿ ××ª ×”-JSON ×©×™×¨×“ ××”××ª×¨ (Bulldozer/Sniper)</p>
                </div>
                <div class="flex gap-3">
                    <input type="file" id="jsonFile" accept=".json" class="hidden" onchange="handleBulkUpload(this)">
                    <button onclick="document.getElementById('jsonFile').click()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2">
                        <i data-lucide="file-json"></i> ×˜×¢×Ÿ JSON
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                <input type="hidden" id="editModeId">
                
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-black flex items-center gap-3">
                        <span class="bg-black text-white px-3 py-1 rounded text-xl">Sika Admin</span>
                        ×¢×•×¨×š ××•×¦×¨×™×
                    </h1>
                    <button id="btnCancel" onclick="resetForm()" class="hidden text-red-500 font-bold bg-red-50 px-3 py-1 rounded hover:bg-red-100">×‘×™×˜×•×œ</button>
                </div>

                <div class="flex gap-2 mb-8">
                    <input type="text" id="searchInput" placeholder="×”×§×œ×“ ×©× ××•×¦×¨..." class="flex-1 p-4 border-2 border-black rounded-xl text-xl font-bold">
                    <button onclick="runAI()" class="bg-green-600 text-white px-6 rounded-xl font-bold text-lg hover:bg-green-700 shadow-lg flex items-center gap-2">
                        <i data-lucide="sparkles"></i> ×”×©×œ× ×©×“×•×ª ×—×¡×¨×™× (AI)
                    </button>
                </div>

                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">×©× ××•×¦×¨</label>
                            <input id="pName" oninput="updatePreview()" class="w-full p-3 bg-gray-50 border rounded-lg font-bold">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">××•×ª×’</label>
                            <input id="pBrand" oninput="updatePreview()" class="w-full p-3 bg-gray-50 border rounded-lg font-bold">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        <div class="bg-gray-50 p-4 rounded-xl border">
                            <label class="font-bold flex justify-between mb-2">
                                <span><i data-lucide="image"></i> ×ª××•× ×” ×¨××©×™×ª</span>
                                <span class="text-xs text-gray-400 font-normal">×”×“×‘×§ ×œ×™× ×§ ××• ×‘×—×¨ ××”×’×œ×¨×™×”</span>
                            </label>
                            <input type="text" id="pImageUrl" oninput="updatePreview()" placeholder="https://..." class="w-full p-2 mb-2 border rounded text-sm text-blue-600 font-mono">
                            
                            <div id="imageGallery" class="selection-grid min-h-[50px]"></div>
                            <input type="hidden" id="pImagesJson"> 
                        </div>

                        <div class="bg-gray-50 p-4 rounded-xl border">
                            <label class="font-bold flex justify-between mb-2">
                                <span><i data-lucide="video"></i> ×¡×¨×˜×•×Ÿ (YouTube)</span>
                                <span class="text-xs text-gray-400 font-normal">×ª×•××š ×‘×œ×™× ×§×™× ××™×•×˜×™×•×‘</span>
                            </label>
                            <input type="text" id="pVideoUrl" oninput="updatePreview()" placeholder="https://www.youtube.com/watch?v=..." class="w-full p-2 mb-2 border rounded text-sm text-red-600 font-mono">
                            
                            <div id="videoGallery" class="selection-grid min-h-[0px]"></div>
                        </div>
                    </div>

                    <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 grid grid-cols-2 gap-4 relative">
                        <div class="col-span-2 font-bold text-blue-900 mb-1 flex items-center gap-2">
                            <i data-lucide="megaphone"></i> ×ª×•×›×Ÿ ×©×™×•×•×§×™ (AI ×××œ× ×‘×“×¨×š ×›×œ×œ)
                        </div>
                        
                        <div>
                            <label class="text-xs font-bold text-blue-800">×¡×˜×˜×•×¡</label>
                            <select id="pStatus" onchange="updatePreview()" class="w-full p-2 rounded border border-blue-200 text-sm">
                                <option value="standard">×¨×’×™×œ</option>
                                <option value="recommended">â­ ××•××œ×¥</option>
                                <option value="sale">ğŸ·ï¸ ××‘×¦×¢</option>
                                <option value="new">âœ¨ ×—×“×©</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-blue-800">×›×¤×ª×•×¨ (CTA)</label>
                            <input id="pCta" oninput="updatePreview()" class="w-full p-2 rounded border border-blue-200 text-sm">
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs font-bold text-blue-800">×ª×™××•×¨ ×©×™×•×•×§×™</label>
                            <textarea id="pMarketing" oninput="updatePreview()" rows="2" class="w-full p-2 rounded border border-blue-200 text-sm"></textarea>
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs font-bold text-blue-800">×ª×§×Ÿ</label>
                            <input id="pStandard" oninput="updatePreview()" class="w-full p-2 rounded border border-blue-200 text-sm">
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <label class="font-bold text-sm mb-2 block flex gap-2"><i data-lucide="ruler"></i> ××¤×¨×˜ ×˜×›× ×™</label>
                        <div class="grid grid-cols-3 gap-2">
                            <input id="pCoverage" oninput="updatePreview()" placeholder="×›×™×¡×•×™ (×œ×''×¨)" class="p-2 border rounded text-sm">
                            <input id="pDrying" oninput="updatePreview()" placeholder="×–××Ÿ ×™×™×‘×•×©" class="p-2 border rounded text-sm">
                            <input id="pThickness" oninput="updatePreview()" placeholder="×¢×•×‘×™ ×™×™×©×•×" class="p-2 border rounded text-sm">
                        </div>
                    </div>
                    
                    <input id="pPdf" type="hidden"> 
                    <textarea id="pSpecs" class="hidden"></textarea> 

                    <button onclick="saveProduct()" class="w-full bg-black text-white py-4 rounded-xl font-bold text-xl hover:bg-gray-800 shadow-xl flex justify-center gap-2">
                        <i data-lucide="save"></i> ×©××•×¨ ×©×™× ×•×™×™×
                    </button>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-xl"><i data-lucide="package"></i> × ×™×”×•×œ ××œ××™</h2>
                    <button onclick="loadInventory()" class="text-xs bg-gray-100 p-2 rounded"><i data-lucide="refresh-cw"></i></button>
                </div>
                <div id="inventoryTable" class="space-y-2 max-h-[500px] overflow-y-auto pr-2"></div>
            </div>
        </div>

        <div class="col-span-12 lg:col-span-5 relative hidden lg:block">
            <div class="sticky top-10">
                <div class="text-center mb-4 font-bold text-gray-400 text-sm tracking-widest">LIVE PREVIEW</div>
                <div class="kiosk-card relative">
                    <div class="brand-logo"><img id="prevLogo" src=""></div>
                    <div id="prevRibbon" class="ribbon hidden"></div>
                    <div class="media-area">
                        <img id="prevImage" src="https://via.placeholder.com/300?text=Sika">
                        <div id="prevVideoBadge" class="absolute bottom-4 left-4 bg-red-600 text-white p-2 rounded-full hidden shadow-lg animate-pulse"><i data-lucide="play" size="20"></i></div>
                    </div>
                    <div class="content-area">
                        <div>
                            <div id="prevBrand" class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">SIKA</div>
                            <h2 id="prevName" class="text-3xl font-black leading-none mb-1 text-gray-800">×©× ××•×¦×¨</h2>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100 text-sm text-gray-800 italic leading-relaxed" id="prevMarketing">×ª×™××•×¨...</div>
                        <div class="tech-grid">
                            <div class="tech-item"><i data-lucide="maximize" class="mx-auto text-red-500 mb-1" size="16"></i><div class="tech-val" id="prevCov">-</div><div class="tech-lbl">×›×™×¡×•×™ ×œ×"×¨</div></div>
                            <div class="tech-item"><i data-lucide="clock" class="mx-auto text-red-500 mb-1" size="16"></i><div class="tech-val" id="prevDry">-</div><div class="tech-lbl">×–××Ÿ ×™×™×‘×•×©</div></div>
                            <div class="tech-item"><i data-lucide="layers" class="mx-auto text-red-500 mb-1" size="16"></i><div class="tech-val" id="prevThick">-</div><div class="tech-lbl">×¢×•×‘×™ ×™×™×©×•×</div></div>
                        </div>
                        <div id="prevStandardBox" class="flex items-center gap-2 text-xs text-green-700 bg-green-50 p-2 rounded border border-green-100 hidden mt-1">
                            <i data-lucide="shield-check" size="14"></i><span id="prevStandard"></span>
                        </div>
                        <div class="mt-auto">
                            <button id="prevBtn" class="w-full bg-[#E3000F] text-white py-4 rounded-xl font-black text-lg shadow-md flex justify-center items-center gap-2">×”×•×¡×£ ×œ×”×¦×¢×ª ××—×™×¨ <i data-lucide="arrow-left"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { askGeminiAdmin, searchImages, searchVideos } from '../js/gemini-service.js';

        lucide.createIcons();
        let selectedImages = []; 
        let allProducts = [];

        const brandLogos = {
            'sika': 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/62/Sika_AG_logo.svg/1200px-Sika_AG_logo.svg.png',
            'misterfix': 'https://karmit-mrfix.com/wp-content/uploads/2020/07/logo.png',
            'thermokir': 'https://www.thermokir.co.il/wp-content/uploads/2019/06/logo.png',
            'default': 'https://cdn-icons-png.flaticon.com/512/1088/1088537.png'
        };

        // --- ×¢×“×›×•×Ÿ ×ª×¦×•×’×” ×—×™×” ---
        window.updatePreview = () => {
            const getVal = (id) => document.getElementById(id).value;
            
            document.getElementById('prevName').innerText = getVal('pName') || "×©× ××•×¦×¨";
            document.getElementById('prevBrand').innerText = (getVal('pBrand') || "BRAND").toUpperCase();
            document.getElementById('prevMarketing').innerText = getVal('pMarketing') || "×ª×™××•×¨ ×©×™×•×•×§×™...";
            document.getElementById('prevBtn').innerHTML = `${getVal('pCta') || "×”×•×¡×£ ×œ×”×¦×¢×ª ××—×™×¨"} <i data-lucide="arrow-left"></i>`;
            
            // ×œ×•×’×•
            const brandKey = Object.keys(brandLogos).find(k => (getVal('pBrand')||"").toLowerCase().includes(k)) || 'default';
            document.getElementById('prevLogo').src = brandLogos[brandKey];

            // ×¨×™×‘×•×Ÿ
            const status = getVal('pStatus');
            const ribbon = document.getElementById('prevRibbon');
            ribbon.className = `ribbon ${status}`;
            ribbon.classList.toggle('hidden', status === 'standard');
            const statusText = { 'recommended': '××•××œ×¥', 'sale': '××‘×¦×¢', 'new': '×—×“×©' };
            ribbon.innerText = statusText[status] || '';

            // ×ª××•× ×”: ×§×•×“× ×‘×•×“×§ ×× ×™×© ×”×“×‘×§×” ×™×“× ×™×ª, ×× ×œ× ×‘×•×“×§ ×’×œ×¨×™×”
            const manualImg = getVal('pImageUrl');
            if(manualImg && manualImg.length > 5) {
                document.getElementById('prevImage').src = manualImg;
            } else if(selectedImages.length > 0) {
                document.getElementById('prevImage').src = selectedImages[0];
            }

            // ×•×™×“××•
            const vidUrl = getVal('pVideoUrl');
            document.getElementById('prevVideoBadge').classList.toggle('hidden', !vidUrl);

            // ×˜×›× ×™
            document.getElementById('prevCov').innerText = getVal('pCoverage') || "-";
            document.getElementById('prevDry').innerText = getVal('pDrying') || "-";
            document.getElementById('prevThick').innerText = getVal('pThickness') || "-";

            // ×ª×§×Ÿ
            const std = getVal('pStandard');
            document.getElementById('prevStandardBox').classList.toggle('hidden', !std);
            document.getElementById('prevStandard').innerText = std;
            
            lucide.createIcons();
        }

        // --- ×× ×•×¢ ×”-AI ×”××©×•×“×¨×’ (×”×©×œ××” ×‘×œ×‘×“) ---
        window.runAI = async () => {
            const query = document.getElementById('searchInput').value || document.getElementById('pName').value;
            if(!query) return alert("×× × ×”×–×Ÿ ×©× ××•×¦×¨ ×œ×—×™×¤×•×©");
            
            const btn = document.querySelector('button[onclick="runAI()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin"></i> ××¢×‘×“...`;
            
            // ×× ×—× ×• ×œ× ×¨×•×¦×™× ×œ×“×¨×•×¡ ××™×“×¢ ×§×™×™×!
            // × ×‘×¦×¢ ×§×¨×™××” ×œ-AI ×›×“×™ ×œ×§×‘×œ ×”×©×œ××•×ª
            try {
                const [data, images, videos] = await Promise.all([
                    askGeminiAdmin(query),
                    searchImages(query),
                    searchVideos(query)
                ]);

                if(data) {
                    // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨: ×¢×“×›×Ÿ ×¨×§ ×× ×”×©×“×” ×¨×™×§
                    const fillIfEmpty = (id, val) => {
                        const el = document.getElementById(id);
                        if (!el.value && val) el.value = val;
                    };

                    fillIfEmpty('pName', data.name);
                    fillIfEmpty('pBrand', data.brand);
                    fillIfEmpty('pMarketing', data.marketingDesc);
                    fillIfEmpty('pCta', data.ctaText);
                    fillIfEmpty('pStandard', data.standard);
                    
                    if(data.tech) {
                        fillIfEmpty('pCoverage', data.tech.coverage);
                        fillIfEmpty('pDrying', data.tech.drying);
                        fillIfEmpty('pThickness', data.tech.thickness);
                    }
                    
                    // ××¤×¨×˜ JSON ×ª××™×“ × ×¢×“×›×Ÿ ×× ××™×Ÿ
                    if(!document.getElementById('pSpecs').value) {
                        document.getElementById('pSpecs').value = JSON.stringify(data.specs || []);
                    }
                }

                // ×’×œ×¨×™×•×ª: ××¦×™×’ ×”×¦×¢×•×ª ××‘×œ ×œ× ×‘×•×—×¨ ××•×˜×•××˜×™×ª ×× ×›×‘×¨ ×™×© ×ª××•× ×”
                renderImageGallery(images);
                renderVideoGallery(videos);

            } catch(e) {
                console.error(e);
                alert("×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”-AI");
            }

            btn.innerHTML = originalText;
            updatePreview();
            lucide.createIcons();
        };

        // --- ×’×œ×¨×™×•×ª ---
        function renderImageGallery(images) {
            const container = document.getElementById('imageGallery');
            // ×× ×›×‘×¨ ×™×© ×ª××•× ×” ×‘×©×“×” ×”×™×“× ×™, ×œ× ××•×—×§×™× ××•×ª×”
            const currentUrl = document.getElementById('pImageUrl').value;
            
            container.innerHTML = images.map(url => `
                <div class="selectable-item" onclick="selectFromGallery('${url}', this)">
                    <img src="${url}" class="w-full h-full object-contain">
                    <div class="check-mark"><i data-lucide="check" size="12"></i></div>
                </div>
            `).join('');
            
            // ×× ×”×©×“×” ×¨×™×§, ××¤×©×¨ ×œ×‘×—×•×¨ ××ª ×”×¨××©×•×Ÿ
            if(!currentUrl && images.length) {
                // ××•×¤×¦×™×•× ×œ×™: selectFromGallery(images[0], container.children[0]);
            }
        }

        window.selectFromGallery = (url, el) => {
            document.querySelectorAll('#imageGallery .selectable-item').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('pImageUrl').value = url; // ××¢×“×›×Ÿ ××ª ×”×©×“×” ×”×™×“× ×™
            selectedImages = [url];
            updatePreview();
        }

        function renderVideoGallery(videos) {
            const container = document.getElementById('videoGallery');
            container.innerHTML = videos.map(vid => `
                <div class="selectable-item bg-black" onclick="selectVideo('https://youtu.be/${vid.id}', this)">
                    <img src="${vid.thumbnail}" class="w-full h-full object-cover opacity-60">
                    <div class="absolute inset-0 flex items-center justify-center"><i data-lucide="play-circle" class="text-white"></i></div>
                    <div class="check-mark"><i data-lucide="check" size="12"></i></div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.selectVideo = (url, el) => {
            document.querySelectorAll('#videoGallery .selectable-item').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('pVideoUrl').value = url;
            updatePreview();
        }

        // --- ×©××™×¨×” ---
        window.saveProduct = async () => {
            const btn = document.querySelector('button[onclick="saveProduct()"]');
            btn.innerHTML = `×©×•××¨...`;
            
            try {
                // ×œ×•×’×™×§×” ×œ×•×™×“××•: ×× ×–×” ×œ×™× ×§ ×™×•×˜×™×•×‘ ×¨×’×™×œ, × ×•×•×“× ×©×”×•× × ×©××¨ × ×›×•×Ÿ
                let vidUrl = document.getElementById('pVideoUrl').value;
                
                const data = {
                    name: document.getElementById('pName').value,
                    brand: document.getElementById('pBrand').value,
                    status: document.getElementById('pStatus').value,
                    marketingDesc: document.getElementById('pMarketing').value,
                    ctaText: document.getElementById('pCta').value,
                    standard: document.getElementById('pStandard').value,
                    // ×œ×•×§×— ××”×©×“×” ×”×™×“× ×™ (×”×›×™ ×—×©×•×‘)
                    image: document.getElementById('pImageUrl').value,
                    // ×©×•××¨ ×’× ××¢×¨×š ×œ××§×¨×” ×©×œ ×’×œ×¨×™×” ×¢×ª×™×“×™×ª
                    images: selectedImages.length ? selectedImages : [document.getElementById('pImageUrl').value],
                    video: vidUrl,
                    coverage: document.getElementById('pCoverage').value,
                    drying: document.getElementById('pDrying').value,
                    thickness: document.getElementById('pThickness').value,
                    specs: JSON.parse(document.getElementById('pSpecs').value || "[]"),
                    updatedAt: new Date()
                };

                const editId = document.getElementById('editModeId').value;
                if(editId) {
                    await updateDoc(doc(db, "products", editId), data);
                } else {
                    data.createdAt = new Date();
                    await addDoc(collection(db, "products"), data);
                }
                
                alert("âœ… ×”××•×¦×¨ × ×©××¨ ×‘×”×¦×œ×—×”!");
                loadInventory();
                resetForm();

            } catch (e) {
                alert("×©×’×™××”: " + e.message);
            }
            btn.innerHTML = `<i data-lucide="save"></i> ×©××•×¨ ×©×™× ×•×™×™×`;
            lucide.createIcons();
        }

        // --- ×™×‘×•× ×”××•× ×™ ---
        window.handleBulkUpload = async (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const json = JSON.parse(e.target.result);
                const products = Array.isArray(json) ? json : [json];
                if (!confirm(`×œ×™×™×‘× ${products.length} ××•×¦×¨×™×?`)) return;
                
                for (const p of products) {
                    await addDoc(collection(db, "products"), {
                        ...p, 
                        createdAt: new Date(), 
                        // ×× ×”×¡×•×¨×§ ××¦× ××¤×¨×˜, × ×©×ª××© ×‘×•, ××—×¨×ª ×¨×™×§
                        tech: p.tech || { coverage:"", drying:"", thickness:"" },
                        marketingDesc: p.marketingDesc || "",
                        specs: []
                    });
                }
                alert("×”×™×‘×•× ×”×•×©×œ×.");
                loadInventory();
            };
            reader.readAsText(file);
        }

        // --- ×˜×‘×œ×ª ××œ××™ ×•×”×©×‘×—×ª ×¨×§×¢ ---
        window.loadInventory = async () => {
            const container = document.getElementById('inventoryTable');
            const snap = await getDocs(collection(db, "products"));
            container.innerHTML = "";
            allProducts = [];
            
            snap.forEach(doc => {
                const p = {id: doc.id, ...doc.data()};
                allProducts.push(p);
                
                // ×›×¤×ª×•×¨ ×”×©×‘×—×” (×§×¡×) ×‘×˜×‘×œ×”
                const isEnhanced = p.marketingDesc && p.marketingDesc.length > 5;
                const enhanceBtn = isEnhanced 
                    ? `<span class="text-green-500 text-xs"><i data-lucide="check-circle" size="14"></i></span>`
                    : `<button onclick="enhanceProduct('${doc.id}', '${p.name}')" class="bg-purple-100 text-purple-700 p-1 rounded hover:bg-purple-200" title="×”×©×œ× ××™×“×¢ ×—×¡×¨"><i data-lucide="sparkles" size="14"></i></button>`;

                container.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded border hover:bg-white transition">
                        <div class="flex items-center gap-3">
                            <img src="${p.image}" class="w-10 h-10 object-contain bg-white rounded border">
                            <div class="overflow-hidden">
                                <div class="font-bold text-sm truncate w-40">${p.name}</div>
                                <div class="text-[10px] text-gray-400">${p.brand}</div>
                            </div>
                        </div>
                        <div class="flex gap-2 items-center">
                             ${enhanceBtn}
                             <button onclick="editProduct('${doc.id}')" class="text-blue-500 hover:text-blue-700"><i data-lucide="edit-3" size="14"></i></button>
                             <button onclick="deleteProduct('${doc.id}')" class="text-red-300 hover:text-red-600"><i data-lucide="trash-2" size="14"></i></button>
                        </div>
                    </div>`;
            });
            lucide.createIcons();
        }

        // --- ×”×©×‘×—×” ×‘×¨×§×¢ (××•× ×¢ ×“×¨×™×¡×”) ---
        window.enhanceProduct = async (id, name) => {
            const btn = event.currentTarget;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin" size="14"></i>`;
            
            try {
                // 1. ×©×•××‘ ××ª ×”××¡××š ×”×§×™×™× ×›×“×™ ×œ×“×¢×ª ××” ×™×©
                const docRef = doc(db, "products", id);
                // (×‘×’×¨×¡×” ×¤×©×•×˜×” ×× ×—× ×• ×œ× ×©×•××‘×™× ×©×•×‘ ×›×™ ×™×© ×œ× ×• ××ª allProducts, ××‘×œ ×œ×™×ª×¨ ×‘×™×˜×—×•×Ÿ × ×©×ª××© ×‘××™×“×¢ ××”×–×™×›×¨×•×Ÿ)
                const currentProd = allProducts.find(p => p.id === id) || {};

                // 2. ×©×•××œ ××ª AI
                const aiData = await askGeminiAdmin(name);
                
                if (aiData) {
                    // 3. ×××–×’ ×‘×–×”×™×¨×•×ª (×¨×§ ××” ×©×—×¡×¨)
                    const updates = {
                        marketingDesc: currentProd.marketingDesc || aiData.marketingDesc,
                        status: (currentProd.status === 'standard' ? aiData.status : currentProd.status) || 'standard',
                        ctaText: currentProd.ctaText || aiData.ctaText,
                        standard: currentProd.standard || aiData.standard,
                        tech: {
                            coverage: currentProd.tech?.coverage || aiData.tech?.coverage,
                            drying: currentProd.tech?.drying || aiData.tech?.drying,
                            thickness: currentProd.tech?.thickness || aiData.tech?.thickness,
                        },
                        updatedAt: new Date()
                    };

                    await updateDoc(docRef, updates);
                    btn.parentNode.innerHTML = `<span class="text-green-500 text-xs"><i data-lucide="check-circle" size="14"></i></span>`;
                    lucide.createIcons();
                }
            } catch (e) {
                console.error(e);
                btn.innerHTML = `<i data-lucide="alert-triangle" class="text-red-500" size="14"></i>`;
            }
        };

        window.editProduct = (id) => {
            const p = allProducts.find(x => x.id === id);
            if(!p) return;
            document.getElementById('editModeId').value = id;
            document.getElementById('pName').value = p.name;
            document.getElementById('pBrand').value = p.brand;
            document.getElementById('pStatus').value = p.status || 'standard';
            document.getElementById('pMarketing').value = p.marketingDesc || "";
            document.getElementById('pStandard').value = p.standard || "";
            document.getElementById('pCta').value = p.ctaText || "";
            
            // ××™×œ×•×™ ×™×“× ×™ ×©×œ ×”×©×“×•×ª ×”×˜×›× ×™×™×
            document.getElementById('pCoverage').value = p.tech?.coverage || p.coverage || "";
            document.getElementById('pDrying').value = p.tech?.drying || p.drying || "";
            document.getElementById('pThickness').value = p.tech?.thickness || p.thickness || "";
            
            // ×ª××•× ×”: ××¦×™×’ ××ª ×”×œ×™× ×§ ×‘×©×“×” ×”×™×“× ×™
            document.getElementById('pImageUrl').value = p.image || "";
            // ×•×™×“××•: ××¦×™×’ ××ª ×”×œ×™× ×§ ×‘×©×“×” ×”×™×“× ×™
            document.getElementById('pVideoUrl').value = p.video || "";

            // ×× ×™×© ×’×œ×¨×™×”, ×˜×•×¢×Ÿ ××•×ª×” ×‘×¦×“
            const galleryImgs = p.images && p.images.length ? p.images : (p.image ? [p.image] : []);
            renderImageGallery(galleryImgs);
            selectedImages = galleryImgs;

            document.getElementById('btnCancel').classList.remove('hidden');
            window.scrollTo({top:0, behavior:'smooth'});
            updatePreview();
        }

        window.deleteProduct = async (id) => {
            if(confirm("×œ××—×•×§?")) {
                await deleteDoc(doc(db, "products", id));
                loadInventory();
            }
        }

        window.resetForm = () => {
            document.getElementById('editModeId').value = "";
            document.querySelectorAll('input, textarea').forEach(i => i.value = "");
            document.getElementById('btnCancel').classList.add('hidden');
            document.getElementById('imageGallery').innerHTML = "";
            document.getElementById('videoGallery').innerHTML = "";
            updatePreview();
        }

        loadInventory();
    </script>
</body>
</html>
