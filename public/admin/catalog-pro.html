<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Sika Marketing Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background: #f3f4f6; }
        
        /* ×›×¨×˜×™×¡ ×”×§×™×•×¡×§ - ×¢×™×¦×•×‘ ×©×™×•×•×§×™ */
        .kiosk-card {
            background: white; border-radius: 20px; overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15); display: flex; flex-direction: column;
            height: 650px; width: 380px; margin: 0 auto; position: sticky; top: 20px;
            border: 1px solid #e2e8f0;
        }
        .media-area { height: 40%; background: #f8fafc; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .media-area img { max-height: 90%; max-width: 90%; object-fit: contain; mix-blend-mode: multiply; }
        
        /* ×¨×™×‘×•× ×™× ×•×¡×˜×˜×•×¡×™× */
        .ribbon { position: absolute; top: 20px; left: -30px; transform: rotate(-45deg); background: #E3000F; color: white; padding: 5px 40px; font-weight: 900; font-size: 0.8rem; shadow: 0 5px 10px rgba(0,0,0,0.2); z-index: 10; text-transform: uppercase; }
        .ribbon.sale { background: #E3000F; } /* ××“×•× */
        .ribbon.recommended { background: #FFC500; color: black; } /* ×¦×”×•×‘ */
        .ribbon.new { background: #2563eb; } /* ×›×—×•×œ */
        
        .brand-logo { position: absolute; top: 15px; right: 15px; width: 50px; height: 50px; bg: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 5; background: white; }
        .brand-logo img { width: 80%; }

        .content-area { padding: 25px; flex: 1; display: flex; flex-direction: column; gap: 10px; }
        
        /* ×’×œ×¨×™×” ×œ×‘×—×™×¨×” */
        .selection-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .selectable-item { border: 3px solid transparent; border-radius: 8px; overflow: hidden; cursor: pointer; opacity: 0.8; transition: all 0.2s; position: relative; height: 80px; }
        .selectable-item:hover { opacity: 1; transform: scale(1.02); }
        .selectable-item.selected { border-color: #22c55e; opacity: 1; box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.3); }
        .check-mark { position: absolute; top: 2px; right: 2px; background: #22c55e; color: white; border-radius: 50%; padding: 2px; display: none; }
        .selected .check-mark { display: block; }

        .tech-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; background: #f8fafc; padding: 10px; border-radius: 12px; }
        .tech-item { text-align: center; }
        .tech-val { font-weight: 900; font-size: 0.9rem; }
        .tech-lbl { font-size: 0.7rem; color: #64748b; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-8">
        
        <div class="col-span-12 lg:col-span-7 space-y-6">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <input type="hidden" id="editModeId">
                
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-black flex items-center gap-3">
                        <span class="bg-black text-white px-3 py-1 rounded text-xl">Marketing Pro</span>
                        ×¢×•×¨×š ×§×˜×œ×•×’
                    </h1>
                    <button id="btnCancel" onclick="resetForm()" class="hidden text-red-500 font-bold">×‘×™×˜×•×œ</button>
                </div>

                <div class="flex gap-2 mb-8">
                    <input type="text" id="searchInput" placeholder="×©× ××•×¦×¨..." class="flex-1 p-4 border-2 border-black rounded-xl text-xl font-bold">
                    <button onclick="runAI()" class="bg-[#E3000F] text-white px-8 rounded-xl font-bold text-lg hover:bg-red-700 shadow-lg flex items-center gap-2">
                        <i data-lucide="sparkles"></i> AI Auto-Fill
                    </button>
                </div>

                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label">×©× ××•×¦×¨</label>
                            <input id="pName" oninput="updatePreview()" class="input-field w-full p-2 border rounded">
                        </div>
                        <div>
                            <label class="label">××•×ª×’</label>
                            <input id="pBrand" oninput="updatePreview()" class="input-field w-full p-2 border rounded">
                        </div>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <h3 class="font-bold text-blue-900 mb-2 flex items-center gap-2"><i data-lucide="megaphone"></i> ×”×’×“×¨×•×ª ×©×™×•×•×§</h3>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-blue-800">×¡×˜×˜×•×¡ ××•×¦×¨ (×¡×¨×˜ ×¦×“)</label>
                            <select id="pStatus" onchange="updatePreview()" class="w-full p-2 rounded border border-blue-200 text-sm">
                                <option value="standard">×¨×’×™×œ</option>
                                <option value="recommended">â­ ××•××œ×¥ (×¦×”×•×‘)</option>
                                <option value="sale">ğŸ·ï¸ ××‘×¦×¢ (××“×•×)</option>
                                <option value="new">âœ¨ ×—×“×© (×›×—×•×œ)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-blue-800">×˜×§×¡×˜ ×›×¤×ª×•×¨ (CTA)</label>
                            <input id="pCta" oninput="updatePreview()" class="w-full p-2 rounded border border-blue-200 text-sm" placeholder="×”×•×¡×£ ×œ×”×¦×¢×ª ××—×™×¨">
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs font-bold text-blue-800">×ª×™××•×¨ ×©×™×•×•×§×™ (×”× ×¢×” ×œ×¤×¢×•×œ×”)</label>
                            <textarea id="pMarketing" oninput="updatePreview()" rows="2" class="w-full p-2 rounded border border-blue-200 text-sm"></textarea>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-blue-800">×ª×§×Ÿ (×˜×§×¡×˜)</label>
                            <input id="pStandard" oninput="updatePreview()" class="w-full p-2 rounded border border-blue-200 text-sm" placeholder="×œ××©×œ: ×ª×§×Ÿ 118">
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-end mb-2">
                            <label class="font-bold">×’×œ×¨×™×™×ª ×ª××•× ×•×ª (×‘×—×¨ ××—×ª ××• ×™×•×ª×¨)</label>
                            <button onclick="refreshImages()" class="text-xs text-blue-600 font-bold hover:underline">ğŸ”„ ×—×¤×© ×ª××•× ×•×ª ××—×¨×•×ª</button>
                        </div>
                        <div id="imageGallery" class="selection-grid bg-gray-50 p-2 rounded-lg min-h-[100px]"></div>
                        <input type="hidden" id="pImagesJson"> 
                    </div>

                    <div class="grid grid-cols-3 gap-2">
                        <input id="pCoverage" oninput="updatePreview()" placeholder="×›×™×¡×•×™" class="p-2 border rounded text-sm">
                        <input id="pDrying" oninput="updatePreview()" placeholder="×™×™×‘×•×©" class="p-2 border rounded text-sm">
                        <input id="pThickness" oninput="updatePreview()" placeholder="×¢×•×‘×™" class="p-2 border rounded text-sm">
                    </div>
                    
                    <textarea id="pSpecs" class="hidden"></textarea> <input id="pVideoUrl" type="hidden"> 
                    <input id="pPdf" type="hidden">

                    <button onclick="saveProduct()" class="w-full bg-black text-white py-4 rounded-xl font-bold text-xl hover:bg-gray-800 shadow-xl">
                        <i data-lucide="save"></i> ×©××•×¨ ××•×¦×¨
                    </button>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow p-6">
                <h2 class="font-bold mb-4">× ×™×”×•×œ ××œ××™</h2>
                <div id="inventoryTable" class="space-y-2"></div>
            </div>
        </div>

        <div class="col-span-12 lg:col-span-5 relative">
            <div class="sticky top-10">
                <div class="text-center mb-4 font-bold text-gray-400">×ª×¦×•×’×” ×—×™×” ×‘×§×™×•×¡×§</div>
                
                <div class="kiosk-card relative">
                    <div class="brand-logo" id="prevLogoBox">
                        <img id="prevLogo" src="https://via.placeholder.com/50">
                    </div>
                    
                    <div id="prevRibbon" class="ribbon hidden">××•××œ×¥</div>

                    <div class="media-area">
                        <img id="prevImage" src="https://via.placeholder.com/300?text=Sika">
                    </div>

                    <div class="content-area">
                        <div>
                            <div class="flex justify-between items-start">
                                <div>
                                    <h2 id="prevName" class="text-3xl font-black leading-none mb-1">×©× ××•×¦×¨</h2>
                                    <div id="prevBrand" class="text-sm font-bold text-gray-500">SIKA</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100 text-sm text-gray-800 italic" id="prevMarketing">
                            ×ª×™××•×¨ ×©×™×•×•×§×™ ××©×›× ×¢ ×™×•×¤×™×¢ ×›××Ÿ...
                        </div>

                        <div class="tech-grid">
                            <div class="tech-item">
                                <i data-lucide="maximize" class="mx-auto text-red-500 mb-1" size="16"></i>
                                <div class="tech-val" id="prevCov">-</div>
                                <div class="tech-lbl">×›×™×¡×•×™ ×œ×"×¨</div>
                            </div>
                            <div class="tech-item">
                                <i data-lucide="clock" class="mx-auto text-red-500 mb-1" size="16"></i>
                                <div class="tech-val" id="prevDry">-</div>
                                <div class="tech-lbl">×–××Ÿ ×™×™×‘×•×©</div>
                            </div>
                            <div class="tech-item">
                                <i data-lucide="layers" class="mx-auto text-red-500 mb-1" size="16"></i>
                                <div class="tech-val" id="prevThick">-</div>
                                <div class="tech-lbl">×¢×•×‘×™ ×™×™×©×•×</div>
                            </div>
                        </div>

                        <div id="prevStandardBox" class="flex items-center gap-2 text-xs text-green-700 bg-green-50 p-2 rounded border border-green-100 hidden">
                            <i data-lucide="shield-check" size="14"></i>
                            <span id="prevStandard">×¢×•××“ ×‘×ª×§×Ÿ ×™×©×¨××œ×™</span>
                        </div>

                        <div class="mt-auto">
                            <button id="prevBtn" class="w-full bg-[#E3000F] text-white py-4 rounded-xl font-black text-lg shadow-md flex justify-center items-center gap-2">
                                ×”×•×¡×£ ×œ×”×¦×¢×ª ××—×™×¨ <i data-lucide="arrow-left"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { askGeminiAdmin, searchImages, searchVideos } from '../js/gemini-service.js';

        lucide.createIcons();
        let selectedImages = []; // ××¢×¨×š ×ª××•× ×•×ª × ×‘×—×¨×•×ª
        let allProducts = [];

        // ×œ×•×’×•××™× ×‘×¡×™×¡×™×™× (Hardcoded ×œ×—×•×•×™×” ××”×™×¨×”)
        const brandLogos = {
            'sika': 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/62/Sika_AG_logo.svg/1200px-Sika_AG_logo.svg.png',
            'misterfix': 'https://karmit-mrfix.com/wp-content/uploads/2020/07/logo.png',
            'thermokir': 'https://www.thermokir.co.il/wp-content/uploads/2019/06/logo.png',
            'default': 'https://cdn-icons-png.flaticon.com/512/1088/1088537.png'
        };

        window.updatePreview = () => {
            const name = document.getElementById('pName').value;
            const brand = document.getElementById('pBrand').value;
            const status = document.getElementById('pStatus').value;
            const cta = document.getElementById('pCta').value;
            const marketing = document.getElementById('pMarketing').value;
            const standard = document.getElementById('pStandard').value;

            document.getElementById('prevName').innerText = name || "×©× ××•×¦×¨";
            document.getElementById('prevBrand').innerText = (brand || "BRAND").toUpperCase();
            document.getElementById('prevMarketing').innerText = marketing || "×ª×™××•×¨ ×©×™×•×•×§×™...";
            document.getElementById('prevBtn').innerText = cta || "×”×•×¡×£ ×œ×”×¦×¢×ª ××—×™×¨";
            
            // ×¢×“×›×•×Ÿ ×œ×•×’×•
            const brandKey = Object.keys(brandLogos).find(k => (brand||"").toLowerCase().includes(k)) || 'default';
            document.getElementById('prevLogo').src = brandLogos[brandKey];

            // ×¢×“×›×•×Ÿ ×¡×¨×˜ ×¦×“
            const ribbon = document.getElementById('prevRibbon');
            ribbon.className = `ribbon ${status}`;
            ribbon.classList.toggle('hidden', status === 'standard');
            const statusText = { 'recommended': '××•××œ×¥', 'sale': '××‘×¦×¢', 'new': '×—×“×©' };
            ribbon.innerText = statusText[status] || '';

            // ×¢×“×›×•×Ÿ ×ª××•× ×” ×¨××©×™×ª
            if(selectedImages.length > 0) {
                document.getElementById('prevImage').src = selectedImages[0];
            }

            // ×¢×“×›×•×Ÿ ×˜×›× ×™
            document.getElementById('prevCov').innerText = document.getElementById('pCoverage').value || "-";
            document.getElementById('prevDry').innerText = document.getElementById('pDrying').value || "-";
            document.getElementById('prevThick').innerText = document.getElementById('pThickness').value || "-";

            // ×ª×§×Ÿ
            document.getElementById('prevStandardBox').classList.toggle('hidden', !standard);
            document.getElementById('prevStandard').innerText = standard;
        }

        window.runAI = async () => {
            const query = document.getElementById('searchInput').value;
            if(!query) return;
            
            const btn = document.querySelector('button[onclick="runAI()"]');
            btn.innerHTML = `â³ ×—×•×©×‘...`;
            
            const [data, images] = await Promise.all([
                askGeminiAdmin(query),
                searchImages(query)
            ]);

            if(data) {
                document.getElementById('pName').value = data.name;
                document.getElementById('pBrand').value = data.brand;
                document.getElementById('pMarketing').value = data.marketingDesc;
                document.getElementById('pStatus').value = data.status || 'standard';
                document.getElementById('pCta').value = data.ctaText || "×”×•×¡×£ ×œ×”×¦×¢×ª ××—×™×¨";
                document.getElementById('pStandard').value = data.standard || "";
                
                if(data.tech) {
                    document.getElementById('pCoverage').value = data.tech.coverage;
                    document.getElementById('pDrying').value = data.tech.drying;
                    document.getElementById('pThickness').value = data.tech.thickness;
                }
                
                // ×©××™×¨×ª JSON ××œ× ×©×œ ××¤×¨×˜ ×œ×©×™××•×© ×¢×ª×™×“×™
                document.getElementById('pSpecs').value = JSON.stringify(data.specs || []);
            }

            renderGallery(images);
            btn.innerHTML = `<i data-lucide="sparkles"></i> AI Auto-Fill`;
            updatePreview();
        };

        window.refreshImages = async () => {
            const query = document.getElementById('pName').value || document.getElementById('searchInput').value;
            const images = await searchImages(query + " product packaging"); // ×—×™×¤×•×© ×××•×§×“ ××¨×™×–×”
            renderGallery(images);
        }

        function renderGallery(images) {
            const container = document.getElementById('imageGallery');
            selectedImages = []; // ××™×¤×•×¡ ×‘×—×™×¨×”
            container.innerHTML = images.map(url => `
                <div class="selectable-item" onclick="toggleImage('${url}', this)">
                    <img src="${url}" class="w-full h-full object-contain">
                    <div class="check-mark"><i data-lucide="check" size="12"></i></div>
                </div>
            `).join('');
            
            // ×‘×—×™×¨×” ××•×˜×•××˜×™×ª ×©×œ ×”×¨××©×•×Ÿ
            if(images.length) toggleImage(images[0], container.children[0]);
        }

        window.toggleImage = (url, el) => {
            // ×œ×•×’×™×§×” ×œ×‘×—×™×¨×” ××¨×•×‘×” (×× × ×¨×¦×” ×‘×¢×ª×™×“) ××• ×™×—×™×“×”
            // ×›×¨×’×¢ × ××©×© ×‘×—×™×¨×” ×™×—×™×“×” ×›×“×™ ×œ× ×œ×¡×‘×š, ××‘×œ × ×©××•×¨ ×‘××¢×¨×š
            selectedImages = [url]; 
            
            // ×•×™×–×•××œ×™×–×¦×™×”
            document.querySelectorAll('.selectable-item').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            
            document.getElementById('pImagesJson').value = JSON.stringify(selectedImages);
            updatePreview();
        }

        window.saveProduct = async () => {
            const data = {
                name: document.getElementById('pName').value,
                brand: document.getElementById('pBrand').value,
                status: document.getElementById('pStatus').value,
                marketingDesc: document.getElementById('pMarketing').value,
                ctaText: document.getElementById('pCta').value,
                standard: document.getElementById('pStandard').value,
                // ×©×•××¨ ××ª ×”××¢×¨×š ×©×œ ×”×ª××•× ×•×ª (×’× ×× ×™×© ××—×ª)
                images: selectedImages,
                // ×ª××™×›×” ×œ××—×•×¨ ×‘×§×•×“ ×”×™×©×Ÿ ×©××¦×¤×” ×œ-image ×‘×•×“×“
                image: selectedImages[0] || "", 
                coverage: document.getElementById('pCoverage').value,
                drying: document.getElementById('pDrying').value,
                thickness: document.getElementById('pThickness').value,
                specs: JSON.parse(document.getElementById('pSpecs').value || "[]"),
                updatedAt: new Date()
            };

            const editId = document.getElementById('editModeId').value;
            if(editId) {
                await updateDoc(doc(db, "products", editId), data);
            } else {
                data.createdAt = new Date();
                await addDoc(collection(db, "products"), data);
            }
            alert("×”××•×¦×¨ × ×©××¨ ×‘×”×¦×œ×—×”!");
            loadInventory();
            resetForm();
        }

        // --- × ×™×”×•×œ ××œ××™ (×˜×¢×™× ×” ×¤×©×•×˜×”) ---
        window.loadInventory = async () => {
            const container = document.getElementById('inventoryTable');
            const snap = await getDocs(collection(db, "products"));
            container.innerHTML = "";
            snap.forEach(doc => {
                const p = doc.data();
                container.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded border">
                        <div class="flex items-center gap-3">
                            <img src="${p.image}" class="w-8 h-8 object-contain">
                            <span class="font-bold">${p.name}</span>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="editProduct('${doc.id}')" class="text-blue-600 font-bold text-xs">×¢×¨×•×š</button>
                             <button onclick="deleteProduct('${doc.id}')" class="text-red-600 font-bold text-xs">××—×§</button>
                        </div>
                    </div>`;
                allProducts.push({id: doc.id, ...p});
            });
        }
        
        window.editProduct = (id) => {
            const p = allProducts.find(x => x.id === id);
            if(!p) return;
            document.getElementById('editModeId').value = id;
            document.getElementById('pName').value = p.name;
            document.getElementById('pBrand').value = p.brand;
            document.getElementById('pStatus').value = p.status || 'standard';
            document.getElementById('pMarketing').value = p.marketingDesc || "";
            document.getElementById('pStandard').value = p.standard || "";
            document.getElementById('pCta').value = p.ctaText || "";
            document.getElementById('pCoverage').value = p.coverage || "";
            document.getElementById('pDrying').value = p.drying || "";
            document.getElementById('pThickness').value = p.thickness || "";
            
            // ×˜×¢×™× ×ª ×ª××•× ×•×ª
            selectedImages = p.images || [p.image];
            renderGallery(selectedImages); // ××¦×™×’ ×¨×§ ××ª ××” ×©×™×© ×›×¨×’×¢
            
            updatePreview();
        }

        window.deleteProduct = async (id) => {
            if(confirm("×œ××—×•×§?")) {
                await deleteDoc(doc(db, "products", id));
                loadInventory();
            }
        }

        window.resetForm = () => {
            document.getElementById('editModeId').value = "";
            document.querySelectorAll('input').forEach(i => i.value = "");
            updatePreview();
        }

        loadInventory();
    </script>
</body>
</html>
