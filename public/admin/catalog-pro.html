<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Sika Admin - Ultimate Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background: #f3f4f6; }
        
        /* ×¢×™×¦×•×‘ ×›×¨×˜×™×¡ ×”×§×™×•×¡×§ */
        .kiosk-card {
            background: white; border-radius: 20px; overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15); display: flex; flex-direction: column;
            height: 720px; width: 380px; margin: 0 auto; position: sticky; top: 20px;
            border: 1px solid #e2e8f0;
        }
        .media-area { height: 35%; background: #f8fafc; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .media-area img { max-height: 90%; max-width: 90%; object-fit: contain; mix-blend-mode: multiply; }
        .ribbon { position: absolute; top: 20px; left: -30px; transform: rotate(-45deg); color: white; padding: 5px 40px; font-weight: 900; font-size: 0.8rem; box-shadow: 0 5px 10px rgba(0,0,0,0.2); z-index: 10; text-transform: uppercase; }
        .ribbon.sale { background: #E3000F; } 
        .ribbon.recommended { background: #FFC500; color: black; }
        .ribbon.new { background: #2563eb; }
        .brand-logo { position: absolute; top: 15px; right: 15px; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 5; background: white; }
        .brand-logo img { width: 80%; }
        .content-area { padding: 25px; flex: 1; display: flex; flex-direction: column; gap: 10px; }
        
        /* ×’×œ×¨×™×•×ª */
        .selection-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .selectable-item { border: 3px solid transparent; border-radius: 8px; overflow: hidden; cursor: pointer; opacity: 0.8; transition: all 0.2s; position: relative; height: 60px; background: #f1f5f9; }
        .selectable-item:hover { opacity: 1; transform: scale(1.02); }
        .selectable-item.selected { border-color: #22c55e; opacity: 1; box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.3); }
        .check-mark { position: absolute; top: 2px; right: 2px; background: #22c55e; color: white; border-radius: 50%; padding: 2px; display: none; }
        .selected .check-mark { display: block; }

        /* × ×ª×•× ×™× ×˜×›× ×™×™× */
        .tech-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; background: #f8fafc; padding: 10px; border-radius: 12px; margin-top: 5px; }
        .tech-item { text-align: center; }
        .tech-val { font-weight: 900; font-size: 0.85rem; color: #0f172a; }
        .tech-lbl { font-size: 0.65rem; color: #64748b; font-weight: bold; }

        /* ×›×¤×ª×•×¨×™ AI ×§×˜× ×™× */
        .ai-btn-small { 
            position: absolute; left: 8px; top: 50%; transform: translateY(-50%);
            background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0;
            padding: 4px; border-radius: 6px; cursor: pointer; transition: all 0.2s; z-index: 10;
        }
        .ai-btn-small:hover { background: #16a34a; color: white; }
        
        /* ××–×•×¨ ×˜×§×¡×˜ ×¢× ×›×¤×ª×•×¨ */
        .textarea-wrapper .ai-btn-small { top: 15px; transform: none; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-[1600px] mx-auto grid grid-cols-12 gap-8">
        
        <div class="col-span-12 lg:col-span-7 space-y-6">
            
            <div class="bg-gray-800 text-white p-4 rounded-xl flex justify-between items-center shadow-lg">
                <div>
                    <h3 class="font-bold text-lg"><i data-lucide="upload-cloud"></i> ×™×‘×•× × ×ª×•× ×™× (Scraper)</h3>
                    <p class="text-xs text-gray-400">×˜×¢×Ÿ ×§×•×‘×¥ JSON ×©×—×•×œ×¥ ××”××ª×¨</p>
                </div>
                <div class="flex gap-3">
                    <input type="file" id="jsonFile" accept=".json" class="hidden" onchange="handleBulkUpload(this)">
                    <button onclick="document.getElementById('jsonFile').click()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2">
                        <i data-lucide="file-json"></i> ×˜×¢×Ÿ JSON
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                <input type="hidden" id="editModeId">
                
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-black flex items-center gap-3">
                        <span class="bg-black text-white px-3 py-1 rounded text-xl">Sika Admin</span>
                        ×¢×•×¨×š ××•×¦×¨×™×
                    </h1>
                    <button id="btnCancel" onclick="resetForm()" class="hidden text-red-500 font-bold bg-red-50 px-3 py-1 rounded hover:bg-red-100">×‘×™×˜×•×œ</button>
                </div>

                <div class="bg-green-50 p-4 rounded-xl border border-green-200 mb-6 flex items-center justify-between">
                    <div>
                        <h4 class="font-bold text-green-900">×”×©×‘×—×” ××•×˜×•××˜×™×ª (AI)</h4>
                        <p class="text-xs text-green-700">×××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×¨×™×§×™× ××‘×œ×™ ×œ×“×¨×•×¡ ××™×“×¢ ×§×™×™×</p>
                    </div>
                    <button onclick="runGlobalAI()" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-green-700 shadow-md flex items-center gap-2">
                        <i data-lucide="sparkles"></i> ×”×©×œ× ×”×›×œ
                    </button>
                </div>

                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="relative">
                            <label class="text-xs font-bold text-gray-500 uppercase">×©× ××•×¦×¨</label>
                            <input id="pName" oninput="updatePreview()" class="w-full p-3 bg-gray-50 border rounded-lg font-bold">
                        </div>
                        <div class="relative">
                            <label class="text-xs font-bold text-gray-500 uppercase">××•×ª×’</label>
                            <input id="pBrand" oninput="updatePreview()" class="w-full p-3 bg-gray-50 border rounded-lg font-bold">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        <div class="bg-gray-50 p-4 rounded-xl border relative">
                            <label class="font-bold flex justify-between mb-2">
                                <span><i data-lucide="image"></i> ×ª××•× ×” ×¨××©×™×ª</span>
                            </label>
                            <input type="text" id="pImageUrl" oninput="updatePreview()" placeholder="×”×“×‘×§ ×œ×™× ×§ ×œ×ª××•× ×”..." class="w-full p-2 mb-2 border rounded text-sm text-blue-600 font-mono pr-10">
                            <div id="imageGallery" class="selection-grid min-h-[50px]"></div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-xl border relative">
                            <label class="font-bold flex justify-between mb-2">
                                <span><i data-lucide="video"></i> ×¡×¨×˜×•×Ÿ (YouTube)</span>
                            </label>
                            <input type="text" id="pVideoUrl" oninput="updatePreview()" placeholder="×”×“×‘×§ ×œ×™× ×§ ×œ×™×•×˜×™×•×‘..." class="w-full p-2 mb-2 border rounded text-sm text-red-600 font-mono pr-10">
                            <div id="videoGallery" class="selection-grid min-h-[0px]"></div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-xl border relative">
                            <label class="font-bold flex justify-between mb-2">
                                <span><i data-lucide="file-text"></i> ××¤×¨×˜ ×™×¦×¨×Ÿ (PDF)</span>
                            </label>
                            <input type="text" id="pPdfUrl" oninput="updatePreview()" placeholder="×”×“×‘×§ ×œ×™× ×§ ×œ×§×•×‘×¥ PDF..." class="w-full p-2 border rounded text-sm text-gray-600 font-mono">
                        </div>
                    </div>

                    <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 grid grid-cols-2 gap-4 relative">
                        <div class="col-span-2 font-bold text-blue-900 mb-1 flex items-center gap-2">
                            <i data-lucide="megaphone"></i> ×ª×•×›×Ÿ ×©×™×•×•×§×™
                        </div>
                        
                        <div>
                            <label class="text-xs font-bold text-blue-800">×¡×˜×˜×•×¡</label>
                            <select id="pStatus" onchange="updatePreview()" class="w-full p-2 rounded border border-blue-200 text-sm">
                                <option value="standard">×¨×’×™×œ</option>
                                <option value="recommended">â­ ××•××œ×¥</option>
                                <option value="sale">ğŸ·ï¸ ××‘×¦×¢</option>
                                <option value="new">âœ¨ ×—×“×©</option>
                            </select>
                        </div>
                        <div class="relative">
                            <label class="text-xs font-bold text-blue-800">×›×¤×ª×•×¨ (CTA)</label>
                            <input id="pCta" oninput="updatePreview()" class="w-full p-2 rounded border border-blue-200 text-sm pl-8" placeholder="×“×•×¨×© ×”×©×‘×—×ª AI">
                            <button onclick="fillField('pCta')" class="ai-btn-small" title="××œ× ×©×“×” ×–×” ×‘×œ×‘×“"><i data-lucide="sparkles" size="14"></i></button>
                        </div>
                        <div class="col-span-2 relative textarea-wrapper">
                            <label class="text-xs font-bold text-blue-800">×ª×™××•×¨ ×©×™×•×•×§×™</label>
                            <textarea id="pMarketing" oninput="updatePreview()" rows="2" class="w-full p-2 rounded border border-blue-200 text-sm pl-8" placeholder="×“×•×¨×© ×”×©×‘×—×ª AI..."></textarea>
                            <button onclick="fillField('pMarketing')" class="ai-btn-small" title="×›×ª×•×‘ ×ª×™××•×¨ ×©×™×•×•×§×™"><i data-lucide="sparkles" size="14"></i></button>
                        </div>
                        <div class="col-span-2 relative">
                            <label class="text-xs font-bold text-blue-800">×ª×§×Ÿ</label>
                            <input id="pStandard" oninput="updatePreview()" class="w-full p-2 rounded border border-blue-200 text-sm pl-8" placeholder="×“×•×¨×© ×”×©×‘×—×ª AI">
                            <button onclick="fillField('pStandard')" class="ai-btn-small" title="××¦× ×ª×§×Ÿ"><i data-lucide="sparkles" size="14"></i></button>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <label class="font-bold text-sm mb-2 block flex gap-2"><i data-lucide="ruler"></i> ××¤×¨×˜ ×˜×›× ×™</label>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="relative">
                                <input id="pCoverage" oninput="updatePreview()" placeholder="×›×™×¡×•×™ (×œ×''×¨)" class="p-2 border rounded text-sm w-full pl-8">
                                <button onclick="fillField('pCoverage')" class="ai-btn-small" title="×—×©×‘ ×›×™×¡×•×™"><i data-lucide="sparkles" size="14"></i></button>
                            </div>
                            <div class="relative">
                                <input id="pDrying" oninput="updatePreview()" placeholder="×–××Ÿ ×™×™×‘×•×©" class="p-2 border rounded text-sm w-full pl-8">
                                <button onclick="fillField('pDrying')" class="ai-btn-small" title="××¦× ×–××Ÿ ×™×™×‘×•×©"><i data-lucide="sparkles" size="14"></i></button>
                            </div>
                            <div class="relative">
                                <input id="pThickness" oninput="updatePreview()" placeholder="×¢×•×‘×™ ×™×™×©×•×" class="p-2 border rounded text-sm w-full pl-8">
                                <button onclick="fillField('pThickness')" class="ai-btn-small" title="××¦× ×¢×•×‘×™"><i data-lucide="sparkles" size="14"></i></button>
                            </div>
                        </div>
                    </div>
                    
                    <textarea id="pSpecs" class="hidden"></textarea> 
                    <input type="hidden" id="pImagesJson">

                    <button onclick="saveProduct()" class="w-full bg-black text-white py-4 rounded-xl font-bold text-xl hover:bg-gray-800 shadow-xl flex justify-center gap-2 mt-4">
                        <i data-lucide="save"></i> ×©××•×¨ ×©×™× ×•×™×™×
                    </button>
                </div>
            </div>
            
            <div class="bg-white rounded-2xl shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-xl"><i data-lucide="package"></i> × ×™×”×•×œ ××œ××™</h2>
                    <button onclick="loadInventory()" class="text-xs bg-gray-100 p-2 rounded"><i data-lucide="refresh-cw"></i></button>
                </div>
                <div id="inventoryTable" class="space-y-2 max-h-[500px] overflow-y-auto pr-2"></div>
            </div>
        </div>

        <div class="col-span-12 lg:col-span-5 relative hidden lg:block">
            <div class="sticky top-10">
                <div class="text-center mb-4 font-bold text-gray-400 text-sm tracking-widest">LIVE PREVIEW</div>
                <div class="kiosk-card relative">
                    <div class="brand-logo"><img id="prevLogo" src=""></div>
                    <div id="prevRibbon" class="ribbon hidden"></div>
                    <div class="media-area">
                        <img id="prevImage" src="https://via.placeholder.com/300?text=Sika">
                        <div id="prevVideoBadge" class="absolute bottom-4 left-4 bg-red-600 text-white p-2 rounded-full hidden shadow-lg animate-pulse"><i data-lucide="play" size="20"></i></div>
                    </div>
                    <div class="content-area">
                        <div>
                            <div id="prevBrand" class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">SIKA</div>
                            <h2 id="prevName" class="text-3xl font-black leading-none mb-1 text-gray-800">×©× ××•×¦×¨</h2>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100 text-sm text-gray-800 italic leading-relaxed" id="prevMarketing">×ª×™××•×¨...</div>
                        <div class="tech-grid">
                            <div class="tech-item"><i data-lucide="maximize" class="mx-auto text-red-500 mb-1" size="16"></i><div class="tech-val" id="prevCov">-</div><div class="tech-lbl">×›×™×¡×•×™ ×œ×"×¨</div></div>
                            <div class="tech-item"><i data-lucide="clock" class="mx-auto text-red-500 mb-1" size="16"></i><div class="tech-val" id="prevDry">-</div><div class="tech-lbl">×–××Ÿ ×™×™×‘×•×©</div></div>
                            <div class="tech-item"><i data-lucide="layers" class="mx-auto text-red-500 mb-1" size="16"></i><div class="tech-val" id="prevThick">-</div><div class="tech-lbl">×¢×•×‘×™ ×™×™×©×•×</div></div>
                        </div>
                        
                        <div id="prevPdfBox" class="hidden mt-2">
                             <a href="#" class="block w-full bg-gray-100 text-gray-600 text-center py-2 rounded text-xs font-bold border border-gray-200 flex items-center justify-center gap-2">
                                <i data-lucide="file-text" size="14"></i> ××¤×¨×˜ ×™×¦×¨×Ÿ (PDF)
                             </a>
                        </div>

                        <div id="prevStandardBox" class="flex items-center gap-2 text-xs text-green-700 bg-green-50 p-2 rounded border border-green-100 hidden mt-2">
                            <i data-lucide="shield-check" size="14"></i><span id="prevStandard"></span>
                        </div>
                        <div class="mt-auto">
                            <button id="prevBtn" class="w-full bg-[#E3000F] text-white py-4 rounded-xl font-black text-lg shadow-md flex justify-center items-center gap-2">×”×•×¡×£ ×œ×”×¦×¢×ª ××—×™×¨ <i data-lucide="arrow-left"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { askGeminiAdmin, searchImages, searchVideos } from '../js/gemini-service.js';

        lucide.createIcons();
        let selectedImages = []; 
        let allProducts = [];

        const brandLogos = {
            'sika': 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/62/Sika_AG_logo.svg/1200px-Sika_AG_logo.svg.png',
            'misterfix': 'https://karmit-mrfix.com/wp-content/uploads/2020/07/logo.png',
            'thermokir': 'https://www.thermokir.co.il/wp-content/uploads/2019/06/logo.png',
            'default': 'https://cdn-icons-png.flaticon.com/512/1088/1088537.png'
        };

        window.updatePreview = () => {
            const getVal = (id) => document.getElementById(id).value;
            
            document.getElementById('prevName').innerText = getVal('pName') || "×©× ××•×¦×¨";
            document.getElementById('prevBrand').innerText = (getVal('pBrand') || "BRAND").toUpperCase();
            document.getElementById('prevMarketing').innerText = getVal('pMarketing') || "×ª×™××•×¨ ×©×™×•×•×§×™...";
            document.getElementById('prevBtn').innerHTML = `${getVal('pCta') || "×”×•×¡×£ ×œ×”×¦×¢×ª ××—×™×¨"} <i data-lucide="arrow-left"></i>`;
            
            // ×œ×•×’×•
            const brandKey = Object.keys(brandLogos).find(k => (getVal('pBrand')||"").toLowerCase().includes(k)) || 'default';
            document.getElementById('prevLogo').src = brandLogos[brandKey];

            // ×¨×™×‘×•×Ÿ
            const status = getVal('pStatus');
            const ribbon = document.getElementById('prevRibbon');
            ribbon.className = `ribbon ${status}`;
            ribbon.classList.toggle('hidden', status === 'standard');
            ribbon.innerText = { 'recommended': '××•××œ×¥', 'sale': '××‘×¦×¢', 'new': '×—×“×©' }[status] || '';

            // ×ª××•× ×”: ×§×“×™××•×ª ×œ×”×“×‘×§×” ×™×“× ×™×ª
            const manualImg = getVal('pImageUrl');
            if(manualImg && manualImg.length > 5) {
                document.getElementById('prevImage').src = manualImg;
            } else if(selectedImages.length > 0) {
                document.getElementById('prevImage').src = selectedImages[0];
            }

            // ×•×™×“××•
            document.getElementById('prevVideoBadge').classList.toggle('hidden', !getVal('pVideoUrl'));

            // PDF
            document.getElementById('prevPdfBox').classList.toggle('hidden', !getVal('pPdfUrl'));

            // ×˜×›× ×™
            document.getElementById('prevCov').innerText = getVal('pCoverage') || "-";
            document.getElementById('prevDry').innerText = getVal('pDrying') || "-";
            document.getElementById('prevThick').innerText = getVal('pThickness') || "-";

            // ×ª×§×Ÿ
            const std = getVal('pStandard');
            document.getElementById('prevStandardBox').classList.toggle('hidden', !std);
            document.getElementById('prevStandard').innerText = std;
            
            lucide.createIcons();
        }

        // --- ×¤×•× ×§×¦×™×™×ª ×”×¢×œ ×œ×”×©×‘×—×” ×’×œ×•×‘×œ×™×ª (×œ×œ× ×“×¨×™×¡×”) ---
        window.runGlobalAI = async () => {
            const name = document.getElementById('pName').value;
            if(!name) return alert("×”×›× ×¡ ×©× ××•×¦×¨");
            
            const btn = document.querySelector('button[onclick="runGlobalAI()"]');
            const original = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin"></i> ×¢×•×‘×“...`;
            lucide.createIcons();

            try {
                // ×§×¨×™××” ×œ-AI
                const [data] = await Promise.all([askGeminiAdmin(name)]);
                
                if(data) {
                    // ×¤×•× ×§×¦×™×™×ª ××™×œ×•×™ ×‘×˜×•×—×”: ×××œ××ª ×¨×§ ×× ×”×©×“×” ×¨×™×§!
                    const smartFill = (id, val) => {
                        const el = document.getElementById(id);
                        if (!el.value && val) {
                            el.value = val;
                            el.style.backgroundColor = "#f0fdf4"; // ×¡×™××•×Ÿ ×™×¨×•×§ ×œ××” ×©××•×œ×
                            setTimeout(() => el.style.backgroundColor = "", 1500);
                        }
                    };

                    smartFill('pMarketing', data.marketingDesc);
                    smartFill('pCta', data.ctaText);
                    smartFill('pStandard', data.standard);
                    smartFill('pCoverage', data.tech?.coverage);
                    smartFill('pDrying', data.tech?.drying);
                    smartFill('pThickness', data.tech?.thickness);
                    
                    // ××¤×¨×˜ JSON ×××œ××™× ×¨×§ ×× ×¨×™×§ ×œ×—×œ×•×˜×™×Ÿ
                    if(!document.getElementById('pSpecs').value) {
                         document.getElementById('pSpecs').value = JSON.stringify(data.specs || []);
                    }
                }
            } catch(e) {
                console.error(e);
                alert("×©×’×™××” ×‘×ª×§×©×•×¨×ª");
            }

            btn.innerHTML = original;
            updatePreview();
            lucide.createIcons();
        };

        // --- ××™×œ×•×™ ×©×“×” ×‘×•×“×“ (Targeted) ---
        window.fillField = async (fieldId) => {
            const name = document.getElementById('pName').value;
            if(!name) return alert("×”×›× ×¡ ×©× ××•×¦×¨ ×§×•×“×");
            
            const btn = event.currentTarget;
            const originalIcon = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin" size="14"></i>`;
            lucide.createIcons();

            try {
                const data = await askGeminiAdmin(name);
                if(data) {
                    const map = {
                        'pMarketing': data.marketingDesc,
                        'pCta': data.ctaText,
                        'pStandard': data.standard,
                        'pCoverage': data.tech?.coverage,
                        'pDrying': data.tech?.drying,
                        'pThickness': data.tech?.thickness
                    };
                    
                    if(map[fieldId]) {
                        document.getElementById(fieldId).value = map[fieldId];
                        document.getElementById(fieldId).style.backgroundColor = "#f0fdf4";
                        setTimeout(() => document.getElementById(fieldId).style.backgroundColor = "", 1000);
                    } else {
                        alert("×œ× × ××¦× ××™×“×¢ ×¡×¤×¦×™×¤×™ ×œ× ×ª×•×Ÿ ×–×”");
                    }
                }
            } catch(e) { console.error(e); }
            
            btn.innerHTML = originalIcon;
            updatePreview();
            lucide.createIcons();
        }

        // --- ×©××™×¨×” ---
        window.saveProduct = async () => {
            const btn = document.querySelector('button[onclick="saveProduct()"]');
            btn.innerHTML = `×©×•××¨...`;
            
            try {
                const data = {
                    name: document.getElementById('pName').value,
                    brand: document.getElementById('pBrand').value,
                    status: document.getElementById('pStatus').value,
                    marketingDesc: document.getElementById('pMarketing').value,
                    ctaText: document.getElementById('pCta').value,
                    standard: document.getElementById('pStandard').value,
                    image: document.getElementById('pImageUrl').value,
                    images: selectedImages.length ? selectedImages : [document.getElementById('pImageUrl').value],
                    video: document.getElementById('pVideoUrl').value,
                    pdfUrl: document.getElementById('pPdfUrl').value,
                    coverage: document.getElementById('pCoverage').value,
                    drying: document.getElementById('pDrying').value,
                    thickness: document.getElementById('pThickness').value,
                    specs: JSON.parse(document.getElementById('pSpecs').value || "[]"),
                    updatedAt: new Date()
                };

                const editId = document.getElementById('editModeId').value;
                if(editId) {
                    await updateDoc(doc(db, "products", editId), data);
                } else {
                    data.createdAt = new Date();
                    await addDoc(collection(db, "products"), data);
                }
                
                alert("âœ… × ×©××¨!");
                loadInventory();
                resetForm();

            } catch (e) { alert("×©×’×™××”: " + e.message); }
            btn.innerHTML = `<i data-lucide="save"></i> ×©××•×¨ ×©×™× ×•×™×™×`;
            lucide.createIcons();
        }

        // --- ×™×‘×•× ×•×©××¨ ×”×¤×•× ×§×¦×™×•×ª ---
        window.handleBulkUpload = async (input) => {
             const file = input.files[0];
             if (!file) return;
             const reader = new FileReader();
             reader.onload = async (e) => {
                 const json = JSON.parse(e.target.result);
                 const products = Array.isArray(json) ? json : [json];
                 if (!confirm(`×œ×™×™×‘× ${products.length} ××•×¦×¨×™×?`)) return;
                 for (const p of products) {
                     await addDoc(collection(db, "products"), {
                         ...p, createdAt: new Date(), tech: p.tech || {}, specs: []
                     });
                 }
                 loadInventory();
             };
             reader.readAsText(file);
        }

        window.loadInventory = async () => {
            const container = document.getElementById('inventoryTable');
            const snap = await getDocs(collection(db, "products"));
            container.innerHTML = "";
            allProducts = [];
            snap.forEach(doc => {
                const p = {id: doc.id, ...doc.data()};
                allProducts.push(p);
                container.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded border hover:bg-white transition">
                        <div class="flex items-center gap-3">
                            <img src="${p.image}" class="w-10 h-10 object-contain bg-white rounded border">
                            <div class="font-bold text-sm truncate w-40">${p.name}</div>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="editProduct('${doc.id}')" class="text-blue-500"><i data-lucide="edit-3" size="14"></i></button>
                             <button onclick="deleteProduct('${doc.id}')" class="text-red-300"><i data-lucide="trash-2" size="14"></i></button>
                        </div>
                    </div>`;
            });
            lucide.createIcons();
        }

        window.editProduct = (id) => {
            const p = allProducts.find(x => x.id === id);
            if(!p) return;
            document.getElementById('editModeId').value = id;
            document.getElementById('pName').value = p.name;
            document.getElementById('pBrand').value = p.brand;
            document.getElementById('pStatus').value = p.status || 'standard';
            document.getElementById('pMarketing').value = p.marketingDesc || "";
            document.getElementById('pStandard').value = p.standard || "";
            document.getElementById('pCta').value = p.ctaText || "";
            document.getElementById('pCoverage').value = p.tech?.coverage || p.coverage || "";
            document.getElementById('pDrying').value = p.tech?.drying || p.drying || "";
            document.getElementById('pThickness').value = p.tech?.thickness || p.thickness || "";
            document.getElementById('pImageUrl').value = p.image || "";
            document.getElementById('pVideoUrl').value = p.video || "";
            document.getElementById('pPdfUrl').value = p.pdfUrl || "";
            
            selectedImages = p.images || (p.image ? [p.image] : []);
            renderImageGallery(selectedImages);

            document.getElementById('btnCancel').classList.remove('hidden');
            window.scrollTo({top:0, behavior:'smooth'});
            updatePreview();
        }

        window.renderImageGallery = (images) => {
            const container = document.getElementById('imageGallery');
            container.innerHTML = images.map(url => `
                <div class="selectable-item" onclick="selectFromGallery('${url}', this)">
                    <img src="${url}" class="w-full h-full object-contain">
                    <div class="check-mark"><i data-lucide="check" size="12"></i></div>
                </div>`).join('');
        }
        window.selectFromGallery = (url, el) => {
            document.querySelectorAll('#imageGallery .selectable-item').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('pImageUrl').value = url;
            selectedImages = [url];
            updatePreview();
        }

        window.deleteProduct = async (id) => {
            if(confirm("×œ××—×•×§?")) { await deleteDoc(doc(db, "products", id)); loadInventory(); }
        }
        window.resetForm = () => {
            document.getElementById('editModeId').value = "";
            document.querySelectorAll('input, textarea').forEach(i => i.value = "");
            document.getElementById('btnCancel').classList.add('hidden');
            document.getElementById('imageGallery').innerHTML = "";
            updatePreview();
        }

        loadInventory();
    </script>
</body>
</html>
