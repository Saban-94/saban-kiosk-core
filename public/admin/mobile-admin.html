<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sika Pocket Admin</title>
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#E3000F">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 90px; }
        .input-group { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 10px; }
        .floating-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); display: flex; gap: 10px; z-index: 50; }
        .ai-btn { background: #dcfce7; color: #16a34a; padding: 8px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .img-thumb { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid #eee; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="bg-black text-white p-4 sticky top-0 z-40 flex justify-between items-center shadow-lg">
        <div class="font-black text-xl italic tracking-wider">SIKA ADMIN</div>
        <button onclick="loadInventory()" class="bg-gray-800 p-2 rounded-full"><i data-lucide="refresh-cw" size="18"></i></button>
    </div>

    <div class="p-4 space-y-4">
        <div class="bg-gray-800 text-white p-4 rounded-xl flex items-center justify-between">
            <div><div class="font-bold">יבוא קטלוג</div><div class="text-xs text-gray-400">טען JSON</div></div>
            <input type="file" id="jsonFile" accept=".json" class="hidden" onchange="handleBulkUpload(this)">
            <button onclick="document.getElementById('jsonFile').click()" class="bg-blue-600 px-4 py-2 rounded-lg text-sm font-bold">טען</button>
        </div>

        <input type="hidden" id="editModeId">
        
        <div class="input-group">
            <h3 class="font-bold text-gray-400 text-xs mb-3 uppercase">זיהוי מוצר</h3>
            <div class="space-y-3">
                <input id="pName" placeholder="שם מוצר" class="w-full p-3 bg-gray-50 border rounded-lg font-bold text-lg">
                <div class="flex gap-2 relative">
                    <input id="pBrand" placeholder="מותג" class="flex-1 p-3 bg-gray-50 border rounded-lg text-sm pl-10">
                    <button onclick="fillField('pBrand')" class="ai-btn absolute left-2 top-2"><i data-lucide="sparkles" size="14"></i></button>
                </div>
                <input id="pBrandLogo" placeholder="לוגו יצרן (URL)" class="w-full p-3 bg-gray-50 border rounded-lg text-sm font-mono">
            </div>
        </div>

        <div class="input-group">
            <h3 class="font-bold text-gray-400 text-xs mb-3 uppercase">מדיה וגלריה</h3>
            <div id="urlInputsContainer" class="space-y-2 mb-2"></div>
            <button onclick="addImageUrlInput()" class="w-full py-2 border-2 border-dashed border-gray-300 text-gray-400 rounded-lg text-sm font-bold">+ הוסף תמונה</button>
            <div class="mt-3 space-y-2">
                <input id="pVideoUrl" placeholder="Youtube Link" class="w-full p-2 bg-gray-50 border rounded text-sm text-red-500">
                <input id="pPdfUrl" placeholder="PDF Link" class="w-full p-2 bg-gray-50 border rounded text-sm text-blue-500">
            </div>
        </div>

        <div class="input-group border-l-4 border-blue-500">
            <h3 class="font-bold text-blue-600 text-xs mb-3 uppercase">שיווק וטכני</h3>
            <div class="space-y-3">
                <select id="pStatus" class="w-full p-3 bg-white border rounded-lg"><option value="standard">רגיל</option><option value="recommended">מומלץ</option><option value="sale">מבצע</option></select>
                <div class="relative">
                    <textarea id="pMarketing" rows="3" placeholder="תיאור..." class="w-full p-3 bg-gray-50 border rounded-lg text-sm pl-10"></textarea>
                    <button onclick="fillField('pMarketing')" class="ai-btn absolute left-2 bottom-2"><i data-lucide="sparkles" size="14"></i></button>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <div class="relative"><input id="pCoverage" placeholder="כיסוי" class="w-full p-2 bg-gray-50 border rounded text-xs text-center"><button onclick="fillField('pCoverage')" class="absolute top-1 left-1 text-green-600"><i data-lucide="sparkles" size="10"></i></button></div>
                    <div class="relative"><input id="pDrying" placeholder="ייבוש" class="w-full p-2 bg-gray-50 border rounded text-xs text-center"><button onclick="fillField('pDrying')" class="absolute top-1 left-1 text-green-600"><i data-lucide="sparkles" size="10"></i></button></div>
                    <div class="relative"><input id="pThickness" placeholder="עובי" class="w-full p-2 bg-gray-50 border rounded text-xs text-center"><button onclick="fillField('pThickness')" class="absolute top-1 left-1 text-green-600"><i data-lucide="sparkles" size="10"></i></button></div>
                </div>
            </div>
        </div>
        
        <textarea id="pSpecs" class="hidden"></textarea>
        <input id="pCta" type="hidden">
        <input id="pStandard" type="hidden">

        <h3 class="font-bold mt-6 mb-2">מלאי קיים</h3>
        <div id="inventoryList" class="space-y-2 pb-4"></div>
    </div>

    <div class="floating-nav">
        <button onclick="resetForm()" class="bg-gray-200 text-gray-600 px-4 rounded-xl font-bold">נקה</button>
        <button onclick="runGlobalAI()" class="bg-green-100 text-green-700 px-4 rounded-xl font-bold flex-1 flex items-center justify-center gap-2"><i data-lucide="sparkles"></i> השלם</button>
        <button onclick="saveProduct()" class="bg-black text-white px-6 py-3 rounded-xl font-bold flex-[2] shadow-xl">שמור</button>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { askGeminiAdmin } from '../js/gemini-service.js';

        lucide.createIcons();
        let allProducts = [];

        window.addImageUrlInput = (value = "") => {
            const container = document.getElementById('urlInputsContainer');
            const div = document.createElement('div');
            div.className = "flex gap-2 mb-2";
            div.innerHTML = `<input type="text" value="${value}" class="img-url-input w-full p-2 border rounded text-sm font-mono" placeholder="URL תמונה"><button onclick="this.parentElement.remove()" class="text-red-500"><i data-lucide="x"></i></button>`;
            container.appendChild(div);
            lucide.createIcons();
        };
        addImageUrlInput();

        window.loadInventory = async () => {
            const container = document.getElementById('inventoryList');
            container.innerHTML = 'טוען...';
            const snap = await getDocs(collection(db, "products"));
            container.innerHTML = "";
            allProducts = [];
            snap.forEach(doc => {
                const p = {id: doc.id, ...doc.data()};
                allProducts.push(p);
                container.innerHTML += `
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center" onclick="editProduct('${doc.id}')">
                        <div class="flex items-center gap-3">
                            <img src="${p.image || 'https://via.placeholder.com/50'}" class="w-10 h-10 rounded object-contain bg-gray-50">
                            <div><div class="font-bold text-sm truncate w-40">${p.name}</div><div class="text-[10px] text-gray-400">${p.brand}</div></div>
                        </div>
                        <i data-lucide="chevron-left" class="text-gray-300"></i>
                    </div>`;
            });
            lucide.createIcons();
        }

        window.editProduct = (id) => {
            const p = allProducts.find(x => x.id === id);
            if(!p) return;
            document.getElementById('editModeId').value = id;
            document.getElementById('pName').value = p.name;
            document.getElementById('pBrand').value = p.brand;
            document.getElementById('pBrandLogo').value = p.brandLogo || "";
            document.getElementById('pStatus').value = p.status || 'standard';
            document.getElementById('pMarketing').value = p.marketingDesc || "";
            document.getElementById('pCoverage').value = p.tech?.coverage || p.coverage || "";
            document.getElementById('pDrying').value = p.tech?.drying || p.drying || "";
            document.getElementById('pThickness').value = p.tech?.thickness || p.thickness || "";
            document.getElementById('pVideoUrl').value = p.video || "";
            document.getElementById('pPdfUrl').value = p.pdfUrl || "";
            
            const container = document.getElementById('urlInputsContainer');
            container.innerHTML = "";
            const imgs = p.images && p.images.length ? p.images : (p.image ? [p.image] : []);
            if (imgs.length === 0) addImageUrlInput();
            else imgs.forEach(url => addImageUrlInput(url));

            window.scrollTo({top:0, behavior:'smooth'});
        }

        // AI Logic
        window.runGlobalAI = async () => {
            const name = document.getElementById('pName').value;
            if(!name) return alert("שם מוצר חובה");
            const btn = document.querySelector('button[onclick="runGlobalAI()"]'); btn.innerText = "⏳";
            try {
                const data = await askGeminiAdmin(name);
                if(data) {
                    const fill = (id, val) => { if(!document.getElementById(id).value && val) document.getElementById(id).value = val; };
                    fill('pBrand', data.brand); fill('pMarketing', data.marketingDesc);
                    fill('pCoverage', data.tech?.coverage); fill('pDrying', data.tech?.drying); fill('pThickness', data.tech?.thickness);
                }
            } catch(e) { console.error(e); }
            btn.innerText = "השלם";
        }

        window.fillField = async (fieldId) => {
            const name = document.getElementById('pName').value;
            if(!name) return;
            const btn = event.currentTarget; btn.innerHTML = "⏳";
            const data = await askGeminiAdmin(name);
            if(data) {
                const map = {'pBrand': data.brand, 'pMarketing': data.marketingDesc, 'pCoverage': data.tech?.coverage, 'pDrying': data.tech?.drying, 'pThickness': data.tech?.thickness};
                if(map[fieldId]) document.getElementById(fieldId).value = map[fieldId];
            }
            btn.innerHTML = `<i data-lucide="sparkles" size="14"></i>`;
            lucide.createIcons();
        }

        window.saveProduct = async () => {
            const btn = document.querySelector('button[onclick="saveProduct()"]'); btn.innerText = "שומר...";
            try {
                const imgInputs = document.querySelectorAll('.img-url-input');
                let images = []; imgInputs.forEach(inp => { if(inp.value.length > 5) images.push(inp.value); });

                const data = {
                    name: document.getElementById('pName').value,
                    brand: document.getElementById('pBrand').value,
                    brandLogo: document.getElementById('pBrandLogo').value,
                    status: document.getElementById('pStatus').value,
                    marketingDesc: document.getElementById('pMarketing').value,
                    image: images[0] || "", images: images,
                    video: document.getElementById('pVideoUrl').value, pdfUrl: document.getElementById('pPdfUrl').value,
                    coverage: document.getElementById('pCoverage').value, drying: document.getElementById('pDrying').value, thickness: document.getElementById('pThickness').value,
                    updatedAt: new Date()
                };
                const editId = document.getElementById('editModeId').value;
                if(editId) await updateDoc(doc(db, "products", editId), data);
                else { data.createdAt = new Date(); await addDoc(collection(db, "products"), data); }
                alert("✅ נשמר!"); loadInventory(); window.resetForm();
            } catch (e) { alert("שגיאה: " + e.message); }
            btn.innerText = "שמור";
        }

        window.resetForm = () => {
            document.getElementById('editModeId').value = "";
            document.querySelectorAll('input, textarea').forEach(i => i.value = "");
            document.getElementById('urlInputsContainer').innerHTML = ""; addImageUrlInput();
        }

        window.handleBulkUpload = async (input) => {
             const file = input.files[0]; if (!file) return;
             const reader = new FileReader();
             reader.onload = async (e) => {
                 const products = JSON.parse(e.target.result);
                 if (!confirm(`לייבא ${products.length} מוצרים?`)) return;
                 for (const p of products) await addDoc(collection(db, "products"), {...p, createdAt: new Date()});
                 loadInventory();
             };
             reader.readAsText(file);
        }

        loadInventory();
    </script>
</body>
</html>
