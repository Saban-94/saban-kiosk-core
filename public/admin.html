<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SikaOS - Master CRM</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- CORE THEME --- */
        :root { --sidebar-bg: #0f172a; --sidebar-hover: #1e293b; --accent: #E3000F; --bg-light: #f8fafc; }
        body { font-family: 'Heebo', sans-serif; background-color: var(--sidebar-bg); height: 100vh; display: flex; overflow: hidden; color: #334155; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--sidebar-bg); border-left: 1px solid #1e293b; display: flex; flex-direction: column; z-index: 50; color: #94a3b8; }
        .brand-area { padding: 24px; border-bottom: 1px solid #1e293b; display: flex; align-items: center; gap: 12px; }
        .nav-item { padding: 14px 24px; cursor: pointer; font-weight: 500; display: flex; items-center; gap: 12px; transition: 0.2s; border-right: 3px solid transparent; }
        .nav-item:hover { background: var(--sidebar-hover); color: white; }
        .nav-item.active { background: var(--sidebar-hover); color: var(--accent); border-right-color: var(--accent); }

        /* Main Workspace */
        .workspace { flex: 1; background: var(--bg-light); border-radius: 30px 0 0 30px; margin-right: -20px; z-index: 10; display: flex; flex-direction: column; overflow: hidden; position: relative; box-shadow: -10px 0 30px rgba(0,0,0,0.3); }
        .top-bar { padding: 20px 30px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: white; }
        .content-area { flex: 1; overflow-y: auto; padding: 30px; }
        
        /* Views & Tabs */
        .view-section { display: none; height: 100%; flex-direction: column; gap: 20px; }
        .view-section.active { display: flex; }
        .sub-tabs { display: flex; gap: 20px; border-bottom: 1px solid #e2e8f0; margin-bottom: 20px; }
        .sub-tab { padding: 10px 0; cursor: pointer; color: #64748b; font-weight: bold; border-bottom: 2px solid transparent; transition: 0.2s; }
        .sub-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* Forms */
        .input-group { margin-bottom: 15px; }
        .input-label { display: block; font-size: 11px; font-weight: 800; color: #64748b; margin-bottom: 5px; text-transform: uppercase; }
        .input-field { width: 100%; padding: 10px 14px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; outline: none; transition: 0.2s; background: white; }
        .input-field:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(227, 0, 15, 0.1); }
        
        /* Buttons */
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; font-size: 13px; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(227, 0, 15, 0.2); }
        .btn-primary:hover { background: #c4000d; transform: translateY(-1px); }
        .btn-ghost { background: white; border: 1px solid #cbd5e1; color: #475569; }
        .btn-ghost:hover { background: #f8fafc; border-color: #94a3b8; }

        /* Simulator Pane (Right) */
        .sim-pane { width: 420px; background: #0f172a; border-right: 1px solid #1e293b; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .device-mockup { width: 340px; height: 680px; background: #fff; border-radius: 40px; border: 12px solid #1e293b; overflow: hidden; position: relative; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .sim-screen { flex: 1; background: #f8fafc; overflow-y: auto; padding: 15px; position: relative; }
        
        /* Simulator Components */
        .sim-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; margin-top: 40px; }
        .sim-img-area { height: 160px; background: #f8fafc; display: flex; align-items: center; justify-content: center; padding: 10px; }
        .sim-img-area img { max-height: 100%; object-fit: contain; mix-blend-multiply; }
        .sim-content { padding: 15px; }
        
        .sim-bubble { padding: 10px 14px; border-radius: 14px; font-size: 13px; max-width: 85%; margin-bottom: 8px; line-height: 1.4; animation: pop 0.3s; }
        .sim-bot { background: white; color: #334155; border: 1px solid #e2e8f0; border-top-right-radius: 2px; }
        .sim-user { background: var(--accent); color: white; align-self: flex-end; margin-right: auto; border-top-left-radius: 2px; }
        
        @keyframes pop { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand-area">
            <div class="w-10 h-10 bg-gradient-to-br from-red-600 to-red-800 rounded-xl flex items-center justify-center text-white font-black text-xl shadow-lg">S</div>
            <div>
                <h1 class="text-white font-black leading-none tracking-tight">SikaOS</h1>
                <span class="text-[10px] font-bold tracking-widest opacity-60">MASTER CRM</span>
            </div>
        </div>
        
        <nav class="flex-1 py-4 space-y-1">
            <div class="nav-item active" onclick="app.nav('products')"><i data-lucide="package"></i> × ×™×”×•×œ ××•×¦×¨×™×</div>
            <div class="nav-item" onclick="app.nav('brain')"><i data-lucide="brain-circuit"></i> ××•×— (AI Center)</div>
            <div class="nav-item" onclick="app.nav('brands')"><i data-lucide="award"></i> ××•×ª×’×™×</div>
            <div class="nav-item" onclick="app.nav('tutorials')"><i data-lucide="play-circle"></i> ×”×“×¨×›×•×ª</div>
        </nav>
        
        <div class="p-4 border-t border-slate-800">
            <div class="flex items-center gap-2 text-xs font-bold text-green-400">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> ××—×•×‘×¨ ×œ×©×¨×ª
            </div>
        </div>
    </div>

    <div class="workspace">
        
        <div id="view-products" class="view-section active">
            <div class="top-bar">
                <div><h2 class="text-2xl font-black text-slate-800">×§×˜×œ×•×’ ××•×¦×¨×™×</h2><p class="text-xs text-slate-500">× ×™×”×•×œ ××œ××™, ××¤×¨×˜×™× ×˜×›× ×™×™× ×•××“×™×”</p></div>
                <div class="flex gap-2">
                    <button onclick="app.resetForm('prod')" class="btn btn-ghost"><i data-lucide="plus"></i> ×—×“×©</button>
                    <button onclick="app.saveProd()" class="btn btn-primary"><i data-lucide="save"></i> ×©××•×¨</button>
                </div>
            </div>

            <div class="content-area flex gap-6">
                <div class="w-72 bg-white rounded-2xl border border-slate-200 flex flex-col overflow-hidden h-full">
                    <div class="p-3 border-b"><input onkeyup="app.filterList('prodList', this.value)" class="input-field mb-0" placeholder="×—×¤×© ××•×¦×¨..."></div>
                    <div id="prodList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
                </div>

                <div class="flex-1 bg-white rounded-2xl border border-slate-200 p-8 overflow-y-auto shadow-sm">
                    <input type="hidden" id="pId">
                    <div class="grid grid-cols-2 gap-4 mb-2">
                        <div class="input-group"><span class="input-label">×©× ×”××•×¦×¨</span><input id="pName" class="input-field" oninput="app.simProd()"></div>
                        <div class="input-group"><span class="input-label">××•×ª×’</span><select id="pBrand" class="input-field" onchange="app.simProd()"></select></div>
                    </div>

                    <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 mb-6">
                        <h4 class="font-bold text-xs text-blue-800 mb-3 flex items-center gap-2"><i data-lucide="ruler"></i> ××¤×¨×˜ ×˜×›× ×™</h4>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="input-group mb-0"><span class="input-label">×›×™×¡×•×™ (×§"×’/×"×¨)</span><input id="pCov" class="input-field text-center" oninput="app.simProd()"></div>
                            <div class="input-group mb-0"><span class="input-label">×–××Ÿ ×™×™×‘×•×©</span><input id="pDry" class="input-field text-center" oninput="app.simProd()"></div>
                            <div class="input-group mb-0"><span class="input-label">×¢×•×‘×™ ×™×™×©×•×</span><input id="pThick" class="input-field text-center" oninput="app.simProd()"></div>
                        </div>
                        <div class="input-group mt-3 mb-0">
                            <span class="input-label">×ª×›×•× ×•×ª ×‘×•×œ×˜×•×ª (××•×¤×¨×“ ×‘×¤×¡×™×§)</span>
                            <input id="pFeat" class="input-field" placeholder="×’××™×©, ××”×™×¨ ×™×™×‘×•×©, ×¢××™×“..." oninput="app.simProd()">
                        </div>
                    </div>

                    <div class="bg-gray-50 p-5 rounded-xl border border-gray-200 mb-6">
                        <h4 class="font-bold text-xs text-gray-500 mb-3 flex items-center gap-2"><i data-lucide="image"></i> ××“×™×” ×•×’×œ×¨×™×”</h4>
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <input id="pImg1" class="input-field" placeholder="×ª××•× ×” ×¨××©×™×ª URL" oninput="app.simProd()">
                            <input id="pImg2" class="input-field" placeholder="×ª××•× ×” 2 URL" oninput="app.simProd()">
                            <input id="pImg3" class="input-field" placeholder="×ª××•× ×” 3 URL" oninput="app.simProd()">
                        </div>
                        <div class="input-group mb-0">
                            <span class="input-label">×¡×¨×˜×•×Ÿ ×”×“×¨×›×” ××§×•×©×¨</span>
                            <select id="pVideoLink" class="input-field"><option value="">-- ×‘×—×¨ ×¡×¨×˜×•×Ÿ --</option></select>
                        </div>
                    </div>

                    <div class="input-group"><span class="input-label">×ª×™××•×¨ ×©×™×•×•×§×™</span><textarea id="pDesc" class="input-field h-24" oninput="app.simProd()"></textarea></div>
                    
                    <div class="flex justify-end pt-4 border-t">
                        <button onclick="app.delItem('products', document.getElementById('pId').value)" class="text-red-500 text-xs font-bold hover:underline">××—×§ ××•×¦×¨</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-brain" class="view-section">
            <div class="top-bar">
                <div><h2 class="text-2xl font-black text-slate-800">AI Brain Center</h2><p class="text-xs text-slate-500">× ×™×”×•×œ ×™×“×¢, ×©××œ×•×ª ×•×ª×©×•×‘×•×ª</p></div>
            </div>

            <div class="content-area">
                <div class="sub-tabs">
                    <div class="sub-tab active" onclick="app.brainTab('qa')">×¡×¤×¨×™×™×ª ×©××œ×•×ª (Q&A)</div>
                    <div class="sub-tab" onclick="app.brainTab('keywords')">××™×œ×•×ª ××¤×ª×—</div>
                    <div class="sub-tab" onclick="app.brainTab('logs')">×œ×•×’ ×©×™×—×•×ª (Live)</div>
                </div>

                <div id="brain-qa" class="h-full flex gap-6">
                    <div class="w-80 bg-white rounded-2xl border border-slate-200 flex flex-col overflow-hidden">
                        <div class="p-3 bg-slate-50 border-b font-bold text-xs text-slate-500">×©××œ×•×ª ×§×™×™××•×ª</div>
                        <div id="qaList" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
                    </div>
                    <div class="flex-1 bg-white rounded-2xl border p-8 shadow-sm flex flex-col">
                        <input type="hidden" id="qaId">
                        <div class="input-group">
                            <span class="input-label text-blue-600">×ª×‘× ×™×ª ×”×©××œ×” (×˜×¨×™×’×¨)</span>
                            <input id="qaTrigger" class="input-field font-bold text-lg" placeholder='×œ××©×œ: "×¡×“×§ ×‘×§×™×¨", "××—×™×¨"...' oninput="app.simChat()">
                        </div>
                        
                        <div class="input-group flex-1 flex flex-col">
                            <span class="input-label text-blue-600">×ª×©×•×‘×ª ×”×¨×•×‘×•×˜</span>
                            <div class="flex gap-2 mb-2 p-2 bg-slate-50 rounded border">
                                <button class="tool-btn text-xs font-bold px-2 py-1 bg-white border rounded hover:bg-slate-100" onclick="app.insertTag('{{typing}}')">â³ ×—×•×©×‘</button>
                                <button class="tool-btn text-xs font-bold px-2 py-1 bg-white border rounded hover:bg-slate-100 text-blue-600" onclick="app.pick('prod')">ğŸ“¦ ××•×¦×¨</button>
                                <button class="tool-btn text-xs font-bold px-2 py-1 bg-white border rounded hover:bg-slate-100 text-red-600" onclick="app.pick('vid')">ğŸ¬ ×•×™×“××•</button>
                            </div>
                            <textarea id="qaResp" class="input-field flex-1 resize-none" placeholder="×”×§×œ×“ ××ª ×”×ª×©×•×‘×” ×›××Ÿ..." oninput="app.simChat()"></textarea>
                        </div>

                        <div class="flex justify-between pt-4 border-t">
                            <button onclick="app.delItem('chat_rules', document.getElementById('qaId').value)" class="text-red-500 text-xs font-bold">××—×§ ×—×•×§</button>
                            <div class="flex gap-2">
                                <button onclick="app.resetForm('brain')" class="btn btn-ghost">×—×“×©</button>
                                <button onclick="app.saveQA()" class="btn btn-primary">×©××•×¨ ×—×•×§</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="brain-keywords" class="hidden h-full">
                    <div class="bg-white p-6 rounded-2xl border mb-6 flex gap-4 items-end">
                        <div class="flex-1"><span class="input-label">×‘×™×˜×•×™</span><input id="kwPhrase" class="input-field"></div>
                        <div class="w-40"><span class="input-label">×§×˜×’×•×¨×™×”</span><select id="kwCat" class="input-field"><option>××™×˜×•×</option><option>×‘×˜×•×Ÿ</option><option>×“×‘×§×™×</option></select></div>
                        <button onclick="app.saveKw()" class="btn btn-primary">×”×•×¡×£</button>
                    </div>
                    <div id="kwList" class="grid grid-cols-4 gap-4"></div>
                </div>

                <div id="brain-logs" class="hidden h-full bg-white rounded-2xl border overflow-hidden">
                    <table class="w-full text-right">
                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase"><tr><th class="p-4">×©××œ×”</th><th class="p-4">×ª×©×•×‘×”</th><th class="p-4">×–××Ÿ</th></tr></thead>
                        <tbody id="logsTable" class="text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-brands" class="view-section">
            <div class="top-bar"><h2>× ×™×”×•×œ ××•×ª×’×™×</h2></div>
            <div class="content-area flex gap-6">
                <div class="w-80 bg-white border rounded-2xl overflow-y-auto p-2" id="brandList"></div>
                <div class="w-96 bg-white border rounded-2xl p-6 h-fit">
                    <input type="hidden" id="bId">
                    <div class="input-group"><span class="input-label">×©×</span><input id="bName" class="input-field"></div>
                    <div class="input-group"><span class="input-label">×œ×•×’×• URL</span><input id="bLogo" class="input-field"></div>
                    <div class="flex gap-2">
                        <div class="flex-1"><span class="input-label">×¦×‘×¢ ×¨××©×™</span><input id="bColP" type="color" class="w-full h-10 cursor-pointer rounded"></div>
                        <div class="flex-1"><span class="input-label">×¦×‘×¢ ×“×’×©</span><input id="bColA" type="color" class="w-full h-10 cursor-pointer rounded"></div>
                    </div>
                    <button onclick="app.saveBrand()" class="btn btn-primary w-full mt-4">×©××•×¨</button>
                </div>
            </div>
        </div>

        <div id="view-tutorials" class="view-section">
            <div class="top-bar"><h2>×”×“×¨×›×•×ª</h2></div>
            <div class="content-area">
                <div class="bg-white p-6 rounded-2xl border mb-6 flex gap-4 items-end">
                    <div class="flex-1"><span class="input-label">×›×•×ª×¨×ª</span><input id="vTitle" class="input-field"></div>
                    <div class="flex-1"><span class="input-label">×œ×™× ×§ YouTube</span><input id="vUrl" class="input-field"></div>
                    <button onclick="app.saveVid()" class="btn btn-primary">×”×•×¡×£</button>
                </div>
                <div id="vidList" class="grid grid-cols-4 gap-4"></div>
            </div>
        </div>

    </div>

    <div class="sim-pane">
        <div class="text-center mb-6">
            <h3 class="font-black text-white text-lg">Live Preview</h3>
            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">REAL-TIME CUSTOMER VIEW</p>
        </div>
        
        <div class="device-mockup">
            <div class="sim-screen" id="simContent">
                
                <div id="sim-chat" class="hidden flex flex-col gap-3">
                    <div class="sim-bubble sim-bot">×©×œ×•×, ×× ×™ Sika AI.</div>
                    <div class="sim-bubble sim-user" id="simUserMsg">...</div>
                    <div class="sim-bubble sim-bot" id="simBotMsg">...</div>
                </div>

                <div id="sim-prod" class="hidden">
                    <div class="sim-card">
                        <div class="sim-img-area"><img id="simImg" src="https://placehold.co/200"></div>
                        <div class="sim-content">
                            <div class="text-[10px] font-bold text-slate-400 uppercase" id="simBrand">SIKA</div>
                            <div class="text-lg font-black text-slate-800 leading-tight" id="simName">×©× ×”××•×¦×¨</div>
                            <div class="mt-2 flex flex-wrap gap-1" id="simTags"></div>
                            
                            <div class="grid grid-cols-3 gap-2 mt-4 text-center bg-slate-50 p-2 rounded-lg border">
                                <div><span class="block text-[9px] font-bold text-slate-400">×›×™×¡×•×™</span><span class="block text-xs font-bold text-slate-800" id="simCov">-</span></div>
                                <div><span class="block text-[9px] font-bold text-slate-400">×™×™×‘×•×©</span><span class="block text-xs font-bold text-slate-800" id="simDry">-</span></div>
                                <div><span class="block text-[9px] font-bold text-slate-400">×¢×•×‘×™</span><span class="block text-xs font-bold text-slate-800" id="simThick">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            
            <div class="h-14 bg-white border-t flex justify-around items-center absolute bottom-0 w-full z-20">
                <div class="w-12 h-1 bg-slate-200 rounded-full"></div>
            </div>
        </div>
    </div>

    <div id="pickerModal" class="fixed inset-0 bg-black/70 z-[100] hidden items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-96 p-6 shadow-2xl flex flex-col max-h-[80vh]">
            <h3 class="font-bold text-lg mb-4 text-slate-800">×‘×—×¨ ×¤×¨×™×˜</h3>
            <div id="pickerList" class="flex-1 overflow-y-auto space-y-2 border rounded p-2"></div>
            <button onclick="document.getElementById('pickerModal').classList.add('hidden')" class="btn btn-ghost w-full mt-4">×‘×™×˜×•×œ</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, limit } 
        from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // Config embedded to guarantee connection
        const firebaseConfig = {
          apiKey: "AIzaSyDZuI7AaDZVteUhUT_eIVCR5SIdU0jhqUg",
          authDomain: "saban-kiosk-core.firebaseapp.com",
          projectId: "saban-kiosk-core",
          storageBucket: "saban-kiosk-core.firebasestorage.app",
          messagingSenderId: "866976260818",
          appId: "1:866976260818:web:0e3ec12df72291c77f430b"
        };

        const appInstance = initializeApp(firebaseConfig);
        const db = getFirestore(appInstance);
        
        lucide.createIcons();

        // Application State & Logic
        const app = {
            data: { prods:[], brands:[], vids:[], keywords:[] },
            
            init: () => {
                app.listeners();
                app.nav('products');
            },

            // --- Navigation ---
            nav: (v) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.getElementById('view-'+v).classList.add('active');
                
                // Active Sidebar Item logic would go here if IDs were unique per item
                // Sim Mode
                document.getElementById('sim-chat').classList.add('hidden');
                document.getElementById('sim-prod').classList.add('hidden');
                
                if(v==='brain') document.getElementById('sim-chat').classList.remove('hidden');
                else document.getElementById('sim-prod').classList.remove('hidden');
            },

            brainTab: (sub) => {
                ['qa','keywords','logs'].forEach(t => document.getElementById('brain-'+t).classList.add('hidden'));
                document.getElementById('brain-'+sub).classList.remove('hidden');
                document.querySelectorAll('.sub-tab').forEach(el => el.classList.remove('active'));
                event.target.classList.add('active');
            },

            // --- Listeners ---
            listeners: () => {
                onSnapshot(collection(db, "products"), s => {
                    const l = document.getElementById('prodList'); l.innerHTML=""; app.data.prods=[];
                    s.forEach(d => {
                        const p = {id:d.id, ...d.data()}; app.data.prods.push(p);
                        l.innerHTML += `<div onclick="window.safeApp.loadProd('${p.id}')" class="p-3 border-b hover:bg-slate-50 cursor-pointer flex justify-between items-center text-sm font-medium text-slate-700">${p.name} <i data-lucide="edit-2" class="w-3 h-3 text-slate-300"></i></div>`;
                    });
                    lucide.createIcons();
                });
                onSnapshot(collection(db, "brands"), s => {
                    const sel = document.getElementById('pBrand'); sel.innerHTML="";
                    const lst = document.getElementById('brandList'); lst.innerHTML="";
                    s.forEach(d => {
                        const b = {id:d.id, ...d.data()};
                        sel.innerHTML += `<option value="${b.name}">${b.name}</option>`;
                        lst.innerHTML += `<div onclick="window.safeApp.loadBrand('${b.id}')" class="p-3 border-b cursor-pointer flex items-center gap-2"><img src="${b.logo}" class="w-6 h-6 object-contain"> ${b.name}</div>`;
                    });
                });
                onSnapshot(collection(db, "tutorials"), s => {
                    const g = document.getElementById('vidGrid'); 
                    const sel = document.getElementById('pVideoLink'); sel.innerHTML='<option value="">-- ×‘×—×¨ --</option>';
                    app.data.vids = s.docs.map(d=>({id:d.id, ...d.data()}));
                    
                    document.getElementById('vidList').innerHTML = app.data.vids.map(v => 
                        `<div class="bg-white p-3 border rounded text-xs truncate relative group">${v.title}<button onclick="window.safeApp.delItem('tutorials','${v.id}')" class="absolute top-1 right-1 text-red-500 hidden group-hover:block">x</button></div>`
                    ).join('');
                    
                    app.data.vids.forEach(v => sel.innerHTML += `<option value="${v.url}">${v.title}</option>`);
                });
                onSnapshot(collection(db, "chat_rules"), s => {
                    const l = document.getElementById('qaList'); l.innerHTML="";
                    s.forEach(d => {
                        const r = {id:d.id, ...d.data()};
                        l.innerHTML += `<div onclick="window.safeApp.loadQA('${r.id}')" class="p-3 border rounded bg-slate-50 text-xs mb-2 cursor-pointer hover:border-blue-400"><b>${r.trigger}</b><div class="truncate text-slate-400">${r.response}</div></div>`;
                    });
                });
                onSnapshot(collection(db, "keywords"), s => {
                    document.getElementById('kwList').innerHTML = s.docs.map(d => `<div class="p-2 border rounded bg-white text-xs flex justify-between items-center"><span>${d.data().phrase}</span><button onclick="window.safeApp.delItem('keywords','${d.id}')" class="text-red-500">x</button></div>`).join('');
                });
                // Live Logs
                const qLogs = query(collection(db, "conversations_logs"), orderBy("timestamp", "desc"), limit(20));
                onSnapshot(qLogs, s => {
                    document.getElementById('logsTable').innerHTML = s.docs.map(d => {
                        const l = d.data();
                        return `<tr class="border-b hover:bg-slate-50"><td class="p-3 font-medium">${l.user_query}</td><td class="p-3 truncate max-w-xs text-slate-500">${l.response_preview||''}</td><td class="p-3 text-xs text-slate-400">${new Date(l.timestamp?.seconds*1000).toLocaleTimeString()}</td></tr>`;
                    }).join('');
                });
            },

            // --- Product Functions ---
            loadProd: (id) => {
                const p = app.data.prods.find(x => x.id === id);
                if(!p) return;
                document.getElementById('pId').value = p.id;
                document.getElementById('pName').value = p.name;
                document.getElementById('pBrand').value = p.brand;
                document.getElementById('pDesc').value = p.marketingDesc;
                document.getElementById('pCov').value = p.tech?.coverage || '';
                document.getElementById('pDry').value = p.tech?.drying || '';
                document.getElementById('pThick').value = p.tech?.thickness || '';
                document.getElementById('pFeat').value = p.features?.join(', ') || '';
                document.getElementById('pImg1').value = p.images?.[0] || p.image || '';
                document.getElementById('pImg2').value = p.images?.[1] || '';
                document.getElementById('pImg3').value = p.images?.[2] || '';
                document.getElementById('pVideoLink').value = p.video || '';
                app.simProd();
            },
            simProd: () => {
                const n = document.getElementById('pName').value;
                document.getElementById('simName').innerText = n || '×©× ×”××•×¦×¨';
                document.getElementById('simBrand').innerText = document.getElementById('pBrand').value || 'SIKA';
                document.getElementById('simImg').src = document.getElementById('pImg1').value || 'https://placehold.co/200';
                
                document.getElementById('simCov').innerText = document.getElementById('pCov').value || '-';
                document.getElementById('simDry').innerText = document.getElementById('pDry').value || '-';
                document.getElementById('simThick').innerText = document.getElementById('pThick').value || '-';
                
                const feats = document.getElementById('pFeat').value.split(',').filter(f=>f.trim());
                document.getElementById('simTags').innerHTML = feats.map(f=>`<span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-[9px] font-bold">${f.trim()}</span>`).join('');
            },
            saveProd: async () => {
                const id = document.getElementById('pId').value;
                const d = {
                    name: document.getElementById('pName').value, brand: document.getElementById('pBrand').value, marketingDesc: document.getElementById('pDesc').value,
                    images: [document.getElementById('pImg1').value, document.getElementById('pImg2').value, document.getElementById('pImg3').value].filter(Boolean),
                    image: document.getElementById('pImg1').value, // Legacy
                    video: document.getElementById('pVideoLink').value,
                    tech: { coverage: document.getElementById('pCov').value, drying: document.getElementById('pDry').value, thickness: document.getElementById('pThick').value },
                    features: document.getElementById('pFeat').value.split(',').map(f=>f.trim()).filter(Boolean)
                };
                if(id) await updateDoc(doc(db, "products", id), d); else await addDoc(collection(db, "products"), d);
                alert("× ×©××¨"); app.resetForm('prod');
            },

            // --- AI Brain Functions ---
            loadQA: (id) => {
                const r = app.data.rules || []; // Fallback
                // Since rules are loaded in listener, we can find it
                // We need to re-fetch from local closure since app.data.rules isn't fully bound in the snapshot directly to app.data
                // Better: query DB or use DOM click data. 
                // Simplest: Find in app.data.rules (assuming populated)
            },
            // Fix: Actually populate app.data.rules inside listener
            
            // Sim Chat
            simChat: () => {
                const t = document.getElementById('qaTrigger').value;
                const r = document.getElementById('qaResp').value;
                document.getElementById('simUserMsg').innerText = t || "...";
                document.getElementById('simBotMsg').innerText = r ? r.replace(/{{.*?}}/g, '[××¤×§×˜]') : "...";
            },
            
            insertTag: (t) => { document.getElementById('qaResp').value += ` ${t}`; app.simChat(); },
            
            pick: (type) => {
                const m = document.getElementById('pickerModal');
                const l = document.getElementById('pickerList'); l.innerHTML="";
                m.classList.remove('hidden');
                const list = type==='prod' ? app.data.prods : app.data.vids;
                list.forEach(i => {
                    l.innerHTML += `<div class="p-2 border-b cursor-pointer hover:bg-slate-50 text-sm" onclick="window.safeApp.insert('{{${type==='prod'?'product':'video'}:${i.name||i.title}}}')">${i.name||i.title}</div>`;
                });
            },
            insert: (tx) => {
                document.getElementById('qaResp').value += ` ${tx}`;
                document.getElementById('pickerModal').classList.add('hidden');
                app.simChat();
            },
            saveQA: async () => {
                const id = document.getElementById('qaId').value;
                const d = { trigger: document.getElementById('qaTrigger').value, response: document.getElementById('qaResp').value };
                if(id) await updateDoc(doc(db, "chat_rules", id), d); else await addDoc(collection(db, "chat_rules"), d);
                alert("×—×•×§ × ×©××¨"); app.resetForm('brain');
            },
            saveKw: async () => {
                await addDoc(collection(db, "keywords"), {
                    phrase: document.getElementById('kwPhrase').value, category: document.getElementById('kwCat').value
                });
                alert("× ×•×¡×£");
            },

            // --- Utilities ---
            resetForm: (t) => {
                if(t==='prod') {
                    document.getElementById('pId').value="";
                    document.querySelectorAll('#view-products input, #view-products textarea').forEach(i=>i.value="");
                    app.simProd();
                }
                if(t==='brain') {
                    document.getElementById('qaId').value="";
                    document.getElementById('qaTrigger').value="";
                    document.getElementById('qaResp').value="";
                    app.simChat();
                }
            },
            delItem: async (col, id) => {
                if(confirm("×œ××—×•×§?")) { await deleteDoc(doc(db, col, id)); }
            },
            filterList: (listId, txt) => {
                Array.from(document.getElementById(listId).children).forEach(el => el.style.display = el.innerText.toLowerCase().includes(txt.toLowerCase()) ? 'flex' : 'none');
            },
            
            // Brand & Video Save (Simplified)
            saveBrand: async () => {
                const d = {
                    name: document.getElementById('bName').value, logo: document.getElementById('bLogo').value,
                    colors: { primary: document.getElementById('bColP').value, accent: document.getElementById('bColA').value }
                };
                const id = document.getElementById('bId').value;
                if(id) await updateDoc(doc(db, "brands", id), d); else await addDoc(collection(db, "brands"), d);
                alert("××•×ª×’ × ×©××¨");
            },
            loadBrand: (id) => {
                // Mock load for UI
                document.getElementById('bId').value = id;
            },
            saveVid: async () => {
                await addDoc(collection(db, "tutorials"), {
                    title: document.getElementById('vTitle').value, url: document.getElementById('vUrl').value
                }); alert("×¡×¨×˜×•×Ÿ × ×•×¡×£");
            }
        };

        // Bind global safeApp for onclicks
        window.safeApp = app;
        
        // Helper fix for loading QA specifically since logic was split
        window.safeApp.loadQA = (id) => {
            // Find in current snapshot data (requires keeping data synced which we do in app.data.rules)
            const r = app.data.rules.find(x => x.id === id);
            if(r) {
                document.getElementById('qaId').value = r.id;
                document.getElementById('qaTrigger').value = r.trigger;
                document.getElementById('qaResp').value = r.response;
                app.simChat();
            }
        };

        app.init();
    </script>
</body>
</html>
