<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sika Studio AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>body{font-family:'Heebo',sans-serif;background:#f1f5f9;height:100vh;display:flex;overflow:hidden}.sidebar{width:280px;background:white;border-left:1px solid #e2e8f0;display:flex;flex-direction:column}.nav-item{padding:16px 24px;cursor:pointer;color:#64748b;display:flex;gap:12px;font-weight:500}.nav-item.active{background:#eff6ff;color:#2563eb}.main{flex:1;padding:24px;overflow:hidden;display:flex;flex-direction:column}.view{display:none;height:100%}.view.active{display:flex;flex-direction:column}.input-std{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px;margin-bottom:8px}.btn{padding:10px 20px;border-radius:8px;font-weight:bold;cursor:pointer}.btn-primary{background:#2563eb;color:white}</style>
</head>
<body>
    <div class="sidebar">
        <div class="p-8 border-b flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-black">S</div>
            <h1 class="text-xl font-black">SIKA STUDIO</h1>
        </div>
        <nav class="flex-1 py-4">
            <div class="nav-item active" onclick="safeApp.switchView('products')"><i data-lucide="package"></i> ××•×¦×¨×™×</div>
            <div class="nav-item" onclick="safeApp.switchView('brands')"><i data-lucide="tag"></i> ××•×ª×’×™×</div>
        </nav>
        <div id="status" class="p-4 text-center text-xs font-bold text-gray-400 border-t">×˜×•×¢×Ÿ ××¢×¨×›×ª...</div>
    </div>

    <div class="main">
        <div id="view-products" class="view active gap-6 flex-row">
            <div class="flex-1 bg-white p-6 rounded-2xl border overflow-y-auto relative">
                <header class="flex justify-between mb-6 sticky top-0 bg-white z-10 pb-4 border-b">
                    <h2 class="text-2xl font-black">× ×™×”×•×œ ××•×¦×¨×™×</h2>
                    <button onclick="safeApp.newProd()" class="btn btn-primary">×—×“×©</button>
                </header>
                
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-5 rounded-xl mb-6 flex justify-between items-center border border-blue-100 shadow-sm">
                    <div>
                        <span class="font-bold text-indigo-900 flex items-center gap-2"><i data-lucide="sparkles" class="text-indigo-500"></i> AI Generator</span>
                        <p class="text-xs text-indigo-600 mt-1">×”×›× ×¡ ×©× ××•×¦×¨ (×œ××©×œ: Sika TopSeal 107) ×•×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨</p>
                    </div>
                    <button onclick="safeApp.askGemini()" class="btn bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all hover:scale-105">×¦×•×¨ ×ª×•×›×Ÿ ××•×˜×•××˜×™</button>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <input id="pid" type="hidden">
                    <div><label class="text-xs font-bold block mb-1">×©× ××•×¦×¨</label><input id="pName" class="input-std" placeholder="×©× ××œ×"></div>
                    <div><label class="text-xs font-bold block mb-1">××•×ª×’</label><select id="pBrand" class="input-std"></select></div>
                </div>
                <div><label class="text-xs font-bold block mb-1">×ª×™××•×¨ ×©×™×•×•×§×™</label><textarea id="pDesc" class="input-std h-24" placeholder="×”×ª×™××•×¨ ×™×•×¤×™×¢ ×›××Ÿ..."></textarea></div>
                <div><label class="text-xs font-bold block mb-1">×ª××•× ×” URL</label><input id="pImg" class="input-std" placeholder="https://..."></div>
                
                <div class="bg-gray-50 p-4 rounded-xl mt-2 border">
                    <h4 class="text-xs font-bold mb-2 text-gray-500 uppercase">××¤×¨×˜ ×˜×›× ×™</h4>
                    <div class="grid grid-cols-3 gap-3">
                        <input id="tCov" class="input-std mb-0" placeholder="×›×™×¡×•×™">
                        <input id="tDry" class="input-std mb-0" placeholder="×™×™×‘×•×©">
                        <input id="tThick" class="input-std mb-0" placeholder="×¢×•×‘×™">
                    </div>
                </div>
                
                <div class="flex gap-2 mt-6 pt-4 border-t">
                    <button onclick="safeApp.saveProd()" class="btn btn-primary flex-1">×©××•×¨ ××•×¦×¨</button>
                    <button onclick="safeApp.delProd()" class="btn bg-white text-red-500 border border-red-100 hover:bg-red-50">××—×§</button>
                </div>

                <div id="pList" class="mt-8 space-y-2 border-t pt-4">
                    <h3 class="text-sm font-bold text-gray-400 mb-2">××•×¦×¨×™× ×§×™×™××™×</h3>
                    </div>
            </div>
        </div>
        
        <div id="view-brands" class="view items-center justify-center text-gray-400">
            <div class="text-center">
                <i data-lucide="construction" size="48" class="mx-auto mb-2 opacity-50"></i>
                <h2 class="text-xl font-bold">×‘×§×¨×•×‘...</h2>
            </div>
        </div>
    </div>

    <script>
        window.safeApp = {
            switchView: () => {}, newProd: () => {}, saveProd: () => {}, delProd: () => {}, askGemini: () => alert("×”××¢×¨×›×ª ×˜×•×¢× ×ª ××©××‘×™×... ×× × ×•×•×“× ×©××ª×” ××¨×™×¥ ×“×¨×š ×©×¨×ª (Live Server)")
        };
    </script>

    <script type="module">
        // ×ª×™×§×•×Ÿ ×§×¨×™×˜×™: ×”×¤× ×™×™×” ×œ×ª×•×š ×ª×™×§×™×™×ª public
        try {
            console.log("Starting App from Root...");
            
            // ×©×™× ×™× ×• ××ª ×”× ×ª×™×‘ ×œ- ./public/js/...
            const { db } = await import('./public/js/firebase-config.js');
            const { collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot } = await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js");
            const { askGeminiAdmin } = await import('./public/js/gemini-service.js');
            
            lucide.createIcons();
            
            const statusEl = document.getElementById('status');
            statusEl.innerText = "××—×•×‘×¨ ğŸŸ¢";
            statusEl.classList.replace('text-gray-400', 'text-green-600');

            const app = {
                prods: [],
                
                init: () => { 
                    app.loadBrands(); 
                    app.loadProds(); 
                },

                switchView: (v) => {
                    document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
                    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                    document.getElementById('view-'+v).classList.add('active');
                },

                loadBrands: () => {
                    onSnapshot(collection(db, "brands"), s => {
                        const sel = document.getElementById('pBrand'); 
                        sel.innerHTML = "";
                        let hasBrands = false;
                        s.forEach(d => { 
                            hasBrands = true;
                            const o = document.createElement('option'); 
                            o.value = d.data().name; 
                            o.innerText = d.data().name; 
                            sel.appendChild(o); 
                        });
                        if(!hasBrands) sel.innerHTML = "<option>Sika (×‘×¨×™×¨×ª ××—×“×œ)</option>";
                    });
                },

                loadProds: () => {
                    onSnapshot(collection(db, "products"), s => {
                        const list = document.getElementById('pList'); 
                        list.innerHTML = ""; 
                        app.prods = [];
                        s.forEach(d => {
                            const p = {id:d.id, ...d.data()}; 
                            app.prods.push(p);
                            list.innerHTML += `
                                <div onclick="safeApp.edit('${p.id}')" class="p-3 border rounded-xl cursor-pointer hover:bg-blue-50 hover:border-blue-200 transition flex justify-between items-center group bg-white">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-gray-100 rounded flex items-center justify-center text-xs font-bold text-gray-500">${p.name.charAt(0)}</div>
                                        <div>
                                            <div class="font-bold text-sm text-gray-800">${p.name}</div>
                                            <div class="text-xs text-gray-400">${p.brand || '×œ×œ× ××•×ª×’'}</div>
                                        </div>
                                    </div>
                                    <i data-lucide="chevron-left" size="16" class="text-gray-300 group-hover:text-blue-500"></i>
                                </div>`;
                        });
                        lucide.createIcons();
                    });
                },

                edit: (id) => {
                    const p = app.prods.find(x => x.id === id);
                    if(!p) return;
                    document.getElementById('pid').value = id;
                    document.getElementById('pName').value = p.name;
                    document.getElementById('pBrand').value = p.brand;
                    document.getElementById('pDesc').value = p.marketingDesc || "";
                    document.getElementById('pImg').value = p.image || "";
                    document.getElementById('tCov').value = p.tech?.coverage || '';
                    document.getElementById('tDry').value = p.tech?.drying || '';
                    document.getElementById('tThick').value = p.tech?.thickness || '';
                },

                newProd: () => {
                    document.getElementById('pid').value = "";
                    document.querySelectorAll('input:not(#pid), textarea').forEach(i => i.value = "");
                },

                saveProd: async () => {
                    const id = document.getElementById('pid').value;
                    const d = {
                        name: document.getElementById('pName').value, 
                        brand: document.getElementById('pBrand').value,
                        marketingDesc: document.getElementById('pDesc').value, 
                        image: document.getElementById('pImg').value,
                        tech: { 
                            coverage: document.getElementById('tCov').value, 
                            drying: document.getElementById('tDry').value, 
                            thickness: document.getElementById('tThick').value 
                        }
                    };
                    
                    if(!d.name) return alert("×—×•×‘×” ×œ×”×–×™×Ÿ ×©× ××•×¦×¨");

                    const btn = event.target;
                    const originalText = btn.innerText;
                    btn.innerText = "×©×•××¨...";
                    
                    try {
                        if(id) await updateDoc(doc(db, "products", id), d); 
                        else await addDoc(collection(db, "products"), d);
                        app.newProd(); 
                        alert("× ×©××¨ ×‘×”×¦×œ×—×”!");
                    } catch(e) {
                        console.error(e);
                        alert("×©×’×™××” ×‘×©××™×¨×”: " + e.message);
                    } finally {
                        btn.innerText = originalText;
                    }
                },

                delProd: async () => { 
                    const id = document.getElementById('pid').value;
                    if(!id) return;
                    if(confirm("×œ××—×•×§ ××ª ×”××•×¦×¨ ×œ×¦××™×ª×•×ª?")) {
                        await deleteDoc(doc(db, "products", id)); 
                        app.newProd();
                    }
                },
                
                askGemini: async () => {
                    const name = document.getElementById('pName').value;
                    if(!name) return alert("×”×–×Ÿ ×©× ××•×¦×¨ ×‘×©×“×” ×”×¢×œ×™×•×Ÿ ×ª×—×™×œ×”");
                    
                    const btn = document.querySelector('button[onclick="safeApp.askGemini()"]');
                    const origContent = btn.innerHTML;
                    btn.innerHTML = `<span class="animate-spin inline-block">âŒ›</span> ×—×•×©×‘...`;
                    btn.disabled = true;

                    try {
                        const data = await askGeminiAdmin(name);
                        if(data) {
                            document.getElementById('pDesc').value = data.marketingDesc;
                            document.getElementById('tCov').value = data.tech?.coverage || '';
                            document.getElementById('tDry').value = data.tech?.drying || '';
                            document.getElementById('tThick').value = data.tech?.thickness || '';
                            const brandSelect = document.getElementById('pBrand');
                            // × ×¡×™×•×Ÿ ×œ×”×ª××™× ××•×ª×’ ××•×˜×•××˜×™×ª
                            for(let i=0; i<brandSelect.options.length; i++) {
                                if(brandSelect.options[i].value.toLowerCase().includes(data.brand.toLowerCase())) {
                                    brandSelect.selectedIndex = i;
                                    break;
                                }
                            }
                        }
                    } catch(e) {
                        console.error(e);
                        alert("×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”-AI");
                    } finally {
                        btn.innerHTML = origContent;
                        btn.disabled = false;
                    }
                }
            };
            
            window.safeApp = app;
            app.init();

        } catch(e) {
            console.error("Critical Error:", e);
            document.getElementById('status').innerText = "×©×’×™××ª × ×ª×™×‘×™× ğŸ”´";
            alert("×©×’×™××”: ×œ× ××•×¦× ××ª ×”×§×‘×¦×™× ×‘-public/js.\n×•×•×“× ×©×”×ª×™×§×™×™×” public ×§×™×™××ª ×œ×™×“ ×§×•×‘×¥ ×”-html.");
        }
    </script>
</body>
</html>
