<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sika AI - Kiosk Experience</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --brand-red: #E3000F;
            --brand-dark: #111;
            --bg-grad: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        body { font-family: 'Heebo', sans-serif; background: var(--bg-grad); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- Sika AI Avatar (Floating Bubble) --- */
        #ai-avatar-container {
            position: fixed;
            bottom: 40px;
            left: 40px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none; /*   驻专注 爪转 */
        }

        .ai-bubble {
            width: 140px; height: 140px;
            border-radius: 50%;
            border: 6px solid white;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            overflow: hidden;
            background: white;
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            pointer-events: auto;
            cursor: pointer;
        }

        .ai-bubble img { width: 100%; height: 100%; object-fit: cover; }

        /* 爪转 爪 (States) */
        /* 1. 专 - 专祝 */
        .state-idle .ai-bubble { animation: float 4s ease-in-out infinite; border-color: white; }
        
        /* 2. 砖 - 住转 专 */
        .state-thinking .ai-bubble { 
            animation: pulse-red 1.5s infinite; 
            border-color: var(--brand-red); 
            transform: scale(1.1);
        }

        /* 3. 专/注 - 拽驻抓 */
        .state-speaking .ai-bubble { animation: bounce 0.5s ease; border-color: #22c55e; }

        /* 注转 拽住 拽 注 专 (住住) */
        .status-badge {
            background: #111; color: white; padding: 6px 16px;
            border-radius: 20px; font-size: 12px; font-weight: bold;
            margin-bottom: 12px; opacity: 0; transform: translateY(10px);
            transition: 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .state-thinking .status-badge { opacity: 1; transform: translateY(0); content: "砖..."; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(227, 0, 15, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(227, 0, 15, 0); } 100% { box-shadow: 0 0 0 0 rgba(227, 0, 15, 0); } }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        /* --- Main UI --- */
        .main-container {
            max-width: 900px; margin: 60px auto; width: 100%; padding: 0 20px;
            display: flex; flex-direction: column; align-items: center; z-index: 10;
        }

        .search-box {
            width: 100%; background: white; padding: 10px; border-radius: 24px;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1); display: flex; align-items: center;
            border: 2px solid transparent; transition: 0.3s;
        }
        .search-box:focus-within { border-color: var(--brand-red); transform: translateY(-2px); }
        .search-box input { flex: 1; padding: 12px 20px; font-size: 18px; outline: none; border: none; font-weight: 500; }
        .search-btn { background: var(--brand-red); color: white; p-3; border-radius: 16px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .search-btn:hover { background: #b0000b; transform: scale(1.05); }

        /* Results Area */
        .results-area { width: 100%; margin-top: 40px; padding-bottom: 100px; display: flex; flex-direction: column; gap: 20px; opacity: 0; transition: 0.5s; transform: translateY(20px); }
        .results-area.visible { opacity: 1; transform: translateY(0); }

        /* AI Answer Bubble */
        .ai-response {
            background: white; padding: 30px; border-radius: 0 24px 24px 24px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); position: relative;
            border-left: 5px solid var(--brand-red); font-size: 18px; line-height: 1.6; color: #334155;
        }
        .ai-response::before { content: "Sika Expert"; position: absolute; top: -12px; right: 0; background: var(--brand-red); color: white; font-size: 10px; font-weight: bold; padding: 4px 12px; border-radius: 12px; }

        /* Product Cards (Injected) */
        .injected-card {
            background: white; border-radius: 20px; overflow: hidden; display: flex;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); transition: 0.3s; border: 1px solid #f1f5f9;
            animation: slideUp 0.5s ease-out;
        }
        .injected-card:hover { transform: translateY(-5px); border-color: var(--brand-red); }
        .card-img { width: 180px; padding: 20px; background: #f8fafc; display: flex; align-items: center; justify-content: center; }
        .card-img img { max-width: 100%; max-height: 100%; mix-blend-multiply; }
        .card-info { flex: 1; padding: 20px; display: flex; flex-direction: column; justify-content: center; }
        .card-title { font-size: 20px; font-weight: 900; margin-bottom: 5px; }
        .card-desc { font-size: 14px; color: #64748b; margin-bottom: 15px; }
        .card-actions { display: flex; gap: 10px; }
        
        .action-btn { padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-primary { background: var(--brand-red); color: white; }
        .btn-outline { border: 1px solid #cbd5e1; color: #475569; background: white; }
        .btn-primary:hover { background: #b0000b; }
        .btn-outline:hover { background: #f1f5f9; border-color: #94a3b8; }

        /* Video Embed */
        .video-wrapper { width: 100%; aspect-ratio: 16/9; background: black; border-radius: 20px; overflow: hidden; margin-top: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: slideUp 0.6s ease-out; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="state-idle" id="bodyState">

    <div id="ai-avatar-container">
        <div class="status-badge" id="statusText"> 拽砖...</div>
        <div class="ai-bubble" onclick="document.getElementById('mainInput').focus()">
            <img src="https://saban-94.github.io/saban-kiosk-core/public/1000187746.jpg" alt="Sika AI">
        </div>
    </div>

    <div class="main-container">
        <div class="flex items-center gap-3 mb-8">
            <div class="w-12 h-12 bg-red-600 rounded-xl flex items-center justify-center text-white font-black italic text-xl shadow-lg">S</div>
            <h1 class="text-4xl font-black text-slate-800 tracking-tight">Sika AI Center</h1>
        </div>

        <div class="search-box">
            <input type="text" id="mainInput" placeholder="砖 转 注 , 拽  驻砖 爪专..." onkeypress="if(event.key==='Enter') askSika()">
            <div class="search-btn" onclick="askSika()"><i data-lucide="send"></i></div>
        </div>

        <div class="results-area" id="resultsArea">
            <div class="ai-response" id="aiText">
                </div>
            
            <div id="dynamicContent" class="flex flex-col gap-4 mt-6">
                </div>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { askBrain } from './js/ai-brain.js';

        lucide.createIcons();

        // 注转 转 专 拽 驻砖 专
        let productsCache = [];
        let tutorialsCache = [];

        async function loadData() {
            const pSnap = await getDocs(collection(db, "products"));
            productsCache = pSnap.docs.map(d => ({id: d.id, ...d.data()}));
            
            const tSnap = await getDocs(collection(db, "tutorials"));
            tutorialsCache = tSnap.docs.map(d => ({id: d.id, ...d.data()}));
            console.log("Data Loaded for Kiosk");
        }
        loadData();

        // --- 驻拽爪转 : 砖 转 住拽 ---
        window.askSika = async () => {
            const input = document.getElementById('mainInput');
            const query = input.value.trim();
            if (!query) return;

            // 1. 砖 住 "砖"
            setRobotState('thinking');
            document.getElementById('resultsArea').classList.remove('visible');
            document.getElementById('dynamicContent').innerHTML = ""; // 拽 拽
            
            try {
                // 2. 砖 
                const response = await askBrain(query);
                
                // 3. 爪转 转爪转
                document.getElementById('resultsArea').classList.add('visible');
                
                // 驻住转 拽住 驻拽 拽
                typeWriter(response.answer, 'aiText', () => {
                    setRobotState('idle'); // 住 专
                    parseAndInject(response.answer); // 专拽转 转 注砖专
                });

            } catch (e) {
                console.error(e);
                setRobotState('idle');
                document.getElementById('aiText').innerText = "驻住, 转拽转 注 转拽砖专转. 住 砖.";
            }
            
            input.value = "";
        };

        // ---  专拽转 转 (Parser) ---
        function parseAndInject(text) {
            const container = document.getElementById('dynamicContent');

            // 1.  专拽转 爪专: {{product:Name}}
            const prodMatch = text.match(/{{product:(.*?)}}/g);
            if (prodMatch) {
                prodMatch.forEach(tag => {
                    const pName = tag.replace('{{product:', '').replace('}}', '').trim();
                    const product = productsCache.find(p => p.name.toLowerCase().includes(pName.toLowerCase()));
                    
                    if (product) {
                        const card = document.createElement('div');
                        card.className = 'injected-card';
                        card.innerHTML = `
                            <div class="card-img"><img src="${product.image || 'https://placehold.co/200'}" alt="${product.name}"></div>
                            <div class="card-info">
                                <div class="card-title">${product.name}</div>
                                <div class="card-desc">${product.marketingDesc || '爪专 拽爪注 转 住拽'}</div>
                                <div class="card-actions">
                                    <button class="action-btn btn-primary" onclick="alert('驻转 祝 爪专 ...')"> 驻专 </button>
                                    <button class="action-btn btn-outline"> 住祝 </button>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    }
                });
            }

            // 2.  专拽转 : {{video:Title}}
            const vidMatch = text.match(/{{video:(.*?)}}/g);
            if (vidMatch) {
                vidMatch.forEach(tag => {
                    const vTitle = tag.replace('{{video:', '').replace('}}', '').trim();
                    const video = tutorialsCache.find(v => v.title.toLowerCase().includes(vTitle.toLowerCase()));
                    
                    if (video) {
                        const vidId = video.url.split('v=')[1]?.split('&')[0];
                        if (vidId) {
                            const vidDiv = document.createElement('div');
                            vidDiv.className = 'video-wrapper';
                            vidDiv.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${vidId}" frameborder="0" allowfullscreen></iframe>`;
                            container.appendChild(vidDiv);
                        }
                    }
                });
            }
            
            // 住专转 拽 拽住 爪 砖转砖 (Clean up)
            const cleanText = document.getElementById('aiText').innerHTML
                .replace(/{{product:.*?}}/g, '')
                .replace(/{{video:.*?}}/g, '')
                .replace(/{{typing}}/g, '');
            document.getElementById('aiText').innerHTML = cleanText;
        }

        // --- 注专: 爪转 住 ---
        function setRobotState(state) {
            const body = document.getElementById('bodyState');
            const status = document.getElementById('statusText');
            
            body.className = `state-${state}`;
            
            if (state === 'thinking') status.innerText = "砖...";
            else if (state === 'speaking') status.innerText = "注...";
            else status.innerText = " 拽砖...";
        }

        function typeWriter(text, elementId, callback) {
            setRobotState('speaking');
            const el = document.getElementById(elementId);
            el.innerHTML = "";
            let i = 0;
            const speed = 20; // 专转 拽

            function type() {
                if (i < text.length) {
                    el.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                } else {
                    if (callback) callback();
                }
            }
            type();
        }

    </script>
</body>
</html>
