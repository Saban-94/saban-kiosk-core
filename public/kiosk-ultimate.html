<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Sika Kiosk Platinum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        /* (转 注爪  拽 + 转住驻转 专) */
        :root { --brand-primary: #111; --brand-accent: #2563eb; --brand-bg: #f8fafc; }
        body { font-family: 'Heebo', sans-serif; background-color: var(--brand-bg); overflow: hidden; user-select: none; }
        
        .product-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.03); transition: 0.3s; height: 360px; display: flex; flex-direction: column; cursor: pointer; }
        .product-card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        
        .modal-overlay { @apply fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-md; }
        .modal-overlay.open { @apply flex animate-fade-in; }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }

        /* Gallery Thumbnails */
        .thumb { width: 60px; height: 60px; border-radius: 12px; border: 2px solid transparent; cursor: pointer; opacity: 0.6; transition: 0.2s; object-fit: cover; background: white; }
        .thumb.active { border-color: var(--brand-accent); opacity: 1; transform: scale(1.1); }
        .thumb:hover { opacity: 1; }

        /* Video Modal */
        #videoModal { position: fixed; inset: 0; z-index: 100; background: black; display: none; align-items: center; justify-content: center; }
        #videoModal.open { display: flex; }
        
        /* Sidebar & General UI (注转拽 砖专) */
        .sidebar-btn { width: 100%; aspect-ratio: 1; margin-bottom: 12px; border-radius: 16px; display: flex; flex-direction: column; items-center; justify-content: center; color: #94a3b8; background: white; cursor: pointer; }
        .sidebar-btn.active { background: var(--brand-primary); color: white; transform: scale(1.1); }
        .brand-pill { background: white; padding: 5px 20px; border-radius: 50px; cursor: pointer; opacity: 0.7; filter: grayscale(100%); min-width: 120px; height: 60px; display: flex; justify-content: center; align-items: center; }
        .brand-pill.active { opacity: 1; transform: scale(1.05); filter: grayscale(0%); border: 2px solid var(--brand-accent); }
        
        /* Robot UI */
        #sikaAiWrapper { position: fixed; z-index: 9999; pointer-events: none; transition: 0.8s; }
        .state-corner { bottom: -20px; right: -20px; width: 260px; height: 260px; pointer-events: auto; }
        .state-active { bottom: 50%; right: 50%; width: 0; height: 0; }
        .robot-character { width: 100%; height: 100%; object-fit: contain; animation: floaty 4s infinite; cursor: pointer; transition: 0.6s; }
        .state-active .robot-character { position: absolute; bottom: -250px; right: 350px; width: 250px; transform: scale(1.1); }
        @keyframes floaty { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        #aiWindow { position: absolute; background: rgba(255,255,255,0.98); border-radius: 30px; border: 4px solid var(--brand-accent); overflow: hidden; display: flex; flex-direction: column; width: 600px; height: 750px; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); opacity: 0; pointer-events: auto; transition: 0.5s; }
        .state-active #aiWindow { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    </style>
</head>
<body class="flex h-screen w-screen" onload="init()">

    <nav class="w-32 bg-white h-full flex flex-col items-center py-8 shadow-2xl z-40 relative border-l border-gray-100">
        <div class="mb-10 w-20 h-20 bg-white rounded-2xl flex items-center justify-center p-2 shadow-inner"><img src="https://cdn-icons-png.flaticon.com/512/732/732200.png" class="w-full h-full object-contain"></div>
        <div onclick="switchTab('catalog')" id="btn-catalog" class="sidebar-btn active"><i data-lucide="layout-grid" size="32"></i><span class="text-[10px] font-bold mt-2">拽</span></div>
        <div onclick="switchTab('calculator')" id="btn-calculator" class="sidebar-btn"><i data-lucide="calculator" size="32"></i><span class="text-[10px] font-bold mt-2">砖</span></div>
        <div onclick="switchTab('tutorials')" id="btn-tutorials" class="sidebar-btn"><i data-lucide="play-circle" size="32"></i><span class="text-[10px] font-bold mt-2">专转</span></div>
        <div onclick="triggerInteraction()" class="sidebar-btn mt-auto text-yellow-500 border-yellow-400"><i data-lucide="bot" size="32"></i><span class="text-[10px] font-bold mt-2">Ai</span></div>
    </nav>

    <main class="flex-1 flex flex-col h-full overflow-hidden p-8 z-10 bg-slate-50 relative">
        <header class="flex flex-col gap-6 mb-6">
            <div class="flex gap-4 overflow-x-auto pb-4 pt-2 no-scrollbar items-center px-2" id="brandListContainer"></div>
            <div class="flex justify-between items-center bg-white/60 p-5 rounded-3xl shadow-sm border border-white">
                <h1 class="text-5xl font-black text-[var(--brand-primary)]" id="heroTitle">专 拽爪注</h1>
                <input id="searchInput" oninput="filterProducts()" class="w-[450px] bg-white p-4 pr-12 rounded-2xl shadow-sm outline-none font-bold text-lg" placeholder="驻砖 爪专...">
            </div>
        </header>

        <div id="productGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 pb-32 overflow-y-auto"></div>
        
        <div id="view-calculator" class="hidden h-full flex items-center justify-center"><h2 class="text-4xl font-bold">砖</h2></div>
        <div id="view-tutorials" class="hidden h-full"><h2 class="text-4xl font-bold">专转</h2></div>
    </main>

    <div id="productModal" class="modal-overlay">
        <div class="bg-white rounded-[40px] shadow-2xl w-[90vw] h-[85vh] flex overflow-hidden relative animate-fade-in">
            <button onclick="closeModal()" class="absolute top-6 left-6 z-20 bg-white/80 p-3 rounded-full hover:bg-white shadow-lg"><i data-lucide="x" size="28"></i></button>
            
            <div class="w-[45%] bg-gray-50 p-8 flex flex-col items-center justify-center border-l border-gray-100 relative">
                <div class="flex-1 w-full flex items-center justify-center relative">
                    <img id="mImage" src="" class="max-h-full max-w-full object-contain mix-blend-multiply z-10 transition-all duration-300">
                    
                    <button id="btnPlayVideo" onclick="playVideo()" class="absolute z-20 bg-red-600 text-white p-4 rounded-full shadow-xl hover:scale-110 transition hidden">
                        <i data-lucide="play" size="32" fill="white"></i>
                    </button>
                </div>
                
                <div id="mGallery" class="h-20 mt-6 flex gap-3 overflow-x-auto w-full justify-center px-4"></div>
            </div>

            <div class="w-[55%] p-14 overflow-y-auto bg-white flex flex-col">
                <h2 class="text-5xl font-black mb-4 leading-tight text-gray-900" id="mName"></h2>
                <div class="bg-[var(--brand-bg)] p-6 rounded-2xl border-r-4 border-[var(--brand-accent)] mb-8">
                    <p id="mDesc" class="text-xl text-gray-800 font-medium leading-relaxed"></p>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-10 text-center">
                    <div class="bg-gray-50 p-4 rounded-xl"><span class="text-sm text-gray-500 font-bold block mb-1">住</span><span class="text-lg font-black" id="mCov">-</span></div>
                    <div class="bg-gray-50 p-4 rounded-xl"><span class="text-sm text-gray-500 font-bold block mb-1">砖</span><span class="text-lg font-black" id="mDry">-</span></div>
                    <div class="bg-gray-50 p-4 rounded-xl"><span class="text-sm text-gray-500 font-bold block mb-1">注</span><span class="text-lg font-black" id="mThick">-</span></div>
                </div>
                <button onclick="triggerInteraction(true)" class="mt-auto bg-[var(--brand-primary)] text-white py-5 rounded-2xl font-black text-2xl shadow-xl hover:scale-[1.02] transition flex items-center justify-center gap-3">
                    <i data-lucide="message-circle"></i> 砖 转 
                </button>
            </div>
        </div>
    </div>

    <div id="videoModal" onclick="this.classList.remove('open'); document.getElementById('vidFrame').src=''">
        <div class="w-[80vw] aspect-video bg-black rounded-3xl overflow-hidden shadow-2xl">
            <iframe id="vidFrame" class="w-full h-full" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        </div>
    </div>

    <div id="sikaAiWrapper" class="state-corner">
        <div class="robot-character" onclick="triggerInteraction()"><img src="https://saban-kiosk-core.pages.dev/admin/sika-ai.png" class="w-full h-full object-contain"></div>
        <div id="aiWindow">
            <div class="bg-black p-4 text-white flex justify-between"><span class="font-bold">Sika Expert</span><button onclick="event.stopPropagation(); closeInteraction()"><i data-lucide="x"></i></button></div>
            <div class="flex-1 bg-gray-100 p-4" id="chatArea"></div>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        
        lucide.createIcons();
        let allProducts = [], currentProduct = null;

        window.init = async () => {
            onSnapshot(collection(db, "brands"), s => {
                const c = document.getElementById('brandListContainer'); c.innerHTML = "";
                s.forEach(d => c.innerHTML += `<div onclick="filterBrand('${d.data().name}')" class="brand-pill"><img src="${d.data().logo}"></div>`);
            });
            onSnapshot(collection(db, "products"), s => {
                allProducts = []; s.forEach(d => allProducts.push({id: d.id, ...d.data()}));
                renderGrid(allProducts);
            });
        };

        function renderGrid(list) {
            document.getElementById('productGrid').innerHTML = list.map(p => `
                <div onclick="openProduct('${p.id}')" class="product-card group">
                    <div class="h-[60%] flex items-center justify-center p-6 bg-white group-hover:bg-gray-50 transition">
                        <img src="${p.image || 'https://placehold.co/200'}" class="max-h-full object-contain mix-blend-multiply group-hover:scale-110 transition duration-500">
                    </div>
                    <div class="p-5 flex-1 bg-white border-t border-gray-100">
                        <div class="text-xs font-bold text-gray-400 uppercase mb-1">${p.brand}</div>
                        <h3 class="text-xl font-black text-gray-900 leading-tight">${p.name}</h3>
                    </div>
                </div>`).join('');
        }

        window.openProduct = (id) => {
            const p = allProducts.find(x => x.id === id);
            currentProduct = p;
            document.getElementById('mName').innerText = p.name;
            document.getElementById('mDesc').innerText = p.marketingDesc || "";
            document.getElementById('mImage').src = p.image || '';
            document.getElementById('mCov').innerText = p.tech?.coverage || '-';
            document.getElementById('mDry').innerText = p.tech?.drying || '-';
            document.getElementById('mThick').innerText = p.tech?.thickness || '-';
            
            // Video Logic
            const btnVid = document.getElementById('btnPlayVideo');
            if(p.video && p.video.includes('youtube')) {
                btnVid.classList.remove('hidden');
                btnVid.dataset.url = p.video;
            } else {
                btnVid.classList.add('hidden');
            }

            // Gallery Logic
            const galDiv = document.getElementById('mGallery');
            galDiv.innerHTML = "";
            
            // Add main image as first thumbnail
            const images = [p.image, ...(p.gallery || [])].filter(Boolean);
            
            if(images.length > 1) {
                images.forEach((url, i) => {
                    galDiv.innerHTML += `<img src="${url}" onclick="changeImg('${url}', this)" class="thumb ${i===0?'active':''}">`;
                });
            }

            document.getElementById('productModal').classList.add('open');
        };

        window.changeImg = (url, el) => {
            document.getElementById('mImage').src = url;
            document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
        };

        window.playVideo = () => {
            const url = currentProduct.video;
            let vidId = "";
            try { vidId = url.split('v=')[1].split('&')[0]; } catch(e){}
            if(vidId) {
                document.getElementById('vidFrame').src = `https://www.youtube.com/embed/${vidId}?autoplay=1`;
                document.getElementById('videoModal').classList.add('open');
            }
        };

        window.closeModal = () => document.getElementById('productModal').classList.remove('open');
        window.triggerInteraction = (auto) => {
             document.getElementById('sikaAiWrapper').classList.add('state-active');
             document.getElementById('sikaAiWrapper').classList.remove('state-corner');
             if(auto) document.getElementById('chatArea').innerHTML = ` 砖!  专 砖转 转注 -${currentProduct.name}.  注专?`;
        };
        window.closeInteraction = () => {
             document.getElementById('sikaAiWrapper').classList.remove('state-active');
             document.getElementById('sikaAiWrapper').classList.add('state-corner');
        };
        window.switchTab = (t) => {
            document.getElementById('productGrid').style.display = t==='catalog'?'grid':'none';
            document.getElementById('view-calculator').style.display = t==='calculator'?'flex':'none';
        };
        window.filterProducts = () => {
            const t = document.getElementById('searchInput').value.toLowerCase();
            renderGrid(allProducts.filter(p => p.name.toLowerCase().includes(t)));
        };
        window.init = init;
    </script>
</body>
</html>
