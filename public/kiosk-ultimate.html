<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sika Kiosk Fixed</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --brand-primary: #111; --brand-accent: #2563eb; --brand-bg: #f8fafc; }
        body.theme-sika { --brand-primary: #FFC500; --brand-accent: #E3000F; --brand-bg: #fffceb; }
        body.theme-thermokir { --brand-primary: #0057B8; --brand-accent: #F58220; --brand-bg: #f0f9ff; }
        body.theme-misterfix { --brand-primary: #E3000F; --brand-accent: #333333; --brand-bg: #fff1f2; }
        body.theme-nirlat { --brand-primary: #8BC53F; --brand-accent: #009640; --brand-bg: #f0fff4; }
        body.theme-tambour { --brand-primary: #E31E24; --brand-accent: #E31E24; --brand-bg: #fff5f5; }
        body.theme-bg { --brand-primary: #F37021; --brand-accent: #000; --brand-bg: #fff7f0; }

        body { font-family: 'Heebo', sans-serif; background-color: var(--brand-bg); color: #1e293b; overflow: hidden; height: 100vh; display: flex; transition: background-color 0.5s; }

        /* SIDEBAR */
        .sidebar { width: 100px; background: white; height: 100%; display: flex; flex-direction: column; align-items: center; padding: 20px 10px; box-shadow: -5px 0 20px rgba(0,0,0,0.05); z-index: 50; }
        .sidebar-btn { width: 100%; aspect-ratio: 1; border-radius: 16px; margin-bottom: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; transition: 0.2s; cursor: pointer; border: 2px solid transparent; }
        .sidebar-btn:hover { background: #f1f5f9; color: var(--brand-primary); }
        .sidebar-btn.active { background: var(--brand-primary); color: white; border: none; box-shadow: 0 10px 20px -5px rgba(0,0,0,0.2); }
        body.theme-sika .sidebar-btn.active { color: black; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 30px; overflow: hidden; display: flex; flex-direction: column; position: relative; z-index: 10; }
        
        /* BRANDS */
        .brands-container { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; flex-shrink: 0; }
        .brand-pill { background: white; padding: 0 20px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid transparent; transition: 0.3s; opacity: 0.7; filter: grayscale(100%); min-width: 120px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .brand-pill.active, .brand-pill:hover { opacity: 1; border-color: var(--brand-accent); transform: scale(1.05); filter: grayscale(0%); }
        .brand-pill img { height: 30px; object-fit: contain; }

        /* VIEWS (Fixing overlap) */
        .view-section { display: none; height: 100%; flex-direction: column; animation: fadeIn 0.4s; }
        .view-section.active { display: flex; }
        
        /* GRID */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; overflow-y: auto; padding-bottom: 100px; padding-right: 5px; }
        .card { background: white; border-radius: 20px; overflow: hidden; height: 320px; display: flex; flex-direction: column; box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer; transition: 0.3s; border: 2px solid transparent; }
        .card:hover { transform: translateY(-5px); border-color: var(--brand-accent); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .card-img { flex: 1; padding: 20px; display: flex; align-items: center; justify-content: center; }
        .card-img img { max-height: 100%; max-width: 100%; object-fit: contain; mix-blend-mode: multiply; }

        /* ROBOT & CHAT (Z-Index Fix) */
        #robotWrapper { position: fixed; bottom: 20px; right: 20px; z-index: 100; pointer-events: none; }
        .robot-img { width: 220px; cursor: pointer; pointer-events: auto; transition: 0.5s; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.2)); }
        .robot-img:hover { transform: scale(1.05); }
        /* When active, move robot to side */
        #robotWrapper.active .robot-img { transform: translateX(-350px) scale(1.2); }

        #chatWindow { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); 
            width: 500px; height: 600px; background: rgba(255,255,255,0.98); 
            border-radius: 24px; box-shadow: 0 50px 100px rgba(0,0,0,0.3); 
            border: 3px solid var(--brand-accent); display: flex; flex-direction: column; 
            opacity: 0; pointer-events: none; transition: 0.3s; z-index: 101; 
        }
        #chatWindow.open { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }

        /* UTILS */
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body onload="init()">

    <div class="sidebar">
        <div class="mb-10 font-black text-2xl">S</div>
        <div onclick="switchView('catalog')" id="btn-catalog" class="sidebar-btn active"><i data-lucide="layout-grid" size="28"></i><span class="text-xs font-bold mt-1">קטלוג</span></div>
        <div onclick="switchView('calc')" id="btn-calc" class="sidebar-btn"><i data-lucide="calculator" size="28"></i><span class="text-xs font-bold mt-1">מחשבון</span></div>
        <div onclick="toggleChat()" class="sidebar-btn mt-auto text-yellow-600"><i data-lucide="bot" size="32"></i><span class="text-xs font-bold mt-1">Ai</span></div>
    </div>

    <div class="main-content">
        <div class="flex flex-col gap-4 mb-6">
            <div class="brands-container no-scrollbar" id="brandList">
                <div class="brand-pill active">טוען...</div>
            </div>
            <div class="flex justify-between items-center bg-white/70 p-4 rounded-2xl shadow-sm border border-white">
                <h1 class="text-3xl font-black text-[var(--brand-primary)]" id="pageTitle">המרכז המקצועי</h1>
                <input id="search" oninput="filterProds()" class="bg-white px-4 py-2 rounded-xl outline-none font-bold w-64 text-sm shadow-sm" placeholder="חיפוש...">
            </div>
        </div>

        <div id="view-catalog" class="view-section active">
            <div id="grid" class="product-grid"></div>
        </div>

        <div id="view-calc" class="view-section items-center justify-center">
            <div class="bg-white p-10 rounded-3xl shadow-xl w-[500px] text-center border-4 border-[var(--brand-accent)]">
                <h2 class="text-3xl font-black mb-6">מחשבון כמויות</h2>
                <input id="cA" type="number" class="w-full p-3 mb-3 bg-gray-50 rounded-xl border text-center font-bold text-lg" placeholder="שטח (מ''ר)">
                <input id="cC" type="number" class="w-full p-3 mb-6 bg-gray-50 rounded-xl border text-center font-bold text-lg" placeholder="צריכה (ק''ג למ''ר)">
                <div class="text-5xl font-black mb-6" id="calcRes">0</div>
                <button onclick="doCalc()" class="w-full bg-[var(--brand-accent)] text-white py-3 rounded-xl font-bold text-xl">חשב</button>
            </div>
        </div>
    </div>

    <div id="robotWrapper">
        <img src="https://saban-kiosk-core.pages.dev/admin/sika-ai.png" class="robot-img" onclick="toggleChat()">
    </div>

    <div id="chatWindow">
        <div class="bg-black text-white p-4 flex justify-between items-center">
            <div class="font-bold">Sika Expert</div>
            <button onclick="toggleChat()"><i data-lucide="x"></i></button>
        </div>
        <div class="flex-1 p-4 bg-gray-50 overflow-y-auto" id="chatLog">
            <div class="bg-white p-3 rounded-xl w-fit shadow-sm text-sm">היי! אני כאן לכל שאלה.</div>
        </div>
        <div class="p-3 bg-white border-t flex gap-2">
            <input id="chatInput" class="flex-1 p-2 rounded-lg border bg-gray-50 outline-none" placeholder="הקלד כאן...">
            <button onclick="sendMsg()" class="bg-blue-600 text-white p-2 rounded-lg"><i data-lucide="send" size="18"></i></button>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        
        lucide.createIcons();
        let allProducts = [], currentProducts = [];

        // Stable Mock Data (If DB fails)
        const mockProducts = [
            { id: "1", name: "Sika TopSeal 107", brand: "Sika", image: "https://placehold.co/300x300/fff/000?text=Sika+107" },
            { id: "2", name: "Thermokir 603", brand: "Thermokir", image: "https://placehold.co/300x300/fff/0057B8?text=Thermo+603" }
        ];

        window.init = async () => {
            // טעינת מותגים
            onSnapshot(collection(db, "brands"), (snap) => {
                const list = document.getElementById('brandList');
                list.innerHTML = `<div onclick="setTheme('default', this)" class="brand-pill active">הכל</div>`;
                snap.forEach(d => {
                    const b = d.data();
                    list.innerHTML += `<div onclick="setTheme('${b.themeColor || 'default'}', this)" class="brand-pill"><img src="${b.logo}"></div>`;
                });
            });

            // טעינת מוצרים
            try {
                const snap = await getDocs(collection(db, "products"));
                if(snap.empty) throw new Error("Empty");
                snap.forEach(d => allProducts.push({id: d.id, ...d.data()}));
            } catch(e) { allProducts = mockProducts; }
            
            currentProducts = allProducts;
            render(allProducts);
        }

        window.render = (list) => {
            const grid = document.getElementById('grid');
            if(!grid) return;
            grid.innerHTML = list.map(p => `
                <div class="card">
                    <div class="card-img"><img src="${p.image}"></div>
                    <div class="p-4 border-t">
                        <div class="text-xs text-gray-400 font-bold uppercase">${p.brand}</div>
                        <div class="font-bold text-lg leading-tight">${p.name}</div>
                    </div>
                </div>`).join('');
        }

        window.setTheme = (theme, el) => {
            document.body.className = `theme-${theme}`;
            document.querySelectorAll('.brand-pill').forEach(p => p.classList.remove('active'));
            if(el) el.classList.add('active');
            
            // Filter products
            const term = theme === 'default' ? '' : (theme === 'misterfix' ? 'Fix' : theme);
            currentProducts = term ? allProducts.filter(p => p.brand.toLowerCase().includes(term)) : allProducts;
            render(currentProducts);
        }

        window.switchView = (v) => {
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+v).classList.add('active');
            
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
        }

        window.toggleChat = () => {
            document.getElementById('chatWindow').classList.toggle('open');
            document.getElementById('robotWrapper').classList.toggle('active');
        }

        window.sendMsg = () => {
            const inp = document.getElementById('chatInput');
            if(!inp.value) return;
            const log = document.getElementById('chatLog');
            log.innerHTML += `<div class="bg-blue-600 text-white p-3 rounded-xl w-fit mb-2 mr-auto text-sm">${inp.value}</div>`;
            inp.value = "";
            setTimeout(() => {
                log.innerHTML += `<div class="bg-white p-3 rounded-xl w-fit mb-2 shadow-sm text-sm">בודק במפרט...</div>`;
                log.scrollTop = log.scrollHeight;
            }, 800);
        }

        window.doCalc = () => {
            const a = document.getElementById('cA').value, c = document.getElementById('cC').value;
            if(a && c) document.getElementById('calcRes').innerText = (a*c).toFixed(1);
        }

        window.filterProds = () => {
            const t = document.getElementById('search').value.toLowerCase();
            render(currentProducts.filter(p => p.name.toLowerCase().includes(t)));
        }

        window.init = init;
    </script>
</body>
</html>
