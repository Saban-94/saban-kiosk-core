<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sika Kiosk Stable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: sans-serif; background: #f8fafc; overflow: hidden; }
        .sidebar { width: 100px; background: white; height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.05); z-index: 20; }
        .sidebar-btn { width: 100%; aspect-ratio: 1; border-radius: 16px; margin-bottom: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #aaa; transition: 0.3s; cursor: pointer; }
        .sidebar-btn.active { background: #111; color: white; transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .main { flex: 1; padding: 30px; display: flex; flex-direction: column; height: 100vh; }
        .brand-scroller { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; }
        .brand-pill { background: white; padding: 5px 20px; border-radius: 50px; cursor: pointer; opacity: 0.6; transition: 0.3s; border: 2px solid transparent; min-width: 100px; text-align: center; font-weight: bold; }
        .brand-pill.active { opacity: 1; border-color: #2563eb; transform: scale(1.05); }
        
        .grid-prods { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; overflow-y: auto; padding-bottom: 100px; }
        .card { background: white; border-radius: 20px; overflow: hidden; height: 350px; display: flex; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,0.03); transition: 0.3s; cursor: pointer; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); border: 2px solid #2563eb; }
        .card-img { height: 60%; background: #f9f9f9; display: flex; align-items: center; justify-content: center; }
        .card-img img { max-height: 80%; mix-blend-mode: multiply; }
        
        /* Robot */
        .robot { position: fixed; bottom: -20px; right: -20px; width: 250px; transition: 0.5s; cursor: pointer; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.2)); }
        .robot:hover { transform: scale(1.05); }
        .robot.active { bottom: 50%; right: 50%; transform: translate(50%, 50%) scale(1.5); pointer-events: none; opacity: 0; }
        
        /* Chat Window */
        .chat-win { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); width: 600px; height: 700px; background: white; border-radius: 30px; box-shadow: 0 50px 100px rgba(0,0,0,0.5); opacity: 0; pointer-events: none; transition: 0.4s; display: flex; flex-direction: column; overflow: hidden; border: 4px solid #2563eb; z-index: 100; }
        .chat-win.open { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 50; }
        .modal-overlay.open { display: flex; }
    </style>
</head>
<body class="flex">

    <div class="sidebar">
        <div class="mb-8 font-black text-2xl">S</div>
        <div onclick="setTab('catalog')" id="t-catalog" class="sidebar-btn active"><i data-lucide="layout-grid"></i></div>
        <div onclick="setTab('calc')" id="t-calc" class="sidebar-btn"><i data-lucide="calculator"></i></div>
        <div onclick="openChat()" class="sidebar-btn text-yellow-500"><i data-lucide="bot"></i></div>
    </div>

    <div class="main">
        <div class="brand-scroller no-scrollbar">
            <div onclick="filterBrand('all', this)" class="brand-pill active">הכל</div>
            <div onclick="filterBrand('SIKA', this)" class="brand-pill">SIKA</div>
            <div onclick="filterBrand('THERMOKIR', this)" class="brand-pill">THERMOKIR</div>
            <div onclick="filterBrand('MISTER FIX', this)" class="brand-pill">MISTER FIX</div>
            <div onclick="filterBrand('BG BOND', this)" class="brand-pill">BG BOND</div>
            <div onclick="filterBrand('NIRLAT', this)" class="brand-pill">NIRLAT</div>
            <div onclick="filterBrand('TAMBOUR', this)" class="brand-pill">TAMBOUR</div>
        </div>

        <h1 class="text-4xl font-black mb-6">קטלוג מוצרים</h1>

        <div id="grid" class="grid-prods"></div>
    </div>

    <img src="https://saban-kiosk-core.pages.dev/admin/sika-ai.png" class="robot" id="robot" onclick="openChat()">
    
    <div class="chat-win" id="chatWin">
        <div class="bg-black text-white p-4 flex justify-between items-center">
            <span class="font-bold text-lg">Sika Expert Ai</span>
            <button onclick="closeChat()"><i data-lucide="x"></i></button>
        </div>
        <div class="flex-1 p-6 bg-gray-50 overflow-y-auto" id="chatLog">
            <div class="bg-white p-4 rounded-xl shadow-sm mb-2 w-fit">היי! אני כאן לעזור. מה אתה מחפש היום?</div>
        </div>
        <div class="p-4 border-t bg-white flex gap-2">
            <input id="chatIn" class="flex-1 p-3 border rounded-xl" placeholder="הקלד הודעה...">
            <button onclick="sendMsg()" class="bg-blue-600 text-white p-3 rounded-xl"><i data-lucide="send"></i></button>
        </div>
    </div>

    <div id="prodModal" class="modal-overlay">
        <div class="bg-white w-[900px] h-[600px] rounded-3xl flex overflow-hidden relative">
            <button onclick="document.getElementById('prodModal').classList.remove('open')" class="absolute top-4 left-4 p-2 bg-gray-100 rounded-full"><i data-lucide="x"></i></button>
            <div class="w-1/2 bg-gray-50 flex items-center justify-center p-10"><img id="mImg" class="max-w-full max-h-full mix-blend-multiply"></div>
            <div class="w-1/2 p-10 flex flex-col">
                <h2 id="mTitle" class="text-4xl font-black mb-4"></h2>
                <p id="mDesc" class="text-xl text-gray-600 mb-8"></p>
                <div class="grid grid-cols-3 gap-4 mb-auto text-center">
                    <div class="bg-gray-100 p-3 rounded-xl"><div class="text-xs text-gray-500">כיסוי</div><div class="font-bold" id="mCov">-</div></div>
                    <div class="bg-gray-100 p-3 rounded-xl"><div class="text-xs text-gray-500">ייבוש</div><div class="font-bold" id="mDry">-</div></div>
                    <div class="bg-gray-100 p-3 rounded-xl"><div class="text-xs text-gray-500">עובי</div><div class="font-bold" id="mThick">-</div></div>
                </div>
                <button onclick="askAboutProduct()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-xl shadow-lg">שאל את המומחה</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        
        lucide.createIcons();
        let products = [];
        let currentProd = null;

        // 100% STABLE PLACEHOLDERS (No more 404s!)
        const MOCK = [
            { id: "1", name: "Sika TopSeal 107", brand: "SIKA", image: "https://placehold.co/400?text=SIKA+107", desc: "איטום צמנטי מעולה.", tech: {coverage: "3kg", drying: "6h", thickness: "2mm"} },
            { id: "2", name: "Thermokir 603", brand: "THERMOKIR", image: "https://placehold.co/400?text=Thermo+603", desc: "טיח תרמי מבודד.", tech: {coverage: "14kg", drying: "48h", thickness: "30mm"} },
            { id: "3", name: "Mister Fix 109", brand: "MISTER FIX", image: "https://placehold.co/400?text=Fix+109", desc: "דבק אקרילי.", tech: {coverage: "5kg", drying: "24h", thickness: "5mm"} },
            { id: "4", name: "BG Bond 10", brand: "BG BOND", image: "https://placehold.co/400?text=BG+10", desc: "מסטיק איטום.", tech: {coverage: "-", drying: "12h", thickness: "-"} },
            { id: "5", name: "Nirlat Super", brand: "NIRLAT", image: "https://placehold.co/400?text=Nirlat", desc: "צבע אקרילי.", tech: {coverage: "9m", drying: "2h", thickness: "-"} },
            { id: "6", name: "Tambour Super", brand: "TAMBOUR", image: "https://placehold.co/400?text=Tambour", desc: "צבע סופרקריל.", tech: {coverage: "10m", drying: "2h", thickness: "-"} }
        ];

        window.init = async () => {
            try {
                const snap = await getDocs(collection(db, "products"));
                if(snap.empty) products = MOCK;
                else { products = []; snap.forEach(d => products.push({id:d.id, ...d.data()})); }
            } catch(e) { products = MOCK; }
            render(products);
        };

        window.render = (list) => {
            document.getElementById('grid').innerHTML = list.map(p => `
                <div class="card" onclick="openProd('${p.id}')">
                    <div class="card-img"><img src="${p.image || 'https://placehold.co/400'}"></div>
                    <div class="p-4">
                        <div class="text-xs text-gray-400 font-bold">${p.brand}</div>
                        <div class="text-xl font-black leading-tight">${p.name}</div>
                    </div>
                </div>`).join('');
        };

        window.filterBrand = (b, el) => {
            document.querySelectorAll('.brand-pill').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            render(b === 'all' ? products : products.filter(p => p.brand.includes(b)));
        };

        window.openProd = (id) => {
            currentProd = products.find(x => x.id === id);
            document.getElementById('mTitle').innerText = currentProd.name;
            document.getElementById('mDesc').innerText = currentProd.desc || currentProd.marketingDesc || "אין תיאור";
            document.getElementById('mImg').src = currentProd.image || 'https://placehold.co/400';
            const t = currentProd.tech || {};
            document.getElementById('mCov').innerText = t.coverage || '-';
            document.getElementById('mDry').innerText = t.drying || '-';
            document.getElementById('mThick').innerText = t.thickness || '-';
            document.getElementById('prodModal').classList.add('open');
        };

        // Chat Logic
        window.openChat = () => {
            document.getElementById('robot').classList.add('active');
            document.getElementById('chatWin').classList.add('open');
        };
        window.closeChat = () => {
            document.getElementById('chatWin').classList.remove('open');
            document.getElementById('robot').classList.remove('active');
        };
        window.askAboutProduct = () => {
            document.getElementById('prodModal').classList.remove('open');
            openChat();
            setTimeout(() => addMsg(`אני רואה שאתה מתעניין ב-${currentProd.name}. מה תרצה לדעת?`, 'bot'), 500);
        };
        window.sendMsg = () => {
            const val = document.getElementById('chatIn').value;
            if(!val) return;
            addMsg(val, 'user');
            document.getElementById('chatIn').value = "";
            setTimeout(() => addMsg("בודק במפרט הטכני...", 'bot'), 1000);
        };
        function addMsg(txt, who) {
            const d = document.createElement('div');
            d.className = who==='bot' ? "bg-white p-4 rounded-xl shadow-sm mb-2 w-fit" : "bg-blue-600 text-white p-4 rounded-xl mb-2 w-fit mr-auto";
            d.innerText = txt;
            document.getElementById('chatLog').appendChild(d);
        }

        window.onload = init;
    </script>
</body>
</html>
