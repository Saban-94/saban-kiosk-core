<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sika AI Kiosk - Master</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --brand-red: #E3000F; --brand-dark: #111; }
        body { font-family: 'Heebo', sans-serif; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); height: 100vh; overflow: hidden; display: flex; }

        /* --- Robot Avatar --- */
        #robot-container { position: fixed; bottom: -20px; left: 20px; z-index: 50; pointer-events: none; transition: 0.5s; }
        .robot-img { width: 450px; filter: drop-shadow(0 20px 40px rgba(0,0,0,0.3)); animation: float 6s ease-in-out infinite; transform-origin: bottom center; }
        .state-thinking .robot-img { animation: pulse 1s infinite alternate; filter: drop-shadow(0 0 30px var(--brand-red)); }
        
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.02); } }

        /* --- Main UI --- */
        .main-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; transition: 0.5s; z-index: 10; }
        .main-area.sidebar-open { margin-right: 480px; align-items: flex-start; padding-right: 60px; }

        .search-container { width: 100%; max-width: 800px; text-align: center; }
        .logo-text { font-size: 4rem; font-weight: 900; color: var(--brand-dark); margin-bottom: 20px; letter-spacing: -2px; }
        .logo-text span { color: var(--brand-red); }

        .search-box { background: white; border-radius: 50px; box-shadow: 0 20px 50px -10px rgba(0,0,0,0.15); display: flex; align-items: center; padding: 12px; border: 2px solid transparent; transition: 0.3s; }
        .search-box:focus-within { border-color: var(--brand-red); transform: scale(1.02); }
        .search-input { flex: 1; padding: 10px 20px; font-size: 22px; outline: none; font-weight: 500; background: transparent; }
        .search-btn { width: 64px; height: 64px; border-radius: 50%; background: var(--brand-red); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; box-shadow: 0 10px 20px rgba(227,0,15,0.3); }
        .search-btn:hover { transform: scale(1.1) rotate(-10deg); }

        /* AI Chat Bubble */
        .ai-bubble { margin-top: 40px; background: white; padding: 30px; border-radius: 0 30px 30px 30px; box-shadow: 0 15px 40px rgba(0,0,0,0.05); width: 100%; font-size: 20px; line-height: 1.6; color: #334155; border-right: 6px solid var(--brand-red); opacity: 0; transform: translateY(20px); transition: 0.5s; }
        .ai-bubble.visible { opacity: 1; transform: translateY(0); }

        /* Right Panel (Product) */
        #right-panel { position: fixed; top: 0; right: 0; bottom: 0; width: 480px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); box-shadow: -10px 0 50px rgba(0,0,0,0.05); padding: 30px; transform: translateX(110%); transition: 0.5s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 40; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        #right-panel.open { transform: translateX(0); }

        .p-card { background: white; border-radius: 24px; overflow: hidden; border: 1px solid #f1f5f9; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1); animation: slideIn 0.5s; }
        .p-image { height: 250px; background: #f8fafc; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .p-image img { max-height: 100%; object-fit: contain; mix-blend-multiply; }
        .p-content { padding: 25px; }
        .p-tag { font-size: 10px; font-weight: 900; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
        .p-title { font-size: 24px; font-weight: 900; color: #1e293b; line-height: 1.1; margin: 5px 0 15px 0; }
        
        .p-specs { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 20px; }
        .spec-box { background: #f1f5f9; padding: 8px; border-radius: 12px; text-align: center; }
        .spec-lbl { font-size: 10px; color: #64748b; font-weight: bold; display: block; }
        .spec-val { font-size: 13px; font-weight: 900; color: #334155; }

        @keyframes slideIn { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
    </style>
</head>
<body>

    <div id="robot-container">
        <img src="https://saban-94.github.io/saban-kiosk-core/public/1000187746.jpg" class="robot-img" alt="AI Robot">
    </div>

    <div class="main-area" id="mainArea">
        <div class="search-container">
            <div class="logo-text">Sika<span>.Ai</span></div>
            
            <div class="search-box">
                <input type="text" id="mainInput" class="search-input" placeholder="שאל אותי על איטום, הדבקה או חפש מוצר..." onkeypress="if(event.key==='Enter') askSika()">
                <div class="search-btn" onclick="askSika()"><i data-lucide="send"></i></div>
            </div>

            <div id="aiBubble" class="ai-bubble">
                <span id="aiText"></span><span class="animate-pulse">|</span>
            </div>
        </div>
    </div>

    <div id="right-panel"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // --- תיקון קריטי: הגדרות מוטמעות (למניעת שגיאת הייבוא) ---
        const firebaseConfig = {
          apiKey: "AIzaSyDZuI7AaDZVteUhUT_eIVCR5SIdU0jhqUg",
          authDomain: "saban-kiosk-core.firebaseapp.com",
          projectId: "saban-kiosk-core",
          storageBucket: "saban-kiosk-core.firebasestorage.app",
          messagingSenderId: "866976260818",
          appId: "1:866976260818:web:0e3ec12df72291c77f430b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        lucide.createIcons();

        // Local Cache
        let productsDB = [];
        let rulesDB = [];

        // Load Data Once
        async function loadData() {
            try {
                // Products
                const pSnap = await getDocs(collection(db, "products"));
                productsDB = pSnap.docs.map(d => ({id: d.id, ...d.data()}));
                
                // Chat Rules (The Brain)
                const rSnap = await getDocs(collection(db, "chat_rules"));
                rulesDB = rSnap.docs.map(d => d.data());
                
                console.log("System Loaded:", productsDB.length, "Products,", rulesDB.length, "Rules");
            } catch(e) {
                console.error("Loading Error:", e);
                document.getElementById('aiText').innerText = "שגיאה בטעינת נתונים. בדוק חיבור.";
                document.getElementById('aiBubble').classList.add('visible');
            }
        }
        loadData();

        // --- Core Function: Ask Sika ---
        window.askSika = async () => {
            const input = document.getElementById('mainInput');
            const queryText = input.value.trim().toLowerCase();
            if (!queryText) return;

            // UI Reset
            setRobotState('thinking');
            document.getElementById('aiBubble').classList.remove('visible');
            document.getElementById('right-panel').classList.remove('open');
            document.getElementById('mainArea').classList.remove('sidebar-open');
            document.getElementById('right-panel').innerHTML = "";

            // Simulate Thinking Delay
            setTimeout(() => {
                const result = processQuery(queryText);
                
                // Show Answer
                document.getElementById('aiBubble').classList.add('visible');
                typeWriter(result.answer, 'aiText', () => {
                    setRobotState('idle');
                    if(result.product) showProduct(result.product);
                });
            }, 1000);

            input.value = "";
        };

        // --- The "Brain" Logic ---
        function processQuery(text) {
            let answer = "אני לא בטוח לגבי זה, אבל אני יכול לחפש מוצר ספציפי אם תרצה.";
            let foundProduct = null;

            // 1. Search in Rules (Exact or partial match)
            const rule = rulesDB.find(r => text.includes(r.trigger));
            if (rule) {
                answer = rule.response;
                // Check if rule points to a product {{product:Name}}
                const prodMatch = rule.response.match(/{{product:(.*?)}}/);
                if(prodMatch) {
                    const pName = prodMatch[1].trim();
                    foundProduct = productsDB.find(p => p.name.toLowerCase().includes(pName.toLowerCase()));
                    answer = answer.replace(prodMatch[0], ""); // Remove tag from text
                }
            } 
            // 2. If no rule, Search directly in Products
            else {
                const prod = productsDB.find(p => 
                    p.name.toLowerCase().includes(text) || 
                    (p.category && p.category.includes(text))
                );
                if (prod) {
                    answer = `מצאתי את **${prod.name}**. הנה הפרטים עליו:`;
                    foundProduct = prod;
                }
            }

            return { answer, product: foundProduct };
        }

        // --- Render Product ---
        function showProduct(p) {
            const panel = document.getElementById('right-panel');
            
            const html = `
                <div class="p-card">
                    <div class="p-image">
                        <img src="${p.image || 'https://placehold.co/300'}" alt="${p.name}">
                    </div>
                    <div class="p-content">
                        <div class="p-tag">${p.brand || 'Sika'} / ${p.category || 'כללי'}</div>
                        <h2 class="p-title">${p.name}</h2>
                        
                        <div class="p-specs">
                            <div class="spec-box"><span class="spec-lbl">כיסוי</span><span class="spec-val">${p.tech?.coverage || '-'}</span></div>
                            <div class="spec-box"><span class="spec-lbl">ייבוש</span><span class="spec-val">${p.tech?.drying || '-'}</span></div>
                            <div class="spec-box"><span class="spec-lbl">עובי</span><span class="spec-val">${p.tech?.thickness || '-'}</span></div>
                        </div>

                        <p class="text-sm text-slate-500 leading-relaxed">${p.marketingDesc || 'תיאור מוצר חסר.'}</p>
                        
                        ${p.video ? `<div class="mt-4"><a href="${p.video}" target="_blank" class="text-blue-600 font-bold text-sm flex items-center gap-1"><i data-lucide="youtube"></i> צפה בסרטון יישום</a></div>` : ''}
                    </div>
                </div>
            `;
            
            panel.innerHTML = html;
            panel.classList.add('open');
            document.getElementById('mainArea').classList.add('sidebar-open');
            lucide.createIcons();
        }

        // --- Visual Effects ---
        function setRobotState(state) {
            const r = document.getElementById('robot-container');
            if(state === 'thinking') r.classList.add('state-thinking');
            else r.classList.remove('state-thinking');
        }

        function typeWriter(text, elId, cb) {
            const el = document.getElementById(elId);
            el.innerHTML = "";
            let i = 0;
            // Clean specific tags for display
            let cleanText = text.replace(/{{typing}}/g, "").replace(/{{.*?}}/g, "");
            
            function type() {
                if (i < cleanText.length) {
                    el.innerHTML += cleanText.charAt(i);
                    i++;
                    setTimeout(type, 20);
                } else {
                    if (cb) cb();
                }
            }
            type();
        }

    </script>
</body>
</html>
