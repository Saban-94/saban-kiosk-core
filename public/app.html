<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sika Kiosk Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111111">
    <meta name="mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Heebo', sans-serif; background: #f1f5f9; overflow: hidden; user-select: none; }
        
        /* Sidebar Navigation */
        .sidebar-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; color: #64748b; transition: all 0.2s; border-radius: 16px; margin-bottom: 10px; }
        .sidebar-btn:hover { background: #e2e8f0; color: #0f172a; }
        .sidebar-btn.active { background: #E3000F; color: white; box-shadow: 0 10px 20px rgba(227, 0, 15, 0.3); }
        
        /* Product Card */
        .product-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #e2e8f0; cursor: pointer; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); border-color: #cbd5e1; }
        
        /* Modal Animation */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal-content { background: white; width: 90%; max-width: 1200px; height: 85%; border-radius: 30px; overflow: hidden; transform: scale(0.95); transition: transform 0.3s; display: flex; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .modal-overlay.open .modal-content { transform: scale(1); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* Animations */
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex h-screen w-screen">

    <nav class="w-28 bg-white h-full flex flex-col items-center py-8 border-l border-gray-200 shadow-xl z-20">
        <div class="mb-10 font-black text-2xl italic tracking-tighter text-[#E3000F]">SIKA</div>
        
        <button onclick="switchTab('catalog')" id="btn-catalog" class="sidebar-btn active">
            <i data-lucide="grid" size="32" class="mb-2"></i>
            <span class="text-xs font-bold">×§×˜×œ×•×’</span>
        </button>
        
        <button onclick="switchTab('calculator')" id="btn-calculator" class="sidebar-btn">
            <i data-lucide="calculator" size="32" class="mb-2"></i>
            <span class="text-xs font-bold">××—×©×‘×•×Ÿ</span>
        </button>
        
        <div class="mt-auto">
            <button onclick="location.reload()" class="sidebar-btn">
                <i data-lucide="refresh-cw" size="24"></i>
            </button>
        </div>
    </nav>

    <main class="flex-1 flex flex-col relative h-full overflow-hidden">
        
        <header class="bg-white/80 backdrop-blur-md p-6 flex justify-between items-center sticky top-0 z-10 border-b border-gray-200">
            <div>
                <h1 class="text-3xl font-black text-gray-800">×§×˜×œ×•×’ ××•×¦×¨×™×</h1>
                <p class="text-gray-500 text-sm">×¤×ª×¨×•× ×•×ª ××™×˜×•×, ×”×“×‘×§×” ×•×©×™×§×•×</p>
            </div>
            
            <div class="relative w-[500px]">
                <input id="searchInput" oninput="filterProducts()" type="text" placeholder="×—×™×¤×•×© ×—×›× (×œ××©×œ: ××™×˜×•× ×’×’×•×ª, ×“×‘×§ ×§×¨××™×§×”)..." class="w-full bg-gray-100 text-gray-800 p-4 pr-12 rounded-2xl focus:outline-none focus:ring-2 focus:ring-[#E3000F] text-lg transition shadow-inner">
                <i data-lucide="search" class="absolute right-4 top-4 text-gray-400" size="24"></i>
            </div>
        </header>

        <div id="contentArea" class="flex-1 overflow-y-auto p-8 relative">
            <div id="productGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 pb-20">
                <div class="col-span-full text-center text-gray-400 mt-20 text-xl">×˜×•×¢×Ÿ ××¢×¨×›×ª...</div>
            </div>
        </div>
    </main>

    <div id="productModal" class="modal-overlay">
        <div class="modal-content relative">
            <button onclick="closeModal()" class="absolute top-6 left-6 z-20 bg-gray-100 p-3 rounded-full hover:bg-gray-200 transition"><i data-lucide="x" size="24"></i></button>
            
            <div class="w-[45%] bg-gray-50 p-10 flex flex-col items-center justify-center relative border-l border-gray-100">
                <div id="modalRibbon" class="hidden absolute top-8 right-0 bg-[#E3000F] text-white px-6 py-2 font-bold shadow-lg rounded-l-xl z-10"></div>
                
                <img id="mImage" src="" class="max-h-[60%] max-w-full object-contain mix-blend-multiply mb-8 transition-transform hover:scale-105 duration-500">
                
                <div class="flex gap-4 w-full px-10">
                    <a id="mVideoBtn" href="#" target="_blank" class="hidden flex-1 flex items-center justify-center gap-2 bg-white text-red-600 font-bold py-4 rounded-xl border-2 border-red-100 hover:bg-red-50 transition shadow-sm">
                        <i data-lucide="play-circle" size="24"></i> ×¡×¨×˜×•×Ÿ ×™×™×©×•×
                    </a>
                    <a id="mPdfBtn" href="#" target="_blank" class="hidden flex-1 flex items-center justify-center gap-2 bg-white text-blue-600 font-bold py-4 rounded-xl border-2 border-blue-100 hover:bg-blue-50 transition shadow-sm">
                        <i data-lucide="file-text" size="24"></i> ××¤×¨×˜ ×˜×›× ×™
                    </a>
                </div>
            </div>

            <div class="w-[55%] p-12 flex flex-col overflow-y-auto bg-white">
                <div class="flex items-center gap-3 mb-2">
                    <img id="mBrandLogo" src="" class="h-8 object-contain hidden">
                    <span id="mBrandText" class="text-sm font-bold text-gray-400 uppercase tracking-widest border-b-2 border-[#E3000F] pb-1">SIKA</span>
                </div>
                
                <h2 id="mName" class="text-5xl font-black text-gray-900 mb-6 leading-tight">×©× ××•×¦×¨</h2>
                
                <p id="mDesc" class="text-xl text-gray-600 leading-relaxed mb-8 font-light"></p>

                <div class="grid grid-cols-3 gap-4 mb-8">
                    <div class="bg-gray-50 p-4 rounded-2xl text-center border border-gray-100 hover:border-gray-300 transition">
                        <i data-lucide="maximize" class="text-[#E3000F] mx-auto mb-2" size="28"></i>
                        <div class="text-xs text-gray-500 font-bold uppercase mb-1">×›×™×¡×•×™</div>
                        <div id="mCov" class="font-bold text-lg text-gray-900">-</div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-2xl text-center border border-gray-100 hover:border-gray-300 transition">
                        <i data-lucide="clock" class="text-[#E3000F] mx-auto mb-2" size="28"></i>
                        <div class="text-xs text-gray-500 font-bold uppercase mb-1">×–××Ÿ ×™×™×‘×•×©</div>
                        <div id="mDry" class="font-bold text-lg text-gray-900">-</div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-2xl text-center border border-gray-100 hover:border-gray-300 transition">
                        <i data-lucide="layers" class="text-[#E3000F] mx-auto mb-2" size="28"></i>
                        <div class="text-xs text-gray-500 font-bold uppercase mb-1">×¢×•×‘×™ ×©×›×‘×”</div>
                        <div id="mThick" class="font-bold text-lg text-gray-900">-</div>
                    </div>
                </div>

                <div class="mt-auto pt-6 border-t border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2"><i data-lucide="help-circle" size="20"></i> ×™×© ×œ×š ×©××œ×” ×˜×›× ×™×ª?</h3>
                    <button onclick="openExpertChat()" class="w-full bg-black text-white text-xl font-bold py-5 rounded-2xl shadow-xl hover:bg-gray-800 transition transform hover:-translate-y-1 flex items-center justify-center gap-3">
                        <i data-lucide="message-square" size="24"></i> ×©××œ ××ª ×”××•××—×” ×”×•×•×™×¨×˜×•××œ×™
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="expertChatModal" class="fixed inset-0 z-[60] bg-black/60 hidden flex items-center justify-center backdrop-blur-md opacity-0 transition-opacity duration-300">
        <div onclick="closeExpertChat()" class="absolute inset-0"></div>
        <div class="bg-white w-[800px] h-[700px] rounded-3xl shadow-2xl flex flex-col overflow-hidden relative z-10 transform scale-95 transition-transform duration-300" id="chatWindow">
            
            <div class="bg-[#111] text-white p-6 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="bg-green-500 p-3 rounded-full shadow-lg shadow-green-500/20 relative">
                        <i data-lucide="bot" class="text-white" size="28"></i>
                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-300 border-2 border-green-600 rounded-full animate-pulse"></div>
                    </div>
                    <div>
                        <div class="font-black text-xl">Sika Expert AI</div>
                        <div class="text-sm text-gray-400">×× ×ª×— ××ª ×”××¤×¨×˜ ×”×˜×›× ×™ ×¢×‘×•×¨×š...</div>
                    </div>
                </div>
                <button onclick="closeExpertChat()" class="bg-white/10 p-2 rounded-full hover:bg-white/20 transition"><i data-lucide="x" size="24"></i></button>
            </div>

            <div id="chatMessages" class="flex-1 overflow-y-auto p-8 space-y-6 bg-gray-50">
                </div>

            <div class="p-6 bg-white border-t border-gray-100">
                <div class="flex gap-3 mb-4">
                    <button onclick="sendQuestion('×›××” ×–××Ÿ ×¦×¨×™×š ×œ×—×›×•×ª ×œ×™×™×‘×•×©?')" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm font-bold transition">â³ ×–×× ×™ ×™×™×‘×•×©</button>
                    <button onclick="sendQuestion('××” ×”×›×™×¡×•×™ ×œ××˜×¨ ×¨×‘×•×¢?')" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm font-bold transition">ğŸ“ ×—×™×©×•×‘ ×›××•×™×•×ª</button>
                    <button onclick="sendQuestion('×”×× × ×“×¨×© ×¤×¨×™×™××¨?')" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm font-bold transition">ğŸ› ï¸ ×”×•×¨××•×ª ×™×™×©×•×</button>
                </div>
                <div class="relative flex items-center gap-3">
                    <input id="userChatInput" type="text" placeholder="×©××œ ×©××œ×” ×—×•×¤×©×™×ª..." class="flex-1 bg-gray-100 text-gray-800 p-5 pr-14 rounded-2xl focus:outline-none focus:ring-2 focus:ring-green-500 text-lg shadow-inner" onkeypress="handleEnter(event)">
                    
                    <button onclick="startVoiceRecognition()" id="micBtn" class="bg-gray-200 text-gray-600 p-5 rounded-2xl hover:bg-gray-300 transition">
                        <i data-lucide="mic" size="24"></i>
                    </button>
                    
                    <button onclick="sendUserMessage()" class="bg-black text-white p-5 rounded-2xl hover:bg-gray-800 transition shadow-lg transform active:scale-95">
                        <i data-lucide="send" size="24"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { askProductExpert } from './js/gemini-service.js';

        lucide.createIcons();
        let allProducts = [];
        let currentProduct = null;
        let chatHistory = [];

        // --- Init ---
        async function init() {
            try {
                const snap = await getDocs(collection(db, "products"));
                allProducts = [];
                snap.forEach(doc => allProducts.push({id: doc.id, ...doc.data()}));
                renderGrid(allProducts);
            } catch (e) {
                console.error("Init Error:", e);
                document.getElementById('productGrid').innerHTML = '<div class="col-span-full text-center text-red-500 text-2xl font-bold">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×</div>';
            }
        }

        function renderGrid(list) {
            const grid = document.getElementById('productGrid');
            if(list.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-400 text-2xl mt-20">×œ× × ××¦××• ××•×¦×¨×™× ×ª×•×××™×</div>';
                return;
            }

            grid.innerHTML = list.map(p => `
                <div onclick="openProduct('${p.id}')" class="product-card flex flex-col group h-[340px]">
                    <div class="h-[180px] p-6 bg-gray-50 flex items-center justify-center relative overflow-hidden group-hover:bg-gray-100 transition duration-500">
                        ${p.status && p.status !== 'standard' ? 
                            `<div class="absolute top-4 left-0 bg-[#E3000F] text-white text-xs font-bold px-3 py-1 shadow-md rounded-r-md z-10">${p.status === 'recommended' ? '××•××œ×¥' : '××‘×¦×¢'}</div>` : ''}
                        <img src="${p.image || 'https://placehold.co/300'}" class="max-h-full max-w-full object-contain mix-blend-multiply transform group-hover:scale-110 transition duration-500" onerror="this.src='https://placehold.co/300?text=No+Image'">
                    </div>
                    <div class="p-5 flex-1 flex flex-col bg-white relative">
                        <div class="text-xs font-bold text-gray-400 uppercase mb-1 tracking-wider">${p.brand || 'SIKA'}</div>
                        <h3 class="text-xl font-bold text-gray-800 leading-tight mb-2 line-clamp-2 group-hover:text-[#E3000F] transition">${p.name}</h3>
                        <div class="mt-auto pt-3 border-t border-gray-50 flex justify-between items-center">
                            <span class="text-sm font-bold text-gray-400">×¤×¨×˜×™× × ×•×¡×¤×™×</span>
                            <div class="bg-gray-100 p-2 rounded-full group-hover:bg-[#E3000F] group-hover:text-white transition">
                                <i data-lucide="arrow-left" size="16"></i>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.filterProducts = () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allProducts.filter(p => 
                (p.name && p.name.toLowerCase().includes(term)) || 
                (p.brand && p.brand.toLowerCase().includes(term))
            );
            renderGrid(filtered);
        }

        // --- Modal Logic ---
        window.openProduct = (id) => {
            currentProduct = allProducts.find(x => x.id === id);
            if(!currentProduct) return;

            // Safe Setters
            const setText = (id, txt) => { const el = document.getElementById(id); if(el) el.innerText = txt; }
            
            setText('mName', currentProduct.name);
            setText('mBrandText', currentProduct.brand || "SIKA");
            setText('mDesc', currentProduct.marketingDesc || "××™×Ÿ ×ª×™××•×¨ ×–××™×Ÿ.");
            setText('mCov', currentProduct.tech?.coverage || currentProduct.coverage || "-");
            setText('mDry', currentProduct.tech?.drying || currentProduct.drying || "-");
            setText('mThick', currentProduct.tech?.thickness || currentProduct.thickness || "-");

            // Image & Logo
            document.getElementById('mImage').src = currentProduct.image || 'https://placehold.co/600x400';
            const logoEl = document.getElementById('mBrandLogo');
            if(currentProduct.brandLogo) { logoEl.src = currentProduct.brandLogo; logoEl.classList.remove('hidden'); }
            else { logoEl.classList.add('hidden'); }

            // Ribbon
            const ribbon = document.getElementById('modalRibbon');
            if(currentProduct.status && currentProduct.status !== 'standard') {
                ribbon.innerText = currentProduct.status === 'recommended' ? 'â­ ××•×¦×¨ ××•××œ×¥' : 'ğŸ”¥ ×‘××‘×¦×¢';
                ribbon.classList.remove('hidden');
            } else {
                ribbon.classList.add('hidden');
            }

            // Buttons
            const toggle = (id, link) => {
                const el = document.getElementById(id);
                if(link && link.length > 5) { el.href = link; el.classList.remove('hidden'); }
                else el.classList.add('hidden');
            }
            toggle('mVideoBtn', currentProduct.video);
            toggle('mPdfBtn', currentProduct.pdfUrl);

            document.getElementById('productModal').classList.add('open');
            lucide.createIcons();
        }

        window.closeModal = () => document.getElementById('productModal').classList.remove('open');

        // --- Expert Chat ---
        window.openExpertChat = () => {
            if(!currentProduct) return;
            chatHistory = [];
            const modal = document.getElementById('expertChatModal');
            const win = document.getElementById('chatWindow');
            
            // ×”×•×“×¢×ª ×¤×ª×™×—×”
            document.getElementById('chatMessages').innerHTML = `
                <div class="flex gap-4 animate-fade-in">
                    <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0 border border-green-200">
                        <i data-lucide="bot" class="text-green-600" size="20"></i>
                    </div>
                    <div class="bg-white p-5 rounded-2xl rounded-tr-none shadow-sm border border-gray-100 text-lg max-w-[80%]">
                        ×”×™×™! ×× ×™ ×”××•××—×” ×”×˜×›× ×™ ×¢×‘×•×¨ <b>${currentProduct.name}</b>.
                        <br>×× ×™ ×›××Ÿ ×›×“×™ ×œ×¢× ×•×ª ×¢×œ ×©××œ×•×ª ×‘× ×•×’×¢ ×œ×™×™×©×•×, ×›××•×™×•×ª ×•×–×× ×™ ×™×™×‘×•×©.
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            // ×× ×™××¦×™×™×ª ×›× ×™×¡×”
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                win.classList.remove('scale-95');
                win.classList.add('scale-100');
            }, 10);
            lucide.createIcons();
        }

        window.closeExpertChat = () => {
            const modal = document.getElementById('expertChatModal');
            const win = document.getElementById('chatWindow');
            modal.classList.add('opacity-0');
            win.classList.remove('scale-100');
            win.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        window.handleEnter = (e) => { if(e.key === 'Enter') window.sendUserMessage(); }
        window.sendQuestion = (text) => { document.getElementById('userChatInput').value = text; window.sendUserMessage(); }

        window.sendUserMessage = async () => {
            const input = document.getElementById('userChatInput');
            const text = input.value.trim();
            if(!text) return;

            addMessageUI('user', text);
            input.value = "";
            input.focus();

            const loadingId = addLoadingUI();
            const response = await askProductExpert(currentProduct, text, chatHistory);
            removeUI(loadingId);
            
            addMessageUI('bot', response);
            chatHistory.push({ role: "user", parts: [{ text: text }] });
            chatHistory.push({ role: "model", parts: [{ text: response }] });
        }

        function addMessageUI(role, text) {
            const container = document.getElementById('chatMessages');
            const isUser = role === 'user';
            const div = document.createElement('div');
            div.className = `flex gap-4 ${isUser ? 'flex-row-reverse' : ''} animate-fade-in`;
            div.innerHTML = `
                <div class="w-10 h-10 rounded-full ${isUser ? 'bg-gray-200' : 'bg-green-100 border border-green-200'} flex items-center justify-center flex-shrink-0">
                    <i data-lucide="${isUser ? 'user' : 'bot'}" class="${isUser ? 'text-gray-600' : 'text-green-600'}" size="20"></i>
                </div>
                <div class="${isUser ? 'bg-black text-white' : 'bg-white text-gray-800 border border-gray-100'} p-5 rounded-2xl ${isUser ? 'rounded-tl-none' : 'rounded-tr-none'} shadow-sm text-lg max-w-[80%] leading-relaxed">
                    ${text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>')}
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            lucide.createIcons();
        }

        function addLoadingUI() {
            const container = document.getElementById('chatMessages');
            const id = 'load-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex gap-4";
            div.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-green-100 border border-green-200 flex items-center justify-center flex-shrink-0"><i data-lucide="bot" class="text-green-600" size="20"></i></div>
                <div class="bg-white p-5 rounded-2xl rounded-tr-none shadow-sm border border-gray-100 flex gap-2 items-center">
                    <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
                    <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-75"></span>
                    <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-150"></span>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        function removeUI(id) { const el = document.getElementById(id); if(el) el.remove(); }

        window.startVoiceRecognition = () => {
            if (!('webkitSpeechRecognition' in window)) return alert("×–×™×”×•×™ ×§×•×œ×™ × ×ª××š ×¨×§ ×‘-Chrome");
            const rec = new webkitSpeechRecognition();
            rec.lang = 'he-IL';
            const btn = document.getElementById('micBtn');
            btn.classList.add('bg-red-100', 'text-red-600', 'animate-pulse');
            rec.onresult = (e) => {
                document.getElementById('userChatInput').value = e.results[0][0].transcript;
                window.sendUserMessage();
            };
            rec.onend = () => btn.classList.remove('bg-red-100', 'text-red-600', 'animate-pulse');
            rec.start();
        }

        window.switchTab = (tab) => {
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+tab).classList.add('active');
            if(tab === 'calculator') alert('×”××—×©×‘×•×Ÿ ×‘×‘× ×™×™×”...'); // Placeholder
        }

        init();
    </script>
</body>
</html>
