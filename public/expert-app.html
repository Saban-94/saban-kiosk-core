<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saban Expert HQ</title>
    
    <link rel="manifest" href="manifest.json"> <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background: #111; color: white; padding-bottom: 20px; }
        
        .lead-card { background: #1e1e1e; border: 1px solid #333; border-radius: 16px; padding: 20px; margin-bottom: 16px; position: relative; overflow: hidden; transition: all 0.3s; }
        .lead-card.new { border-color: #E3000F; box-shadow: 0 0 20px rgba(227, 0, 15, 0.2); }
        .lead-card.new::before { content: ''; position: absolute; top: 0; right: 0; width: 4px; height: 100%; background: #E3000F; }
        
        .action-btn { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; }
        .action-btn:active { transform: scale(0.9); }
        
        .whatsapp-btn { background: #25D366; color: white; }
        .phone-btn { background: #3b82f6; color: white; }
        .archive-btn { background: #333; color: #666; }
    </style>
</head>
<body>

    <div class="p-6 bg-[#111] sticky top-0 z-20 border-b border-gray-800 flex justify-between items-center shadow-lg">
        <div>
            <div class="text-[#FFC500] font-black text-2xl italic tracking-wider">Saban PRO</div>
            <div class="text-xs text-gray-400">מערכת ניהול לידים</div>
        </div>
        <div class="relative">
            <div id="pingIndicator" class="w-3 h-3 bg-red-500 rounded-full absolute top-0 right-0 hidden"></div>
            <i data-lucide="bell" class="text-white"></i>
        </div>
    </div>

    <div class="grid grid-cols-2 gap-4 p-4">
        <div class="bg-gray-900 p-4 rounded-2xl border border-gray-800 text-center">
            <div class="text-3xl font-bold text-white" id="countNew">0</div>
            <div class="text-xs text-gray-500 font-bold uppercase">ממתינים לטיפול</div>
        </div>
        <div class="bg-gray-900 p-4 rounded-2xl border border-gray-800 text-center">
            <div class="text-3xl font-bold text-green-500" id="countTotal">0</div>
            <div class="text-xs text-gray-500 font-bold uppercase">טופלו היום</div>
        </div>
    </div>

    <div class="p-4">
        <h3 class="text-gray-500 text-xs font-bold uppercase mb-4 tracking-widest">פניות אחרונות (Real-Time)</h3>
        <div id="leadsFeed" class="space-y-4">
            <div class="text-center text-gray-600 mt-10">טוען פניות...</div>
        </div>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, query, orderBy, onSnapshot, updateDoc, doc, limit } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        lucide.createIcons();

        // האזנה ללידים בזמן אמת
        const q = query(collection(db, "leads"), orderBy("timestamp", "desc"), limit(20));
        
        onSnapshot(q, (snapshot) => {
            const container = document.getElementById('leadsFeed');
            container.innerHTML = "";
            
            let newCount = 0;
            let totalCount = 0;

            if (snapshot.empty) {
                container.innerHTML = '<div class="text-center text-gray-700 mt-10">אין פניות חדשות</div>';
                return;
            }

            snapshot.forEach((docSnap) => {
                const lead = docSnap.data();
                const id = docSnap.id;
                const isNew = lead.status === 'new';
                if(isNew) newCount++;
                totalCount++;

                const timeStr = lead.timestamp ? new Date(lead.timestamp.seconds * 1000).toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'}) : '--:--';
                
                // יצירת לינק לוואטסאפ
                // הסרת ה-0 הראשון והוספת 972
                const cleanPhone = lead.phone.replace(/^0+/, ''); 
                const waLink = `https://wa.me/972${cleanPhone}?text=${encodeURIComponent(`היי ${lead.name}, קיבלתי את הפנייה שלך בקיוסק (${lead.query}). איך אני יכול לעזור?`)}`;

                container.innerHTML += `
                    <div class="lead-card ${isNew ? 'new' : 'opacity-70'}">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full bg-gray-800 flex items-center justify-center font-bold text-[#FFC500] border border-gray-700 text-xl">
                                    ${lead.name.charAt(0)}
                                </div>
                                <div>
                                    <div class="font-bold text-lg leading-none">${lead.name}</div>
                                    <div class="text-xs text-gray-400 mt-1 flex items-center gap-1">
                                        <i data-lucide="clock" size="10"></i> ${timeStr} • ${lead.source === 'kiosk_app' ? 'קיוסק' : 'אחר'}
                                    </div>
                                </div>
                            </div>
                            ${isNew ? '<span class="bg-[#E3000F] text-white text-[10px] font-bold px-2 py-1 rounded animate-pulse">חדש!</span>' : '<i data-lucide="check-circle" class="text-green-500" size="16"></i>'}
                        </div>
                        
                        <div class="bg-black/40 p-3 rounded-lg text-sm text-gray-300 mb-4 border border-gray-700">
                            ${lead.query || "פנייה כללית"}
                        </div>

                        <div class="flex gap-4 justify-end items-center border-t border-gray-800 pt-3">
                            <button onclick="archiveLead('${id}')" class="text-xs text-gray-500 underline mr-auto">סמן כטופל</button>
                            
                            <a href="tel:${lead.phone}" class="action-btn phone-btn shadow-lg" onclick="markRead('${id}')">
                                <i data-lucide="phone" size="20"></i>
                            </a>
                            <a href="${waLink}" target="_blank" class="action-btn whatsapp-btn shadow-lg" onclick="markRead('${id}')">
                                <i data-lucide="message-circle" size="20"></i>
                            </a>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('countNew').innerText = newCount;
            document.getElementById('countTotal').innerText = totalCount;
            
            // חיווי ויזואלי אם יש חדש
            const ping = document.getElementById('pingIndicator');
            if(newCount > 0) {
                ping.classList.remove('hidden');
                ping.classList.add('animate-ping');
            } else {
                ping.classList.add('hidden');
            }

            lucide.createIcons();
        });

        // עדכון סטטוס ל"נקרא" (כשלוחצים על כפתור)
        window.markRead = async (id) => {
            // לא מעביר לארכיון, רק מסיר את הסימון "חדש"
            // הלוגיקה שלך יכולה להשתנות כאן
        }

        // העברה לארכיון (טופל)
        window.archiveLead = async (id) => {
            if(confirm("לסמן כטופל?")) {
                await updateDoc(doc(db, "leads", id), { status: "handled" });
            }
        }
    </script>
</body>
</html>
