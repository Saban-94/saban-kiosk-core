<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sika Studio CRM - Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #0f172a; color: #cbd5e1; height: 100vh; display: flex; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: #1e293b; border-left: 1px solid #334155; display: flex; flex-direction: column; z-index: 50; }
        .nav-item { padding: 16px 24px; cursor: pointer; color: #94a3b8; font-weight: 600; display: flex; items-center; gap: 12px; transition: 0.2s; border-right: 4px solid transparent; }
        .nav-item:hover { background: #334155; color: white; }
        .nav-item.active { background: #334155; color: #E3000F; border-right-color: #E3000F; }

        /* Main Area */
        .main-area { flex: 1; background: #f8fafc; color: #1e293b; display: flex; flex-direction: column; overflow: hidden; border-radius: 40px 0 0 40px; margin-right: -20px; z-index: 10; padding: 30px; position: relative; }
        .view-section { display: none; height: 100%; flex-direction: column; overflow-y: auto; padding-right: 10px; }
        .view-section.active { display: flex; }

        /* Inputs */
        .input-std { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; background: white; margin-bottom: 8px; outline: none; transition: 0.2s; }
        .input-std:focus { border-color: #E3000F; box-shadow: 0 0 0 3px rgba(227, 0, 15, 0.1); }
        .label-std { font-size: 11px; font-weight: 800; color: #64748b; margin-bottom: 4px; display: block; text-transform: uppercase; }

        /* Buttons */
        .btn { padding: 10px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; display: inline-flex; items-center; gap: 6px; }
        .btn-primary { background: #E3000F; color: white; box-shadow: 0 4px 15px rgba(227, 0, 15, 0.3); }
        .btn-primary:hover { transform: translateY(-1px); }
        .btn-sec { background: white; border: 1px solid #cbd5e1; color: #475569; }

        /* Sim Pane */
        .sim-pane { width: 420px; background: #0f172a; border-right: 1px solid #334155; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .device-frame { background: white; width: 360px; height: 720px; border-radius: 40px; border: 12px solid #1e293b; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        .sim-content { flex: 1; overflow-y: auto; background: #f1f5f9; padding: 20px; padding-top: 50px; }
        
        /* Sim Components */
        .sim-card { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .sim-img-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 2px; height: 180px; }
        .sim-img-main { grid-row: span 2; background: #f8fafc; display: flex; align-items: center; justify-content: center; }
        .sim-img-sub { background: #f1f5f9; display: flex; align-items: center; justify-content: center; }
        .sim-img-grid img { max-width: 100%; max-height: 100%; object-fit: contain; mix-blend-multiply; }
        
        .sim-specs { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; padding: 10px; background: #f8fafc; border-top: 1px solid #e2e8f0; }
        .sim-spec-box { text-align: center; font-size: 10px; color: #64748b; }
        .sim-spec-val { font-weight: 900; color: #1e293b; font-size: 12px; display: block; }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="p-8 border-b border-slate-700 flex items-center gap-4">
            <div class="w-12 h-12 bg-[#E3000F] rounded-2xl flex items-center justify-center text-white font-black text-2xl shadow-lg">S</div>
            <div><h1 class="text-xl font-black text-white">SIKA CRM</h1><p class="text-[10px] text-gray-400 font-bold">MASTER ADMIN</p></div>
        </div>
        <nav class="flex-1 py-6 space-y-1">
            <div class="nav-item active" onclick="safeApp.view('products')"><i data-lucide="package"></i> ניהול מוצרים</div>
            <div class="nav-item" onclick="safeApp.view('tutorials')"><i data-lucide="youtube"></i> הדרכות</div>
            <div class="nav-item" onclick="safeApp.view('brain')"><i data-lucide="brain-circuit"></i> המוח (AI)</div>
            <div class="nav-item" onclick="safeApp.view('brands')"><i data-lucide="award"></i> מותגים</div>
        </nav>
    </div>

    <div class="main-area">
        
        <div id="view-products" class="view-section active">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-black text-slate-800">עורך המוצרים</h2>
                <div class="flex gap-2">
                    <button onclick="safeApp.resetForm('prod')" class="btn btn-sec"><i data-lucide="plus"></i> חדש</button>
                    <button onclick="safeApp.saveProd()" class="btn btn-primary"><i data-lucide="save"></i> שמור</button>
                </div>
            </header>

            <div class="flex gap-8 h-full overflow-hidden">
                <div class="w-72 bg-white rounded-2xl border flex flex-col overflow-hidden">
                    <div class="p-3 border-b"><input onkeyup="safeApp.filterList('prodList', this.value)" class="input-std mb-0" placeholder="חיפוש..."></div>
                    <div id="prodList" class="flex-1 overflow-y-auto p-2"></div>
                </div>

                <div class="flex-1 bg-white rounded-2xl border p-8 overflow-y-auto shadow-sm">
                    <input type="hidden" id="pId">
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><span class="label-std">שם המוצר</span><input id="pName" class="input-std" oninput="safeApp.renderPreview()"></div>
                        <div><span class="label-std">מותג</span><select id="pBrand" class="input-std" onchange="safeApp.renderPreview()"></select></div>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-4">
                        <h4 class="font-bold text-xs text-blue-800 mb-2 flex items-center gap-2"><i data-lucide="ruler"></i> נתונים טכניים (לקטלוג)</h4>
                        <div class="grid grid-cols-3 gap-4">
                            <div><span class="label-std">כיסוי (ק"ג למ"ר)</span><input id="pCov" class="input-std text-center" placeholder="לדוגמה: 1.5"></div>
                            <div><span class="label-std">זמן ייבוש</span><input id="pDry" class="input-std text-center" placeholder="לדוגמה: 24 שעות"></div>
                            <div><span class="label-std">עובי יישום</span><input id="pThick" class="input-std text-center" placeholder='לדוגמה: 2-5 מ"מ'></div>
                        </div>
                        <div class="mt-2">
                            <span class="label-std">תכונות מוצר (מופרד בפסיק)</span>
                            <input id="pFeat" class="input-std" placeholder="גמיש, עמיד במים, חזק במיוחד..." oninput="safeApp.renderPreview()">
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-xl border mb-4">
                        <h4 class="font-bold text-xs text-gray-500 mb-2 flex items-center gap-2"><i data-lucide="image"></i> מדיה (עד 3 תמונות)</h4>
                        <div class="grid grid-cols-3 gap-2">
                            <input id="pImg1" class="input-std" placeholder="תמונה ראשית URL" oninput="safeApp.renderPreview()">
                            <input id="pImg2" class="input-std" placeholder="תמונה 2 URL" oninput="safeApp.renderPreview()">
                            <input id="pImg3" class="input-std" placeholder="תמונה 3 URL" oninput="safeApp.renderPreview()">
                        </div>
                    </div>

                    <div class="mb-4">
                        <span class="label-std">סרטון הדרכה מקושר</span>
                        <select id="pVideoLink" class="input-std">
                            <option value="">-- בחר סרטון מהמאגר --</option>
                        </select>
                        <div class="text-xs text-gray-400 mt-1">* הסרטון יישלף אוטומטית מדף ההדרכות</div>
                    </div>

                    <div class="mb-4"><span class="label-std">תיאור שיווקי</span><textarea id="pDesc" class="input-std h-24" oninput="safeApp.renderPreview()"></textarea></div>
                    
                    <button onclick="safeApp.delItem('products', document.getElementById('pId').value)" class="text-red-500 text-xs font-bold hover:underline">מחיקת מוצר</button>
                </div>
            </div>
        </div>

        <div id="view-tutorials" class="view-section">
            <h2 class="text-3xl font-black text-slate-800 mb-6">מרכז ההדרכות</h2>
            <div class="bg-white p-6 rounded-2xl border mb-6 flex gap-4 items-end">
                <div class="flex-1"><span class="label-std">כותרת הסרטון</span><input id="vTitle" class="input-std mb-0"></div>
                <div class="flex-1"><span class="label-std">קטגוריה</span><select id="vCat" class="input-std mb-0"><option>איטום</option><option>ריצוף</option><option>שיקום בטון</option></select></div>
                <div class="flex-1"><span class="label-std">לינק YouTube</span><input id="vUrl" class="input-std mb-0"></div>
                <button onclick="safeApp.saveVid()" class="btn btn-primary">הוסף</button>
            </div>
            <div id="vidGrid" class="grid grid-cols-4 gap-4"></div>
        </div>

        <div id="view-brain" class="view-section"><h2 class="text-2xl text-gray-400">ניהול AI (ראה קובץ קודם)</h2></div>
        <div id="view-brands" class="view-section"><h2 class="text-2xl text-gray-400">ניהול מותגים (ראה קובץ קודם)</h2></div>

    </div>

    <div class="sim-pane">
        <div class="text-center mb-4"><h3 class="font-bold text-white">Live Preview</h3></div>
        <div class="device-frame">
            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-6 bg-slate-800 rounded-b-xl z-20"></div>
            <div class="sim-content" id="simContent">
                
                <div id="sim-product-card" class="sim-card">
                    <div class="sim-img-grid">
                        <div class="sim-img-main"><img id="sp-img1" src="https://placehold.co/200"></div>
                        <div class="flex flex-col gap-1">
                            <div class="sim-img-sub h-full"><img id="sp-img2" src=""></div>
                            <div class="sim-img-sub h-full"><img id="sp-img3" src=""></div>
                        </div>
                    </div>
                    <div class="p-4">
                        <div id="sp-brand" class="text-[10px] font-bold text-gray-400 uppercase">SIKA</div>
                        <h3 id="sp-name" class="text-lg font-black text-slate-800 leading-tight">שם המוצר</h3>
                        <p id="sp-desc" class="text-xs text-gray-500 mt-2 line-clamp-3">תיאור...</p>
                        
                        <div id="sp-features" class="flex flex-wrap gap-1 mt-3"></div>
                    </div>
                    <div class="sim-specs">
                        <div class="sim-spec-box">כיסוי<span id="sp-cov" class="sim-spec-val">-</span></div>
                        <div class="sim-spec-box">ייבוש<span id="sp-dry" class="sim-spec-val">-</span></div>
                        <div class="sim-spec-box">עובי<span id="sp-thick" class="sim-spec-val">-</span></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        window.safeApp = { view:()=>{}, loadProd:()=>{}, saveProd:()=>{}, resetForm:()=>{}, saveVid:()=>{}, renderPreview:()=>{}, filterList:()=>{}, delItem:()=>{} };
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } 
        from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDZuI7AaDZVteUhUT_eIVCR5SIdU0jhqUg",
          authDomain: "saban-kiosk-core.firebaseapp.com",
          projectId: "saban-kiosk-core",
          storageBucket: "saban-kiosk-core.firebasestorage.app",
          messagingSenderId: "866976260818",
          appId: "1:866976260818:web:0e3ec12df72291c77f430b"
        };

        const appInstance = initializeApp(firebaseConfig);
        const db = getFirestore(appInstance);
        
        lucide.createIcons();

        const app = {
            data: { prods:[], vids:[] },
            
            init: () => {
                app.listeners();
                app.view('products');
            },

            view: (v) => {
                document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                document.getElementById('view-'+v).classList.add('active');
            },

            listeners: () => {
                // Products
                onSnapshot(collection(db, "products"), s => {
                    const l = document.getElementById('prodList'); l.innerHTML=""; app.data.prods=[];
                    s.forEach(d => {
                        const p = {id:d.id, ...d.data()}; app.data.prods.push(p);
                        l.innerHTML += `<div onclick="safeApp.loadProd('${p.id}')" class="p-3 border-b hover:bg-slate-50 cursor-pointer flex justify-between items-center group">
                            <span class="font-bold text-sm text-slate-700">${p.name}</span>
                            <i data-lucide="edit-2" class="w-4 h-4 text-slate-300"></i>
                        </div>`;
                    });
                    lucide.createIcons();
                });
                
                // Brands Select
                onSnapshot(collection(db, "brands"), s => {
                    const sel = document.getElementById('pBrand'); sel.innerHTML="";
                    s.forEach(d => sel.innerHTML += `<option value="${d.data().name}">${d.data().name}</option>`);
                });

                // Tutorials
                onSnapshot(collection(db, "tutorials"), s => {
                    const g = document.getElementById('vidGrid'); 
                    const linkSel = document.getElementById('pVideoLink');
                    g.innerHTML=""; linkSel.innerHTML='<option value="">-- בחר סרטון --</option>';
                    
                    s.forEach(d => {
                        const t = {id:d.id, ...d.data()};
                        g.innerHTML += `<div class="bg-white p-3 rounded-xl border text-xs shadow-sm">
                            <div class="font-bold text-slate-800 mb-1">${t.title}</div>
                            <div class="text-slate-400">${t.category || 'כללי'}</div>
                            <button onclick="safeApp.delItem('tutorials','${t.id}')" class="text-red-400 mt-2 hover:text-red-600">מחק</button>
                        </div>`;
                        
                        linkSel.innerHTML += `<option value="${t.url}">${t.title}</option>`;
                    });
                });
            },

            // --- Products ---
            loadProd: (id) => {
                const p = app.data.prods.find(x => x.id === id);
                document.getElementById('pId').value = p.id;
                document.getElementById('pName').value = p.name;
                document.getElementById('pBrand').value = p.brand;
                document.getElementById('pCov').value = p.tech?.coverage || '';
                document.getElementById('pDry').value = p.tech?.drying || '';
                document.getElementById('pThick').value = p.tech?.thickness || '';
                document.getElementById('pFeat').value = p.features?.join(', ') || '';
                document.getElementById('pImg1').value = p.images?.[0] || p.image || '';
                document.getElementById('pImg2').value = p.images?.[1] || '';
                document.getElementById('pImg3').value = p.images?.[2] || '';
                document.getElementById('pVideoLink').value = p.video || '';
                document.getElementById('pDesc').value = p.marketingDesc;
                app.renderPreview();
            },

            renderPreview: () => {
                const n = document.getElementById('pName').value;
                document.getElementById('sp-name').innerText = n || 'שם המוצר';
                document.getElementById('sp-brand').innerText = document.getElementById('pBrand').value || 'BRAND';
                document.getElementById('sp-desc').innerText = document.getElementById('pDesc').value || 'תיאור...';
                
                document.getElementById('sp-cov').innerText = document.getElementById('pCov').value || '-';
                document.getElementById('sp-dry').innerText = document.getElementById('pDry').value || '-';
                document.getElementById('sp-thick').innerText = document.getElementById('pThick').value || '-';

                // Images
                const i1 = document.getElementById('pImg1').value;
                const i2 = document.getElementById('pImg2').value;
                const i3 = document.getElementById('pImg3').value;
                document.getElementById('sp-img1').src = i1 || 'https://placehold.co/200';
                document.getElementById('sp-img2').src = i2;
                document.getElementById('sp-img3').src = i3;

                // Features
                const feats = document.getElementById('pFeat').value.split(',').filter(f=>f.trim());
                document.getElementById('sp-features').innerHTML = feats.map(f => `<span class="bg-slate-100 px-2 py-1 rounded text-[9px] font-bold text-slate-600 border border-slate-200">${f.trim()}</span>`).join('');
            },

            saveProd: async () => {
                const id = document.getElementById('pId').value;
                const data = {
                    name: document.getElementById('pName').value,
                    brand: document.getElementById('pBrand').value,
                    marketingDesc: document.getElementById('pDesc').value,
                    images: [
                        document.getElementById('pImg1').value,
                        document.getElementById('pImg2').value,
                        document.getElementById('pImg3').value
                    ].filter(Boolean),
                    image: document.getElementById('pImg1').value, // Legacy support
                    video: document.getElementById('pVideoLink').value,
                    tech: {
                        coverage: document.getElementById('pCov').value,
                        drying: document.getElementById('pDry').value,
                        thickness: document.getElementById('pThick').value
                    },
                    features: document.getElementById('pFeat').value.split(',').map(f=>f.trim()).filter(Boolean)
                };

                if(id) await updateDoc(doc(db, "products", id), data);
                else await addDoc(collection(db, "products"), data);
                
                alert("נשמר!");
                app.resetForm('prod');
            },

            saveVid: async () => {
                await addDoc(collection(db, "tutorials"), {
                    title: document.getElementById('vTitle').value,
                    url: document.getElementById('vUrl').value,
                    category: document.getElementById('vCat').value
                });
                alert("סרטון נוסף");
            },

            delItem: async (col, id) => {
                if(id && confirm("למחוק לצמיתות?")) {
                    await deleteDoc(doc(db, col, id));
                    app.resetForm('prod');
                }
            },

            resetForm: (t) => {
                if(t==='prod') {
                    document.getElementById('pId').value="";
                    document.querySelectorAll('#view-products input, #view-products textarea').forEach(i=>i.value="");
                    app.renderPreview();
                }
            },
            
            filterList: (listId, txt) => {
                Array.from(document.getElementById(listId).children).forEach(el => el.style.display = el.innerText.toLowerCase().includes(txt.toLowerCase()) ? 'flex' : 'none');
            }
        };

        window.safeApp = app;
        app.init();
    </script>
</body>
</html>
